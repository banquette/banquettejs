import { Injector } from "@banquette/dependency-injection";
import { Exception } from "@banquette/exception";
import { HttpMethod, ResponseTypeJson, PayloadTypeJson } from "@banquette/http";
import { isString, Constructor } from "@banquette/utils-type";
import { Min, NotEmpty } from "@banquette/validation";
import {
    ApiEndpoint,
    ApiEndpointParameterOptions,
    MissingRequiredParameterException,
    ApiEndpointParameterInterface,
    InvalidParameterException,
    ApiEndpointStorageService,
    EndpointNotFoundException
} from "../src";
import { Endpoint } from "../src/decorator/endpoint";

export const endpointParameterDefaults = {
    required: false,
    url: false,
    defaultValue: undefined,
    validator: null
};

export const endpointAutoGeneratedParameterDefaults = {
    required: true,
    url: true,
    defaultValue: undefined,
    validator: null
};

describe('Creation', () => {
    test('All default values', () => {
        const endpoint = new ApiEndpoint('/test');
        expect(endpoint).toMatchObject({
            url: '/test',
            method: HttpMethod.GET,
            params: {},
            headers: {},
            payloadType: PayloadTypeJson,
            responseType: ResponseTypeJson
        });
    });

    describe('Url normalization', () => {
        const tests: Record<string, string> = {
            '': '/',
            'test': '//test',
            '/test': '/test',
            'http://test.com/': 'http://test.com/',
            'https://test.com//': 'https://test.com/',
            'http:///test.com//': 'http://test.com/',
            'ftp://test.com/': 'ftp://test.com/',
            'https://user:pass@test.com/': 'https://user:pass@test.com/',
            '/user/{id}': '/user/{id}',
            'user//{id}': '//user/{id}',
            'http://test.com/a/{b}{c}////{d}/': 'http://test.com/a/{b}{c}/{d}/',
            'https://test.com/a?param=value&path=%2Fpath%2Ftest': 'https://test.com/a?param=value&path=%2Fpath%2Ftest',
        };
        for (const testItem of Object.keys(tests)) {
            test(testItem, () => {
                const endpoint = new ApiEndpoint(testItem);
                expect(endpoint).toMatchObject({
                    url: tests[testItem]
                });
            });
        }
    });

    test('Parameters are automatically inferred from the url', () => {
        const endpoint = new ApiEndpoint('/user/{id}');
        expect(endpoint).toMatchObject({
            url: '/user/{id}',
            params: {id: endpointAutoGeneratedParameterDefaults}
        });
    });

    test('Automatically inferred parameters can be overridden', () => {
        const endpoint = new ApiEndpoint({
            url: '/user/{id}/{group}',
            params: {
                group: {
                    required: false
                }
            }
        });
        expect(endpoint).toMatchObject({
            url: '/user/{id}/{group}',
            params: {
                id: endpointAutoGeneratedParameterDefaults,
                group: {required: false}
            }
        });
    });
});

describe('Parameters handling', () => {
    test('Parameters default configuration', () => {
        const endpoint = new ApiEndpoint({
            url: '/test',
            params: {a: null}
        });
        expect(endpoint.params.a).toMatchObject(endpointParameterDefaults);
    });

    test('Parameter defined with validator shortcut', () => {
        const validator = NotEmpty();
        const endpoint = new ApiEndpoint({
            url: '/test',
            params: {a: validator}
        });
        expect(endpoint.params.a).toMatchObject({validator: validator});
    });

    test('Parameter defined with required shortcut', () => {
        const endpoint = new ApiEndpoint({
            url: '/test',
            params: {a: true}
        });
        expect(endpoint.params.a).toMatchObject({required: true});
    });

    test('Parameter found in the url is required by default', () => {
        const endpoint = new ApiEndpoint({
            url: '/test/{a}',
            params: {a: null}
        });
        expect(endpoint.params.a).toMatchObject({required: true});
    });

    test('Parameter not found in the url is not required by default', () => {
        const endpoint = new ApiEndpoint({
            url: '/test',
            params: {a: null}
        });
        expect(endpoint.params.a).toMatchObject({required: false});
    });

    test('Parameter with specific configuration values defined', () => {
        const endpoint = new ApiEndpoint({
            url: '/test',
            params: {a: {
                required: true,
                defaultValue: 'default'
            }}
        });
        expect(endpoint.params.a).toMatchObject({
            required: true,
            url: false,
            defaultValue: 'default',
            validator: null
        });
    });

    describe('Parameter in url are detected', () => {
        const tests: Record<string, string[]> = {
            '/user/{id}': ['id'],
            '/user/{a}/{b}': ['a', 'b'],
            '/user/{a-b}': ['a-b'],
            '/{a}{b}': ['a', 'b'],
            '/test/{{a}}': ['{a}']
        };
        for (const testItem of Object.keys(tests)) {
            test(testItem, () => {
                const parameters: any = tests[testItem].reduce((r: any, i) => {
                    r[i] = null;
                    return r;
                }, {});
                const configs: Record<string, ApiEndpointParameterOptions> = {};
                const expected: Record<string, Partial<ApiEndpointParameterInterface>> = {};
                for (const param of tests[testItem]) {
                    configs[param] = null;
                    expected[param] = {url: true};
                }
                const endpoint = new ApiEndpoint({
                    url: testItem,
                    params: parameters
                });
                expect(endpoint.params).toMatchObject(expected);
            });
        }
    });

    const tests: Record<string /* describe */, Record<string /* test */, [
        string|Constructor<Exception>,               // Expected result url or error
        Record<string, ApiEndpointParameterOptions>, // Params config
        Record<string, any>                          // Params values
    ]>> = {
        'Valid cases': {
            '/test': ['/test', {}, {}],
            '/user/{id}': ['/user/2', {id: null}, {id: 2}],
            '/user-full/{id}': ['/user-full/2?full=true', {'*': {}}, {id: 2, full: true}],
            '/test-{a}-{b}/{01c}': ['/test-a-b/c', {a: null, b: null, '01c': {defaultValue: 'c'}}, {a: 'a', b: 'b'}],
            '/test/{a}/{b}/test': ['/test/a/b/test?c=', {a: null, b: null, c: null}, {a: 'a', b: 'b', c: ''}],
            '/wildcard/{defined}': ['/wildcard/d?a=a&b=%F0%9F%98%8B', {defined: null, '*': null}, {defined: 'd', a: 'a', b: 'ðŸ˜‹'}],
            '/url-params-encoding/{a}': ['/url-params-encoding/%F0%9F%98%8B', {a: null}, {a: 'ðŸ˜‹'}],
            'http://test.com/a?param=value&path=%2Fpath%2Ftest': ['http://test.com/a?param=value&path=%2Fpath%2Ftest&new=new+value', {'*': null}, {new: 'new value'}],
            'https://test.com/test?existing=a&other=2': ['https://test.com/test?existing=b&other=2', {existing: null}, {existing: 'b'}]
        },
        'Invalid cases': {
             '/user/{id}': [MissingRequiredParameterException, {id: true}, {}],
            '/user-min/{id}': [InvalidParameterException, {id: Min(5)}, {id: 2}],
        }
    };

    for (const group of Object.keys(tests)) {
        describe(group, () => {
            const groupTests = tests[group];
            for (const testItem of Object.keys(groupTests)) {
                test(testItem, () => {
                    const testData = groupTests[testItem];
                    const endpoint = new ApiEndpoint({
                        url: testItem,
                        params: testData[1]
                    });
                    if (isString(testData[0])) {
                        expect(endpoint.buildRequest(null, testData[2]).staticUrl).toEqual(testData[0]);
                    } else {
                        expect(() => endpoint.buildRequest(null, testData[2]).staticUrl).toThrow(testData[0]);
                    }
                });
            }
        });
    }
});

describe('@Endpoint()', () => {
    const storage = Injector.Get(ApiEndpointStorageService);

    beforeEach(() => {
        storage.clear();
    });

    test('Single endpoint', () => {
        @Endpoint('test', '/test')
        class Foo { }

        const endpoint = storage.getEndpoint('test', Foo);
        expect(endpoint).toBeInstanceOf(ApiEndpoint);
        expect(endpoint).toMatchObject({
            url: '/test',
            method: HttpMethod.GET
        });
    });

    test('Multiple endpoint', () => {
        @Endpoint('test2', '/test2')
        @Endpoint('test1', '/test2')
        class Foo { }

        expect(storage.getEndpoint('test1', Foo)).toBeInstanceOf(ApiEndpoint);
        expect(storage.getEndpoint('test2', Foo)).toBeInstanceOf(ApiEndpoint);
        expect(() => storage.getEndpoint('test')).toThrow(EndpointNotFoundException);
    });

    test('Endpoint only accessible for the right constructor', () => {
        @Endpoint('test', '/test2')
        class Foo { }

        expect(() => storage.getEndpoint('test')).toThrow(EndpointNotFoundException);
        expect(() => storage.getEndpoint('test', ApiEndpointStorageService)).toThrow(EndpointNotFoundException);
    });
});
