/*!
 * Banquette Model v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./_virtual/_tslib.js"),t=require("@banquette/dependency-injection/_cjs/prod/decorator/service.decorator"),i=require("@banquette/exception/_cjs/prod/usage.exception"),a=require("@banquette/utils-type/_cjs/prod/ensure-array"),r=require("@banquette/utils-type/_cjs/prod/ensure-string"),s=require("@banquette/utils-type/_cjs/prod/is-function"),n=require("@banquette/utils-type/_cjs/prod/is-null-or-undefined"),o=require("@banquette/utils-type/_cjs/prod/is-string"),l=require("@banquette/utils-type/_cjs/prod/is-symbol"),c=require("@banquette/utils-type/_cjs/prod/is-undefined"),d=require("./constants.js"),u=require("./exception/model-alias-not-found.exception.js"),p=function(){function ModelMetadataService(){this.aliases={},this.factories=new WeakMap,this.relations=new WeakMap}var p;return p=ModelMetadataService,ModelMetadataService.prototype.registerFactory=function(e,t){this.factories.set(e,t)},ModelMetadataService.prototype.getFactory=function(e){var t=this.factories.get(e);return s.isFunction(t)?t:function(){return new e}},ModelMetadataService.prototype.registerAlias=function(e,t){for(var r=0,s=a.ensureArray(t);r<s.length;r++){var n=s[r];if(!c.isUndefined(this.aliases[n])&&this.aliases[n]!==e)throw new i.UsageException('The alias "'.concat(n,'" is already in used by "').concat(this.aliases[n].name,'".'));this.aliases[n]=e}},ModelMetadataService.prototype.resolveAlias=function(e){if(!p.IsAlias(e))return e;if(c.isUndefined(this.aliases[e]))throw new u.ModelAliasNotFoundException(e,'The model alias "'.concat(r.ensureString(e),"\" doesn't exist."));return this.aliases[e]},ModelMetadataService.prototype.registerRelation=function(e,t,a){var r=this.resolveAlias(e);if(c.isUndefined(a))throw new i.UsageException('Unable to register relation of property "'.concat(t,'" of model "').concat(r.name,'". ')+"You may have a circular dependency. Try to register a string alias instead.");this.relations.has(r)||this.relations.set(r,{});var s=this.relations.get(r);if(!c.isUndefined(s[t])&&this.resolveAlias(a)!==this.resolveAlias(s[t]))throw new i.UsageException('Two conflicting relations have been defined for "'.concat(t,'" of model "').concat(r.name,'".'));s[t]=a,this.relations.set(r,s)},ModelMetadataService.prototype.getRelation=function(e,t){var i=this.resolveAlias(e);do{var a=this.relations.get(i);if(!n.isNullOrUndefined(a)&&!c.isUndefined(a[t]))return this.resolveAlias(a[t]);i=Object.getPrototypeOf(i)}while(i&&i!==d.ObjectCtor);return null},ModelMetadataService.prototype.clear=function(){this.clearAliases(),this.clearFactories(),this.clearRelations()},ModelMetadataService.prototype.clearAliases=function(){this.aliases={}},ModelMetadataService.prototype.clearFactories=function(){this.factories=new WeakMap},ModelMetadataService.prototype.clearRelations=function(){this.relations=new WeakMap},ModelMetadataService.IsAlias=function(e){return o.isString(e)||l.isSymbol(e)},ModelMetadataService=p=e.__decorate([t.Service()],ModelMetadataService)}();exports.ModelMetadataService=p;
