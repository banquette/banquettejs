/*!
 * Banquette Model v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./_virtual/_tslib.js"),t=require("@banquette/dependency-injection/_cjs/prod/decorator/inject.decorator"),r=require("@banquette/dependency-injection/_cjs/prod/decorator/service.decorator"),a=require("@banquette/object-observer/_cjs/prod/index"),n=require("@banquette/utils-type/_cjs/prod/ensure-array"),i=require("@banquette/utils-type/_cjs/prod/is-numeric"),o=require("./model-metadata.service.js"),c=require("./model-transform-metadata.service.js"),u=function(){function ModelWatcherService(e,t){this.modelMetadata=e,this.transformMetadata=t}return ModelWatcherService.prototype.watch=function(e,t,r){var n=null!==t&&t.length>0?t:null;null!==n&&(n=n.map((function(e){return"/"!==e[0]?"/"+e:e})));var o=a.ObserverFactory.Create(e);return o.subscribe((function(e){var t="/"+e.mutation.pathParts.filter((function(e){return!i.isNumeric(e)})).join("/"),a=null===n;if(null!==n)for(var o=0,c=n;o<c.length;o++){var u=c[o];if(u===t||t.length>u.length&&t.substring(0,u.length)===u){a=!0;break}}a&&r(e)})),o.proxy},ModelWatcherService.prototype.watchTransformableProperties=function(e,t,r){var a=this.createWatchPaths(e.constructor,t);return this.watch(e,a,r)},ModelWatcherService.prototype.createWatchPaths=function(e,t,r,a){void 0===r&&(r="/"),void 0===a&&(a=[]);for(var i=[],o=0,c=t=n.ensureArray(t);o<c.length;o++)for(var u=c[o],s=this.transformMetadata.getAll(e,u),l=0,d=Object.keys(s);l<d.length;l++){var h=d[l],v=r+("/"!==r?"/":"")+h;i.indexOf(h)<0&&i.push(v);var p=this.modelMetadata.getRelation(e,h);null!==p&&a.indexOf(p)<0&&(a.push(p),i=i.concat(this.createWatchPaths(p,t,v,a)),a.pop())}return i},ModelWatcherService=e.__decorate([r.Service(),e.__param(0,t.Inject(o.ModelMetadataService)),e.__param(1,t.Inject(c.ModelTransformMetadataService)),e.__metadata("design:paramtypes",[o.ModelMetadataService,c.ModelTransformMetadataService])],ModelWatcherService)}();exports.ModelWatcherService=u;
