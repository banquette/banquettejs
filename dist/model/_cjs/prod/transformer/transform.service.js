/*!
 * Banquette Model v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var r=require("../_virtual/_tslib.js"),e=require("@banquette/dependency-injection/_cjs/prod/decorator/inject-multiple.decorator"),t=require("@banquette/dependency-injection/_cjs/prod/decorator/inject.decorator"),n=require("@banquette/dependency-injection/_cjs/prod/decorator/service.decorator"),o=require("@banquette/exception/_cjs/prod/exception.factory"),a=require("@banquette/utils-object/_cjs/prod/get-symbol-description"),s=require("@banquette/utils-type/_cjs/prod/is-array"),i=require("@banquette/utils-type/_cjs/prod/is-function"),u=require("@banquette/utils-type/_cjs/prod/is-null-or-undefined"),f=require("@banquette/utils-type/_cjs/prod/is-undefined"),c=require("../constants.js"),l=require("../exception/no-compatible-transformer-found.exception.js"),m=require("../exception/transform-failed.exception.js"),d=require("../model-metadata.service.js"),p=require("../model-transform-metadata.service.js"),v=require("../transform-result.js"),h=require("../utils.js"),y=require("./transform-context.js"),T=function(){function TransformService(r,e,t){this.modelMetadata=r,this.transformMetadata=e,this.transformers=t,this.sortedTransformers=[]}return TransformService.prototype.transform=function(r,e,t,n){var o=this;if(!(r instanceof y.TransformContext)&&s.isArray(r))return this.transformCollection(r,e,t,n);var a=null,i=null;r instanceof y.TransformContext&&(a=r,e=r.type,i=r.ctor,r=a.value);var u=new y.TransformContext(a,e,i||r.constructor,r,null,t||{});return this.transformWithWildcard(n,u,(function(){return o.getTransformer(u).transform(u)}))},TransformService.prototype.transformInverse=function(r,e,t,n,o){var a=this;if(!(r instanceof y.TransformContext)&&s.isArray(r))return this.transformCollectionInverse(r,e,t,n,o);var i=null;r instanceof y.TransformContext&&(i=r,e=r.ctor,t=r.type,r=i.value);var u=this.modelMetadata.resolveAlias(e),f=new y.TransformContext(i,t,u,r,null,n||{});return this.transformWithWildcard(o,f,(function(){return a.getTransformer(f).transformInverse(f)}))},TransformService.prototype.transformTransversal=function(r,e,t,n){var o=this;return this.transformSequential([function(){return o.transformInverse(r,t,e)},function(r){return o.transform(r.result,n)}])},TransformService.prototype.transformSequential=function(r){var e=new v.TransformResult,t=-1,n=new v.TransformResult,o=null,a=null,next=function(){if(!i.isFunction(r[++t]))return e.setResult(n.result),void(o&&o());try{var s=r[t](n);s.promise?(e.delayResponse(new Promise((function(r,e){o=r,a=e}))),s.promise.then((function(){n=s,next()})).catch(a)):(n=s,next())}catch(r){if(null===a)throw r;return void a(r)}};return next(),e},TransformService.prototype.transformParallel=function(r,e){for(var t=new v.TransformResult,n=[],o=new WeakMap,a={},buildFinalArray=function(){for(var e=[],t=0;t<r.length;++t)e.push(a[t]);return e},s=0;s<r.length;++s){var i=e(r[s]);null!==i.promise?(n.push(i.promise),o.set(i,s)):a[s]=i.result}return n.length>0?t.delayResponse(new Promise((function(r,e){Promise.all(n).then((function(e){for(var n=0,s=e;n<s.length;n++){var i=s[n],u=o.get(i);f.isUndefined(u)||(a[u]=i.result)}t.setResult(buildFinalArray()),r()})).catch(e)}))):t.setResult(buildFinalArray()),t},TransformService.prototype.transformCollection=function(r,e,t,n){var o=this;return this.transformParallel(r,(function(r){return o.transform(r,e,t,n)}))},TransformService.prototype.transformCollectionInverse=function(r,e,t,n,o){var a=this;return this.transformParallel(r,(function(r){return a.transformInverse(r,e,t,n,o)}))},TransformService.prototype.getTransformers=function(){return this.transformers.length!==this.sortedTransformers.length&&(this.sortedTransformers=this.transformers.map((function(r){return h.ensureCompleteModelTransformer(r)})).sort((function(r,e){return e.getPriority()-r.getPriority()}))),this.sortedTransformers},TransformService.prototype.getTransformer=function(r){for(var e=0,t=this.getTransformers();e<t.length;e++){var n=t[e];if(n.supports(r))return n}throw new l.NoCompatibleTransformerFoundException(r,"No compatible transformer has been found for this context.")},TransformService.prototype.transformWithWildcard=function(r,e,t){var n=this.transformMetadata.getWildcard(e.ctor,e.type);u.isNullOrUndefined(r)||this.transformMetadata.registerWildcard(e.ctor,e.type,r);var o=this.transformWithErrorHandling(e,t);return null===n?this.transformMetadata.removeWildcard(e.ctor,e.type):this.transformMetadata.registerWildcard(e.ctor,e.type,n),o},TransformService.prototype.transformWithErrorHandling=function(r,e){try{return e()}catch(e){var t=new m.TransformFailedException('Failed to transform "'.concat(r.ctor.name,'" (transformer: ').concat(a.getSymbolDescription(r.type),")."),o.ExceptionFactory.EnsureException(e));return r.result.fail(t),r.result}},TransformService=r.__decorate([n.Service(),r.__param(0,t.Inject(d.ModelMetadataService)),r.__param(1,t.Inject(p.ModelTransformMetadataService)),r.__param(2,e.InjectMultiple(c.ModelTransformerTag)),r.__metadata("design:paramtypes",[d.ModelMetadataService,p.ModelTransformMetadataService,Array])],TransformService)}();exports.TransformService=T;
