/*!
 * Banquette Promise v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,t=require("@banquette/exception/_cjs/prod/usage.exception"),r=require("@banquette/utils-type/_cjs/prod/ensure-array"),s=require("@banquette/utils-type/_cjs/prod/is-object"),o=require("@banquette/utils-type/_cjs/prod/is-promise-like"),n=require("@banquette/utils-type/_cjs/prod/is-type"),i=require("@banquette/utils-type/_cjs/prod/is-undefined"),a=require("./exception/cancel.exception.js"),u=require("./exception/timeout.exception.js"),c=require("./promise-event-type.js"),b=require("./promise-status.js"),l=function(){function ObservablePromise(t,r){this.parent=r,this[e]="ObservablePromise",this.status=b.PromiseStatus.Pending,this.observers=[],this.progressHistory=[],this.canForwardReject=!1,this.doForwardReject=!1;try{t(ObservablePromise.Proxy(this.resolve,this),ObservablePromise.Proxy(this.reject,this),ObservablePromise.Proxy(this.notify,this))}catch(e){this.reject(e)}}return ObservablePromise.prototype.then=function(e,t,r,s){var o=this;return void 0===s&&(s=[]),new ObservablePromise((function(n,i,a){var u={onResolve:function(t){if(e)try{n(e(t))}catch(e){u.onReject(e)}else n(t)},onReject:function(e){if(!t)return i(e);try{var r=t(e);o.doForwardReject?i(r):n(r)}catch(e){i(e)}finally{o.doForwardReject=!1}},onProgress:{types:s,callback:function(e){if(!r)return a(e);try{r(e)}catch(e){u.onReject(e)}}}};o.subscribe(u)}),this)},ObservablePromise.prototype.catch=function(e){return this.parent&&this.parent.forwardReject(),this.then((function(e){return e}),e)},ObservablePromise.prototype.catchOf=function(e,t){return this.catchBasedOnType(r.ensureArray(e),!0,t)},ObservablePromise.prototype.catchNotOf=function(e,t){return this.catchBasedOnType(r.ensureArray(e),!1,t)},ObservablePromise.prototype.progress=function(e,t){return void 0===t&&(t=[]),this.then((function(e){return e}),void 0,e,t)},ObservablePromise.prototype.finally=function(e){var t=this;return new ObservablePromise((function(r,s){var o,n=!1;return t.then((function(t){o=t,e&&e()}),(function(t){o=t,n=!0,e&&e()})).then((function(){return n?s(o):r(o)}))}))},ObservablePromise.prototype.cancel=function(){this.reject(new a.CancelException)},ObservablePromise.prototype.timeout=function(e){var t=this;return new ObservablePromise((function(r,s,o){return setTimeout((function(){t.isPending()&&t.reject(new u.TimeoutException)}),e),t.then(r,s,o)}))},ObservablePromise.prototype.isPending=function(){return this.status===b.PromiseStatus.Pending},ObservablePromise.prototype.isFulfilled=function(){return this.status===b.PromiseStatus.Fulfilled},ObservablePromise.prototype.isRejected=function(){return this.status===b.PromiseStatus.Rejected},ObservablePromise.prototype.toString=function(){return"[object ObservablePromise]"},ObservablePromise.prototype.forwardReject=function(){this.canForwardReject=!0},ObservablePromise.prototype.resolve=function(e){return this.settle(e,b.PromiseStatus.Fulfilled)},ObservablePromise.prototype.reject=function(e){return this.settle(e,b.PromiseStatus.Rejected)},ObservablePromise.prototype.notify=function(e){this.progressHistory.push(e),this.dispatch(c.PromiseEventType.progress,e)},ObservablePromise.prototype.subscribe=function(e){this.observers.push({onResolve:e.onResolve||function(e){return e},onReject:e.onReject||function(){},onProgress:e.onProgress||{callback:function(){},types:[]}}),this.status!==b.PromiseStatus.Pending&&this.dispatch(ObservablePromise.EventTypeFromStatus(this.status),this.result,this.observers.length-1);for(var t=0,r=this.progressHistory;t<r.length;t++){var s=r[t];this.dispatch(c.PromiseEventType.progress,s,this.observers.length-1)}},ObservablePromise.prototype.settle=function(e,r){var s=this;setTimeout((function(){if(r===b.PromiseStatus.Pending)throw new t.UsageException("You can't set the pending status.");s.status===b.PromiseStatus.Pending&&(e instanceof ObservablePromise?e.then(ObservablePromise.Proxy(s.resolve,s),ObservablePromise.Proxy(s.reject,s),ObservablePromise.Proxy(s.notify,s)):n.isType(e,o.isPromiseLike)?e.then(ObservablePromise.Proxy(s.resolve,s),ObservablePromise.Proxy(s.reject,s)):(s.result=e,s.status=r,s.dispatch(ObservablePromise.EventTypeFromStatus(s.status),e),s.observers=[]))}))},ObservablePromise.prototype.dispatch=function(e,r,s){var doDispatch=function(t){switch(e){case c.PromiseEventType.resolve:t.onResolve(r);break;case c.PromiseEventType.reject:t.onReject(r);break;case c.PromiseEventType.progress:t.onProgress.types.length||t.onProgress.callback(r)}};if(i.isUndefined(s))for(var o=0,n=this.observers;o<n.length;o++){doDispatch(n[o])}else{if(!(this.observers.length>s))throw new t.UsageException("Out of bounds observer index (".concat(s,"), ").concat(this.observers.length," observers in array."));doDispatch(this.observers[s])}},ObservablePromise.prototype.catchBasedOnType=function(e,t,r){var o=this;return this.parent&&this.parent.forwardReject(),this.then((function(e){return e}),(function(n){var i=s.isObject(n)?e.indexOf(n.constructor):null;if(!t&&null===i||null!==i&&(t&&i>-1||!t&&i<0))return r(n),n;if(o.canForwardReject)throw o.doForwardReject=!0,n;return n}))},ObservablePromise.Resolve=function(e){return new ObservablePromise((function(t){t(e)}))},ObservablePromise.Reject=function(e){return new ObservablePromise((function(t,r){r(e)}))},ObservablePromise.resolve=function(e){return ObservablePromise.Resolve(e)},ObservablePromise.reject=function(e){return ObservablePromise.Reject(e)},ObservablePromise.All=function(e){return new ObservablePromise((function(t,s){e=r.ensureArray(e);for(var o=0,n=new Array(e.length),i=0;i<e.length;++i)ObservablePromise.Resolve(e[i]).then(function(r){return function(s){n[r]=s,++o===e.length&&t(n)}}(i)).catch(s)}))},ObservablePromise.Any=function(e){return new ObservablePromise((function(t,r){for(var s=!1,o=0,n=e;o<n.length;o++){var i=n[o];ObservablePromise.Resolve(i).then((function(e){s||t(e)})).catch((function(e){s||r(e)})).finally((function(){s=!0}))}}))},ObservablePromise.ResolveAfterDelay=function(e,t){return new ObservablePromise((function(r){setTimeout((function(){r(t)}),e)}))},ObservablePromise.MinDelay=function(e,t){var r=(new Date).getTime();return new ObservablePromise((function(s,o){var forward=function(e,t){e===c.PromiseEventType.resolve?s(t):e===c.PromiseEventType.reject&&o(t)},forwardIfDelay=function(t,s){var o=(new Date).getTime()-r;o>=e?forward(t,s):setTimeout((function(){forward(t,s)}),e-o)};new ObservablePromise(t).then((function(e){forwardIfDelay(c.PromiseEventType.resolve,e)})).catch((function(e){forwardIfDelay(c.PromiseEventType.reject,e)}))}))},ObservablePromise.EventTypeFromStatus=function(e){switch(e){case b.PromiseStatus.Fulfilled:return c.PromiseEventType.resolve;case b.PromiseStatus.Rejected:return c.PromiseEventType.reject;default:return c.PromiseEventType.progress}},ObservablePromise.Proxy=function(e,t){var r=Array.prototype.slice.call(arguments,2);return function(){return e.apply(t||this,r.concat(Array.prototype.slice.call(arguments)))}},ObservablePromise}();e=Symbol.toStringTag,exports.ObservablePromise=l;
