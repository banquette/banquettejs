/*!
 * Banquette Ui v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("../../_virtual/_tslib.js"),t=require("@banquette/exception/_cjs/prod/usage.exception"),i=require("@banquette/http/_cjs/prod/encoder/form-data.encoder"),a=require("@banquette/http/_cjs/prod/event/transfer-progress.event"),l=require("@banquette/utils-misc/_cjs/prod/once-per-cycle-proxy"),r=require("@banquette/utils-string/_cjs/prod/format/byte-count-to-human-size"),o=require("@banquette/utils-string/_cjs/prod/format/trim"),n=require("@banquette/utils-type/_cjs/prod/ensure-array"),s=require("@banquette/utils-type/_cjs/prod/is-null-or-undefined"),u=require("@banquette/utils-type/_cjs/prod/is-object"),d=require("@banquette/utils-type/_cjs/prod/is-string"),p=require("../../misc/remote/remote.module.js"),c=require("../headless-control.view-model.js"),f=require("./constant.js"),h=require("./form-file.js"),v=function(c){function HeadlessFormFileViewModel(e,t){var a=c.call(this,e)||this;return a.i18n=t,a.maxIndividualSize=null,a.maxTotalSize=null,a.autoStartUpload=!0,a.ignoreNonUploadedFiles=!0,a.remote=new p.RemoteModule,a.input=null,a.uploadRequestsMap=new WeakMap,a.dataTransfer=new DataTransfer,a.updateControlValue=l.oncePerCycleProxy((function(){a.viewData.control.value=a.viewData.control.value.slice(0)})),a.viewData.control.value=[],a.remote.updateConfiguration({payloadType:i.PayloadTypeFormData,allowMultiple:!0}),Object.assign(a.viewData,{multiple:!1,accept:null,files:[]}),a}return e.__extends(HeadlessFormFileViewModel,c),Object.defineProperty(HeadlessFormFileViewModel.prototype,"multiple",{get:function(){return this.viewData.multiple},set:function(e){this.viewData.multiple=e},enumerable:!1,configurable:!0}),Object.defineProperty(HeadlessFormFileViewModel.prototype,"accept",{get:function(){return this.viewData.accept},set:function(e){this.viewData.accept=e},enumerable:!1,configurable:!0}),HeadlessFormFileViewModel.prototype.controlValueToViewValue=function(e){for(var t=n.ensureArray(e),i=n.ensureArray(this.viewData.control.value).filter((function(e){return!(e instanceof h.FormFile)||null!==e.file})),a=0,l=t;a<l.length;a++){var r=l[a];i.push(h.FormFile.Create(r,this.i18n))}return i},HeadlessFormFileViewModel.prototype.viewValueToControlValue=function(e){var t=this,resolveFileValue=function(e){return e instanceof h.FormFile?e.status===f.UploadStatus.Remote?e.serverResponse:e.status===f.UploadStatus.Paused?t.ignoreNonUploadedFiles?null:e.file:e.status===f.UploadStatus.Succeeded||!t.ignoreNonUploadedFiles&&e.status===f.UploadStatus.Uploading?e.serverResponse||e.file:null:e};return this.multiple?this.viewData.control.value.reduce((function(e,t){var i=resolveFileValue(t);return null!==i&&e.push(i),e}),[]):this.viewData.control.value.length>0?resolveFileValue(this.viewData.control.value[0]):null},HeadlessFormFileViewModel.prototype.onFileSelectionChange=function(e){if("change"!==e.type||!(e.target instanceof HTMLInputElement)||"file"!==e.target.type)throw new t.UsageException("`onFileSelectionChange` expect to be called by the `change` event of a file input.");var i=null!==e.target.files?Array.from(e.target.files):[];if(!this.multiple){for(var a=[],l=0,r=this.viewData.control.value;l<r.length;l++){var o=r[l];null!==o.file&&i.indexOf(o.file)<0&&a.push(o)}for(var n=0,s=a;n<s.length;n++){var u=s[n];this.cancel(u)}}for(var d=0,p=i;d<p.length;d++){var c=p[d];this.queue(c)}this.updateControlValue()},HeadlessFormFileViewModel.prototype.cancel=function(e){var t=this.viewData.control.value.indexOf(e);t<0||(this.pause(e),this.viewData.control.value.splice(t,1),this.updateControlValue(),this.removeFileFromInput(e))},HeadlessFormFileViewModel.prototype.cancelAll=function(){for(var e=0,t=this.viewData.control.value;e<t.length;e++){var i=t[e];this.cancel(i)}},HeadlessFormFileViewModel.prototype.pause=function(e){if(e.status===f.UploadStatus.Uploading){var t=this.uploadRequestsMap.get(e);s.isNullOrUndefined(t)||(t.cancel(),e.progress=0,e.uploadedSize=0,e.status=f.UploadStatus.Paused,this.uploadRequestsMap.delete(e)),this.updateControlValue()}},HeadlessFormFileViewModel.prototype.pauseAll=function(){for(var e=0,t=this.viewData.control.value;e<t.length;e++){var i=t[e];this.pause(i)}},HeadlessFormFileViewModel.prototype.start=function(e){var i=this;if(e.file&&e.status!==f.UploadStatus.Uploading&&e.status!==f.UploadStatus.Succeeded&&this.validateFile(e)){var l=this.uploadRequestsMap.get(e);if(s.isNullOrUndefined(l)||l.cancel(),!this.remote.isApplicable)throw new t.UsageException("You must define an url or endpoint where to upload the file.");var r=this.remote.send({file:e.file},{},{},[f.FileUploadTag]);this.uploadRequestsMap.set(e,r.request),r.promise.progress((function(t){t instanceof a.TransferProgressEvent&&(e.progress=Math.round(t.percent),e.uploadedSize=t.loaded)})).then((function(){e.serverResponse=i.isAcceptableAsServerResponse(r.result)?r.result:void 0,e.status=f.UploadStatus.Succeeded})).catch((function(){e.error=r.error?r.error.message:i.i18n.unknownError,e.status=f.UploadStatus.Failed})).finally((function(){i.uploadRequestsMap.delete(e),i.updateControlValue()})),e.status=f.UploadStatus.Uploading,this.updateControlValue()}},HeadlessFormFileViewModel.prototype.queue=function(e){var t=new h.FormFile(e,this.i18n);this.validateFile(t)||(t.status=f.UploadStatus.Failed),this.viewData.control.value.push(t),!t.failed&&this.autoStartUpload&&this.start(this.viewData.control.value[this.viewData.control.value.length-1]),this.dataTransfer.items.add(e),this.updateControlValue()},HeadlessFormFileViewModel.prototype.removeFileFromInput=function(e){if(e.file)for(var t=0;t<this.dataTransfer.items.length;++t){var i=this.dataTransfer.items[t].getAsFile();if(i&&e.file.name===i.name)return this.dataTransfer.items.remove(t),void(this.input&&(this.input.files=this.dataTransfer.files))}},HeadlessFormFileViewModel.prototype.isAcceptableAsServerResponse=function(e){return u.isObject(e)?Object.keys(e).length>0:d.isString(e)?e.length>0:!s.isNullOrUndefined(e)},HeadlessFormFileViewModel.prototype.validateFile=function(e){if(!e.file)return e.error=this.i18n.unknownError,!1;if(!this.isAcceptableType(e.file))return e.error=this.i18n.invalidType,!1;if(null!==this.maxIndividualSize&&e.file.size>this.maxIndividualSize)return e.error=this.i18n.individualSizeExceeded.replace("{size}",r.byteCountToHumanSize(this.maxIndividualSize)),!1;if(null!==this.maxTotalSize&&this.viewData.control.value.reduce((function(e,t){return e+(t.file?t.file.size:0)}),this.viewData.control.value.indexOf(e)>-1?0:e.file.size)>this.maxTotalSize)return e.error=this.i18n.totalSizeExceeded.replace("{size}",r.byteCountToHumanSize(this.maxTotalSize)),!1;return!0},HeadlessFormFileViewModel.prototype.isAcceptableType=function(e){if(!this.accept)return!0;for(var t=null,i=0,a=this.accept.split(",").map((function(e){return o.trim(e)})).filter((function(e){return e.length}));i<a.length;i++){var l=a[i];if("."===l[0]){if(t||(t=e.name.slice((Math.max(0,e.name.lastIndexOf("."))||1/0)+1)),"."+t===l)return!0}else if(new RegExp(l.replace("*",".*")).test(e.type))return!0}return!1},HeadlessFormFileViewModel}(c.HeadlessControlViewModel);exports.HeadlessFormFileViewModel=v;
