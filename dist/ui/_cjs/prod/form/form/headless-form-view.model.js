/*!
 * Banquette Ui v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("../../_virtual/_tslib.js"),t=require("@banquette/api/_cjs/prod/exception/remote.exception"),r=require("@banquette/api/_cjs/prod/transformer/api"),s=require("@banquette/dependency-injection/_cjs/prod/injector"),i=require("@banquette/event/_cjs/prod/event-dispatcher"),o=require("@banquette/exception/_cjs/prod/exception.factory"),a=require("@banquette/exception/_cjs/prod/usage.exception"),n=require("@banquette/form/_cjs/prod/constant"),l=require("@banquette/form/_cjs/prod/exception/component-not-found.exception"),d=require("@banquette/form/_cjs/prod/form-control"),u=require("@banquette/form/_cjs/prod/form-object"),c=require("@banquette/http/_cjs/prod/http-response"),h=require("@banquette/model-form/_cjs/prod/form-model-binder"),p=require("@banquette/model-form/_cjs/prod/transformer/root/form"),m=require("@banquette/model/_cjs/prod/model-metadata.service"),f=require("@banquette/model/_cjs/prod/transformer/transform.service"),v=require("@banquette/model/_cjs/prod/transformer/type/root/pojo"),b=require("@banquette/utils-misc/_cjs/prod/are-equal"),g=require("@banquette/utils-misc/_cjs/prod/make-reassignable"),w=require("@banquette/utils-misc/_cjs/prod/proxy"),M=require("@banquette/utils-object/_cjs/prod/extend"),y=require("@banquette/utils-object/_cjs/prod/filter-with-mask"),V=require("@banquette/utils-object/_cjs/prod/get-object-value"),E=require("@banquette/utils-type/_cjs/prod/ensure-array"),F=require("@banquette/utils-type/_cjs/prod/is-object"),q=require("@banquette/utils-type/_cjs/prod/is-promise-like"),D=require("@banquette/utils-type/_cjs/prod/is-undefined"),S=require("../../misc/remote/remote.module.js"),H=require("./constant.js"),A=require("./event/after-bind-model.event-arg.js"),j=require("./event/after-validate.event-arg.js"),T=require("./event/before-bind-model.event-arg.js"),x=require("./event/before-validate.event-arg.js"),_=require("./event/action-error.event-arg.js"),P=require("./event/after-persist.event-arg.js"),B=require("./event/after-remote-persist.event-arg.js"),L=require("./event/before-persist.event-arg.js"),I=require("./event/before-load.event-arg.js"),k=require("./exception/remote-validation.exception.js"),C=function(){function HeadlessFormViewModel(){var e,t,r,o,a,l,d=this;this.form=new u.FormObject,this.binder=null,this.modelInstance=null,this._modelType=null,this._loadData=null,this.loadRemote=new S.RemoteModule,this.persistRemote=new S.RemoteModule,this.unsubscribeMethods=[],this.createdControlsMap={},this.eventDispatcher=new i.EventDispatcher,this.load=(e=!0,t=!1,r=0,o=[w.proxy(d.loadRemotely,d),w.proxy(d.loadLocally,d)],a=function(){if(r>=o.length)return t?(r=0,t=!1,void d.load()):(null!==d.modelInstance&&(d.modelInstance=g.makeReassignable(d.modelInstance)),d.form.enable(),d.form.reset(),d.bindModel(),d.updateState(H.Action.Load,H.Status.Success),void d.eventDispatcher.dispatchWithErrorHandling(H.HeadlessFormViewModelEvents.LoadSuccess));try{var e=o[r++]();q.isPromiseLike(e)?e.then((function(){return a()}),(function(e){d.setError(H.ErrorType.Load,e)})):a()}catch(e){d.setError(H.ErrorType.Load,e)}},function(){if(e||!d.is(H.Action.Load,H.Status.Working)){e=!1,d.form.disable(),d.updateState(H.Action.Load,H.Status.Working);var r=d.eventDispatcher.dispatchWithErrorHandling(H.HeadlessFormViewModelEvents.BeforeLoad,new I.BeforeLoadEventArg(d));r.promise?r.promise.then(a):a()}else t=!0}),this.getModelMetadata=(l=null,function(){return l||(l=s.Injector.Get(m.ModelMetadataService)),l}),this.getTransformService=function(){var e=null;return function(){return e||(e=s.Injector.Get(f.TransformService)),e}}(),this.setViewData({errorsMap:{},getControl:w.proxy(this.getControl,this),getControlErrors:w.proxy(this.getControlErrors,this)}),this.updateState(H.Action.Load,H.Status.Working),this.unsubscribeMethods.push(this.loadRemote.onConfigurationChange((function(){d.is(H.Action.Load,H.Status.Working)||d.load()}))),this.unsubscribeMethods.push(this.form.onStateChanged((function(e){e.state===n.BasicState.Validating&&!e.newValue&&d.form.valid&&d.removeError(H.ErrorType.Validate),d.viewData.form[e.state]=e.newValue}))),this.unsubscribeMethods.push(this.form.onValidationStart((function(e){d.eventDispatcher.dispatchWithErrorHandling(H.HeadlessFormViewModelEvents.BeforeValidate,new x.BeforeValidateEventArg(e.source)).defaultPrevented&&e.preventDefault()}),0,!1)),this.unsubscribeMethods.push(this.form.onValidationEnd((function(e){d.eventDispatcher.dispatchWithErrorHandling(H.HeadlessFormViewModelEvents.AfterValidate,new j.AfterValidateEventArg(e.source,e.result))}),0,!1)),this.unsubscribeMethods.push(this.form.onValueChanged((function(e){d.viewData.form.value=e.newValue})))}return Object.defineProperty(HeadlessFormViewModel.prototype,"modelType",{get:function(){return this._modelType},set:function(e){var t=null!==e?this.getModelMetadata().resolveAlias(e):null,r=this._modelType!==t;this._modelType=t,r&&!this.is(H.Action.Load,H.Status.Working)&&this.load()},enumerable:!1,configurable:!0}),Object.defineProperty(HeadlessFormViewModel.prototype,"loadData",{get:function(){return this._loadData},set:function(e){var t=!b.areEqual(this._loadData,e);this._loadData=e,t&&!this.is(H.Action.Load,H.Status.Working)&&this.load()},enumerable:!1,configurable:!0}),HeadlessFormViewModel.prototype.setViewData=function(e){var t=this;this.viewData=M.extend(e,{form:{invalid:!1,notValidated:!0,validating:!1,busy:!1,disabled:!0,dirty:!1,touched:!1,changed:!1,value:void 0,get valid(){return!this.invalid},get validated(){return!this.notValidated},get notValidating(){return!this.validated},get validatedAndValid(){return this.validated&&this.valid},get pristine(){return!this.dirty},get untouched(){return!this.touched},get unchanged(){return!this.changed},get notBusy(){return!this.busy},get enabled(){return!this.disabled},get errorsDeepMap(){return t.form.errorsDeepMap}}})},HeadlessFormViewModel.prototype.dispose=function(){for(var e=0,t=this.unsubscribeMethods;e<t.length;e++){(0,t[e])()}this.unsubscribeMethods=[],this.createdControlsMap={}},HeadlessFormViewModel.prototype.getControl=function(e,t){try{return this.form.get(e)}catch(s){if(s instanceof l.ComponentNotFoundException){if(this.modelType)return D.isUndefined(t)&&(t=!this.is(H.Action.Load,H.Status.Working)),t&&this.setError(H.ErrorType.Internal,new a.UsageException('No component has been found at path "'.concat(e,'" ')+"and cannot be created because the form is bound to a model.")),null;if(D.isUndefined(this.createdControlsMap[e])){var r=F.isObjectLiteral(this._loadData)?V.getObjectValue(this._loadData,e.split("/")):void 0;this.createdControlsMap[e]=new d.FormControl(r)}return this.form.set(e,this.createdControlsMap[e]),this.createdControlsMap[e]}throw s}},HeadlessFormViewModel.prototype.getControlErrors=function(e){return E.ensureArray(this.viewData.form.errorsDeepMap[e])},HeadlessFormViewModel.prototype.submit=function(){var r=this;if(!this.is(null,H.Status.Working)){e.__awaiter(r,void 0,void 0,(function(){var t,r,s,i,o;return e.__generator(this,(function(e){switch(e.label){case 0:return[4,this.validate()];case 1:return e.sent()?(t=this.modelInstance?this.modelInstance:this.form.value,(r=this.eventDispatcher.dispatchWithErrorHandling(H.HeadlessFormViewModelEvents.BeforePersist,new L.BeforePersistEventArg(t))).promise?[4,r.promise]:[3,3]):[2];case 2:e.sent(),e.label=3;case 3:if(r.error||r.defaultPrevented)return[2];if(!this.persistRemote.isApplicable)return[3,8];this.form.disable(),this.updateState(H.Action.Persist,H.Status.Working),s=this.persistRemote.send(this.modelInstance?this.modelInstance:this.form.value,{},{},[H.FormTag,H.FormPersistTag]),e.label=4;case 4:return e.trys.push([4,6,,7]),[4,s.promise];case 5:return e.sent(),this.updateState(H.Action.Persist,H.Status.Success),this.eventDispatcher.dispatch(H.HeadlessFormViewModelEvents.PersistSuccess,new B.AfterRemotePersistEventArg(s,t)),[3,7];case 6:if(i=e.sent(),s.isError){if(null!==(o=k.RemoteValidationException.CreateFromUnknownInput(s.result))&&(s.result=o),!(s.result instanceof k.RemoteValidationException))throw i;this.setError(H.ErrorType.Validate,null),this.bindPersistErrorsToForm(s.result)}return[3,7];case 7:return[3,9];case 8:this.eventDispatcher.dispatch(H.HeadlessFormViewModelEvents.PersistSuccess,new P.AfterPersistEventArg(t)),e.label=9;case 9:return[2]}}))})).catch((function(e){e instanceof c.HttpResponse&&(e=e.result instanceof t.RemoteException?e.result:e.error),r.setError(H.ErrorType.Persist,e),r.updateState(H.Action.Persist,H.Status.Failure),console.error(e)})).finally((function(){r.form.enable()}))}},HeadlessFormViewModel.prototype.validate=function(){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return this.updateState(H.Action.Validate,H.Status.Working),[4,this.form.validate()];case 1:return e.sent()?(this.updateState(H.Action.Validate,H.Status.Success),this.removeError(H.ErrorType.Validate),this.form.clearErrorsDeep(),[2,!0]):(this.updateState(H.Action.Validate,H.Status.Failure),this.setError(H.ErrorType.Validate,null),[2,!1])}}))}))},HeadlessFormViewModel.prototype.is=function(e,t){if(void 0===t&&(t=null),null===e){if(null===t)throw new a.UsageException("You must define at least an action or a status to test.");return(this.viewData.action&t)===t}var r=(this.viewData.action&e)===e;return r&&null!==t?(this.viewData.action&t)===t:r},HeadlessFormViewModel.prototype.updateState=function(e,t){void 0===t&&(t=null);var r=e;null!==t&&(r|=t),this.viewData.action=r,this.viewData.loading=this.is(H.Action.Load,H.Status.Working),this.viewData.loadError=this.is(H.Action.Load,H.Status.Failure),this.viewData.loadSuccess=this.is(H.Action.Load,H.Status.Success),this.viewData.persisting=this.is(H.Action.Persist,H.Status.Working),this.viewData.persistError=this.is(H.Action.Persist,H.Status.Failure),this.viewData.persistSuccess=this.is(H.Action.Persist,H.Status.Success),this.viewData.validating=this.is(H.Action.Validate,H.Status.Working),this.viewData.validateError=this.is(H.Action.Validate,H.Status.Failure),this.viewData.validateSuccess=this.is(H.Action.Validate,H.Status.Success),t!==H.Status.Failure&&(this.viewData.errorsMap={})},HeadlessFormViewModel.prototype.onBeforeLoad=function(e){return this.eventDispatcher.subscribe(H.HeadlessFormViewModelEvents.BeforeLoad,e)},HeadlessFormViewModel.prototype.onLoadSuccess=function(e){return this.eventDispatcher.subscribe(H.HeadlessFormViewModelEvents.LoadSuccess,e)},HeadlessFormViewModel.prototype.onLoadError=function(e){return this.eventDispatcher.subscribe(H.HeadlessFormViewModelEvents.LoadError,e)},HeadlessFormViewModel.prototype.onBeforePersist=function(e){return this.eventDispatcher.subscribe(H.HeadlessFormViewModelEvents.BeforePersist,e)},HeadlessFormViewModel.prototype.onPersistSuccess=function(e){return this.eventDispatcher.subscribe(H.HeadlessFormViewModelEvents.PersistSuccess,e)},HeadlessFormViewModel.prototype.onPersistError=function(e){return this.eventDispatcher.subscribe(H.HeadlessFormViewModelEvents.PersistError,e)},HeadlessFormViewModel.prototype.onBeforeValidate=function(e){return this.eventDispatcher.subscribe(H.HeadlessFormViewModelEvents.BeforeValidate,e)},HeadlessFormViewModel.prototype.onAfterValidate=function(e){return this.eventDispatcher.subscribe(H.HeadlessFormViewModelEvents.AfterValidate,e)},HeadlessFormViewModel.prototype.onBeforeBindModel=function(e){return this.eventDispatcher.subscribe(H.HeadlessFormViewModelEvents.BeforeBindModel,e)},HeadlessFormViewModel.prototype.onAfterBindModel=function(e){return this.eventDispatcher.subscribe(H.HeadlessFormViewModelEvents.AfterBindModel,e)},HeadlessFormViewModel.prototype.setError=function(e,r){(r=null!==r?o.ExceptionFactory.EnsureException(r):null)instanceof t.RemoteException&&"remote"===r.slug&&(r.slug=e);var s=null!==r?r.slug:e;this.viewData.errorsMap[s]=null!==r?r.message:null,this.updateState(H.ErrorTypeStatusMap[e],H.Status.Failure);var i=H.ErrorTypeEventMap[e];null!==i&&this.eventDispatcher.dispatch(i,new _.ActionErrorEventArg(r)),console.error(r)},HeadlessFormViewModel.prototype.removeError=function(e){D.isUndefined(this.viewData.errorsMap[e])||delete this.viewData.errorsMap[e]},HeadlessFormViewModel.prototype.clearErrors=function(){this.viewData.errorsMap={}},HeadlessFormViewModel.prototype.bindModel=function(){if(this._modelType&&!this.binder&&this.modelInstance){this.eventDispatcher.dispatchWithErrorHandling(H.HeadlessFormViewModelEvents.BeforeBindModel,new T.BeforeBindModelEventArg(this.modelInstance));var e=s.Injector.Get(h.FormModelBinder);this.modelInstance=e.bind(this.modelInstance,this.form),this.binder=e,this.eventDispatcher.dispatchWithErrorHandling(H.HeadlessFormViewModelEvents.AfterBindModel,new A.AfterBindModelEventArg(this.modelInstance,e))}},HeadlessFormViewModel.prototype.loadRemotely=function(){var e=this;if(this.loadRemote.isApplicable)return new Promise((function(t,s){e.loadRemote.send(null,{},{},[H.FormTag,H.FormLoadTag]).promise.then((function(i){var o='The ajax request didn\'t result with the expected value. {detail}You can intercept the response by listening to a "HttpEvents.BeforeResponse" event with the "FormLoadTag" tag to do some custom processing.';e._modelType?e.isValidModelInstance(i.result)?(e.modelInstance=i.result,t()):F.isObject(i.result)?e.getTransformService().transformInverse(i.result,e._modelType,r.ApiTransformerSymbol).onReady().then((function(r){e.modelInstance=r.result,t()}),s):s(new a.UsageException(o.replace("{detail}",'An instance of "'.concat(String(e.modelType),'" or an object to transform is expected.')))):F.isObject(i.result)?(e.form.setDefaultValue(i.result),t()):s(new a.UsageException(o.replace("{detail}","An object is expected.")))}))}))},HeadlessFormViewModel.prototype.loadLocally=function(){var e=this;if(F.isObject(this._loadData)){if(this._modelType){var assignModelData=function(t){if(e.modelInstance){var assignFormTransformResult=function(t){if(t.result instanceof u.FormObject&&(t.result.getByPattern("**").markAsConcrete(),F.isObject(t.result))){var r=y.filterWithMask(t.result.value,e._loadData);e.form.setDefaultValue(r)}},r=e.getTransformService().transform(t,p.FormTransformerSymbol);if(r.promise)return r.promise.then(assignFormTransformResult);assignFormTransformResult(r)}else e.modelInstance=t};if(!this.isValidModelInstance(this._loadData)){if(!F.isObject(this._loadData))return;var t=this.getTransformService().transformInverse(this._loadData,this._modelType,v.PojoTransformerSymbol);return t.promise?new Promise((function(e,r){t.promise.then((function(){return e()}),r)})):assignModelData(t.result)}return assignModelData(this._loadData)}this.form.setDefaultValue(this._loadData)}},HeadlessFormViewModel.prototype.isValidModelInstance=function(e){return!this.modelType||e instanceof this.getModelMetadata().resolveAlias(this.modelType)},HeadlessFormViewModel.prototype.bindPersistErrorsToForm=function(e){for(var t=0,r=e.violations;t<r.length;t++){var s=r[t];this.form.addChildError(s.path,{type:s.type,message:s.message})}},HeadlessFormViewModel}();exports.HeadlessFormViewModel=C;
