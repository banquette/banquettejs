/*!
 * Banquette Ui v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("../../_virtual/_tslib.js"),i=require("@banquette/dependency-injection/_cjs/prod/injector"),t=require("@banquette/exception/_cjs/prod/exception.factory"),o=require("@banquette/exception/_cjs/prod/usage.exception"),s=require("@banquette/form/_cjs/prod/constant"),r=require("@banquette/http/_cjs/prod/http-response"),n=require("@banquette/model/_cjs/prod/model-metadata.service"),c=require("@banquette/model/_cjs/prod/transformer/transform.service"),a=require("@banquette/model/_cjs/prod/transformer/type/root/pojo"),l=require("@banquette/utils-misc/_cjs/prod/proxy"),h=require("@banquette/utils-misc/_cjs/prod/recursion-safe-side-effect-proxy"),u=require("@banquette/utils-misc/_cjs/prod/throttle"),d=require("@banquette/utils-string/_cjs/prod/format/replace-string-variables"),f=require("@banquette/utils-string/_cjs/prod/format/slugify"),p=require("@banquette/utils-string/_cjs/prod/format/trim"),v=require("@banquette/utils-type/_cjs/prod/ensure-array"),C=require("@banquette/utils-type/_cjs/prod/ensure-boolean"),w=require("@banquette/utils-type/_cjs/prod/ensure-string"),S=require("@banquette/utils-type/_cjs/prod/is-array"),g=require("@banquette/utils-type/_cjs/prod/is-function"),b=require("@banquette/utils-type/_cjs/prod/is-null-or-undefined"),y=require("@banquette/utils-type/_cjs/prod/is-object"),m=require("@banquette/utils-type/_cjs/prod/is-primitive"),V=require("@banquette/utils-type/_cjs/prod/is-scalar"),D=require("@banquette/utils-type/_cjs/prod/is-undefined"),M=require("../../misc/remote/remote.module.js"),q=require("../headless-control.view-model.js"),H=require("./choice.js"),F=require("./constant.js"),I=require("./selected-choice.js"),O=function(q){function HeadlessSelectViewModel(e){var t,o=q.call(this,e)||this;return o.choicesLabel=null,o.choicesIdentifier=null,o.choicesValue=null,o.choicesDisabled=null,o.choicesGroup=null,o.choicesOriginOrdering=[F.ChoiceOrigin.User,F.ChoiceOrigin.Default,F.ChoiceOrigin.Remote],o.searchType=F.SearchType.None,o.searchRemoteParamName="search",o.searchMinLength=0,o.allowCreation=!1,o.closeOnSelection="auto",o.modelType=null,o.unsubscribeFunctions=[],o.choices={},o.inlinedChoices=[],o.unsureSelectedChoicesIdentifiers=[],o.lastSelectedIdentifier=void 0,o.noChoiceAvailable=!0,o.searchBufferSlug="",o.onKeyDown=u.throttle((function(e){if("ArrowUp"===e.key)o.moveSelection(-1);else if("ArrowDown"===e.key)o.moveSelection(1);else if("Enter"===e.key){var i=null;if(o.allowCreation&&o.viewData.creationBuffer.length>0){for(var t=0,s=o.inlinedChoices;t<s.length;t++){if((c=s[t]).identifier===o.viewData.creationBuffer){i=c;break}}i||(o.appendChoices([o.viewData.creationBuffer],F.ChoiceOrigin.User),o.selectChoice(o.viewData.creationBuffer),o.setSearchString("")),o.viewData.creationBuffer=""}else for(var r=0,n=o.inlinedChoices;r<n.length;r++){var c;if((c=n[r]).focused){i=c;break}}i&&(o.selectChoice(i),o.focusChoice(i),o.multiple||o.hideChoices())}else{if("Escape"!==e.key)return;o.unFocusAll(),o.hideChoices()}e.preventDefault(),e.stopPropagation()}),50),o.updateChoices=h.recursionSafeSideEffectProxy((function(){var e=[];o.inlinedChoices=[],o.viewData.choices={},o.noChoiceAvailable=!0;for(var i=0,t=o.choicesOriginOrdering;i<t.length;i++){var s=t[i];o.viewData.choices[s]={grouped:{},standalone:[]};for(var r=o.viewData.choices[s],n=0,c=o.choices[s];n<c.length;n++){var a=c[n];if(e.indexOf(a.identifier)>-1)console.warn('Duplicate identifier "'.concat(String(a.identifier),'". Ignoring choice with label "').concat(a.label,'".'));else if(a.group?(D.isUndefined(r.grouped[a.group])&&(r.grouped[a.group]=[]),r.grouped[a.group].push(a),o.inlinedChoices.push(r.grouped[a.group][r.grouped[a.group].length-1])):(r.standalone.push(a),o.inlinedChoices.push(r.standalone[r.standalone.length-1])),e.push(a.identifier),!a.disabled&&a.visible&&(o.noChoiceAvailable=!1),a.new){var l=o.unsureSelectedChoicesIdentifiers.indexOf(a.identifier);if(l>-1){if(o.viewData.multiple){for(var h=0;o.viewData.control.value.length;++h)if(o.viewData.control.value[h].identifier===a.identifier){o.viewData.control.value[h]=o.createSelectedChoice(a);break}}else o.viewData.control.value=o.createSelectedChoice(a);o.unsureSelectedChoicesIdentifiers.splice(l,1)}a.new=!1}}}o.updateChoicesSelectionStatus()})),o.getModelMetadata=(t=null,function(){return t||(t=i.Injector.Get(n.ModelMetadataService)),t}),o.getTransformService=function(){var e=null;return function(){return e||(e=i.Injector.Get(c.TransformService)),e}}(),o.remote=new M.RemoteModule,Object.assign(o.viewData,{choices:[],groupedChoices:{},selectedChoicesCount:0,visibleChoicesCount:0,choicesVisible:!1,multiple:!1,searchBuffer:"",creationBuffer:"",searchMinLength:o.searchMinLength,remoteFetchStatus:F.ChoicesRemoteFetchStatus,remoteFetchError:null}),o}return e.__extends(HeadlessSelectViewModel,q),Object.defineProperty(HeadlessSelectViewModel.prototype,"multiple",{get:function(){return this.viewData.multiple},set:function(e){this.viewData.multiple=e},enumerable:!1,configurable:!0}),HeadlessSelectViewModel.prototype.initialize=function(){return e.__awaiter(this,void 0,void 0,(function(){var i,t,o,r=this;return e.__generator(this,(function(e){for(q.prototype.initialize.call(this),this.unsubscribeFunctions.push(this.control.onStateChanged((function(e){e.state===s.BasicState.Focused&&(e.newValue?r.onFocus():r.onBlur())}))),this.remote.onConfigurationChange(l.proxy(this.fetchRemoteChoices,this)),i=0,t=this.choicesOriginOrdering;i<t.length;i++)o=t[i],this.choices[o]=[];return[2]}))}))},HeadlessSelectViewModel.prototype.dispose=function(){q.prototype.dispose.call(this);for(var e=0,i=this.unsubscribeFunctions;e<i.length;e++){(0,i[e])()}},HeadlessSelectViewModel.prototype.setViewData=function(e){q.prototype.setViewData.call(this,e)},HeadlessSelectViewModel.prototype.fetchRemoteChoices=function(){var e=this;if(this.remote.isApplicable){var i={};if(this.searchType===F.SearchType.Remote){if(this.searchMinLength>0&&this.viewData.searchBuffer.length<this.searchMinLength)return this.viewData.searchMinLength=this.searchMinLength,this.viewData.remoteFetchStatus=F.ChoicesRemoteFetchStatus.WaitingSearch,void this.setChoices([],F.ChoiceOrigin.Remote);if(this.viewData.searchBuffer.length>0)if(g.isFunction(this.searchRemoteParamName))this.searchRemoteParamName(i);else for(var o=0,s=v.ensureArray(this.searchRemoteParamName);o<s.length;o++){i[s[o]]=this.viewData.searchBuffer}}this.viewData.control.busy=!0,this.viewData.remoteFetchError=null,this.viewData.remoteFetchStatus=F.ChoicesRemoteFetchStatus.Pending,this.remote.send(null,i).promise.then((function(i){e.setChoices(v.ensureArray(i.result),F.ChoiceOrigin.Remote),e.viewData.remoteFetchStatus=F.ChoicesRemoteFetchStatus.Idle})).catch((function(i){if(i instanceof r.HttpResponse){if(i.isCanceled)return;i=i.error}e.viewData.remoteFetchError=t.ExceptionFactory.EnsureException(i,"Unknown error.").message,e.viewData.remoteFetchStatus=F.ChoicesRemoteFetchStatus.Failed})).finally((function(){e.viewData.control.busy=!1}))}},HeadlessSelectViewModel.prototype.selectChoice=function(e,i){if(void 0===i&&(i=!0),!(e instanceof H.Choice&&e.disabled)){var t=this.createSelectedChoice(e);if(this.multiple){for(var o=v.ensureArray(this.viewData.control.value),s=0,r=o;s<r.length;s++){var n=r[s];if(n.identifier===e.identifier)return void(i&&this.deselectChoice(n))}o.push(t),this.viewData.control.value=o}else t&&this.viewData.control.value&&this.viewData.control.value.rawValue===t.rawValue||(this.viewData.control.value=t||void 0);(!0===this.closeOnSelection||"auto"===this.closeOnSelection&&!this.multiple)&&this.hideChoices(),this.lastSelectedIdentifier=e.identifier,this.unFocusAll(),this.updateChoicesSelectionStatus()}},HeadlessSelectViewModel.prototype.deselectChoice=function(e){for(var i=v.ensureArray(this.viewData.control.value),t=e instanceof I.SelectedChoice?e.identifier:e,o=0;o<i.length;++o)if(i[o]instanceof I.SelectedChoice&&i[o].identifier===t){this.multiple?(i.splice(o,1),this.viewData.control.value=i):this.viewData.control.value=void 0;break}this.lastSelectedIdentifier=void 0,this.updateChoicesSelectionStatus()},HeadlessSelectViewModel.prototype.deselectAll=function(){this.multiple?this.viewData.control.value=[]:this.viewData.control.value=void 0,this.lastSelectedIdentifier=void 0,this.updateChoicesSelectionStatus()},HeadlessSelectViewModel.prototype.controlValueToViewValue=function(e){var i=this,t=[];if(!D.isUndefined(e))if(this.multiple&&S.isArray(e))for(var o=0,s=e;o<s.length;o++){var r,n=s[o];null!==(r=this.createSelectedChoice(n))&&t.push(r)}else null!==(r=this.createSelectedChoice(e))&&t.push(r);return queueMicrotask((function(){i.updateChoicesSelectionStatus()})),this.multiple?t:t.length>0?t[0]:void 0},HeadlessSelectViewModel.prototype.viewValueToControlValue=function(e){for(var i=[],t=0,o=v.ensureArray(e);t<o.length;t++){var s=o[t];s instanceof I.SelectedChoice?i.push(s.rawValue):i.push(void 0)}return this.multiple?i:i.length>0?i[0]:void 0},HeadlessSelectViewModel.prototype.setChoices=function(e,i){var t=this;void 0===i&&(i=F.ChoiceOrigin.Default),this.updateChoices((function(){t.removeAllChoices(i),t.appendChoices(e,i)}))},HeadlessSelectViewModel.prototype.appendChoices=function(e,i){var t=this;void 0===i&&(i=F.ChoiceOrigin.Default),this.updateChoices((function(){for(var o=0,s=e;o<s.length;o++){var r=s[o],n=t.normalizeChoice(r,i);null!==n&&(t.choices[n.origin].push(n),n.identifier===t.lastSelectedIdentifier&&t.focusChoice(n))}}))},HeadlessSelectViewModel.prototype.prependChoices=function(e,i){var t=this;void 0===i&&(i=F.ChoiceOrigin.Default),this.updateChoices((function(){for(var o=e.length-1;o>=0;--o){var s=t.normalizeChoice(e[o],i);null!==s&&(t.choices[s.origin].unshift(s),s.identifier===t.lastSelectedIdentifier&&t.focusChoice(s))}}))},HeadlessSelectViewModel.prototype.removeChoice=function(e){var i=this,t=e instanceof H.Choice?e.identifier:e;this.updateChoices((function(){for(var e=0,o=Object.keys(i.choices);e<o.length;e++)for(var s=o[e],r=0;r<i.choices[s].length;++r)i.choices[s][r].identifier===t&&i.choices[s].splice(r,1)}))},HeadlessSelectViewModel.prototype.removeAllChoices=function(e){var i=this;void 0===e&&(e=null),this.updateChoices((function(){for(var t=0,o=Object.keys(i.choices);t<o.length;t++)for(var s=o[t],r=0;r<i.choices[s].length;++r)null!==e&&i.choices[s][r].origin!==e||i.choices[s].splice(r--,1)}))},HeadlessSelectViewModel.prototype.showChoices=function(){if(!this.viewData.control.disabled){this.viewData.choicesVisible=!0;for(var e=!D.isUndefined(this.lastSelectedIdentifier),i=0,t=this.inlinedChoices;i<t.length;i++){var o=t[i];if(e&&o.identifier===this.lastSelectedIdentifier||!e&&o.selected){this.focusChoice(o);break}}}},HeadlessSelectViewModel.prototype.hideChoices=function(){this.viewData.choicesVisible=!1,this.unFocusAll()},HeadlessSelectViewModel.prototype.toggleChoices=function(){this.viewData.choicesVisible?this.hideChoices():this.showChoices()},HeadlessSelectViewModel.prototype.focusChoice=function(e){e.focused||e.disabled||(e.focused=!0,this.focusedIdentifier=e.identifier)},HeadlessSelectViewModel.prototype.unFocusChoice=function(e){e.focused=!1,this.focusedIdentifier=void 0},HeadlessSelectViewModel.prototype.unFocusAll=function(){for(var e=0,i=this.inlinedChoices;e<i.length;e++){i[e].focused=!1}this.focusedIdentifier=void 0},HeadlessSelectViewModel.prototype.setSearchString=function(e){this.searchType!==F.SearchType.None&&this.viewData.searchBuffer!==e&&(this.viewData.searchBuffer=p.trim(e),this.searchBufferSlug=f.slugify(this.viewData.searchBuffer),this.searchType===F.SearchType.Local?this.updateChoices():this.searchType===F.SearchType.Remote&&this.fetchRemoteChoices())},HeadlessSelectViewModel.prototype.normalizeChoice=function(e,i){if(e instanceof H.Choice)return e;var t=this.extractChoiceIdentifier(e);if(D.isUndefined(t))return null;e=this.maybeEnsureModel(e);var o=new H.Choice(t,this.extractChoiceLabel(e),this.extractChoiceValue(e),this.extractChoiceGroup(e),i,e);return o.disabled=this.extractChoiceDisabledState(e),o.external=!1,o},HeadlessSelectViewModel.prototype.onFocus=function(){this.showChoices()},HeadlessSelectViewModel.prototype.onBlur=function(){this.hideChoices()},HeadlessSelectViewModel.prototype.moveSelection=function(e){if(this.inlinedChoices.length&&!this.noChoiceAvailable)if(this.viewData.choicesVisible){for(var i=-1,t=0;t<this.inlinedChoices.length;++t)if(this.inlinedChoices[t].focused){i=t,this.unFocusChoice(this.inlinedChoices[t]);break}if(i>-1?(i=(i+e)%this.inlinedChoices.length)<0&&(i=this.inlinedChoices.length+i):i=0,this.inlinedChoices[i].disabled||!this.inlinedChoices[i].visible)return this.inlinedChoices[i].focused=!0,void this.moveSelection(e>0?1:-1);this.focusChoice(this.inlinedChoices[i])}else this.showChoices()},HeadlessSelectViewModel.prototype.extractChoiceLabel=function(e){if(g.isFunction(this.choicesLabel)){var i=this.choicesLabel(e);return V.isScalar(i)||console.warn('The "choices-label" function must return a scalar value, for:',e),String(i)}if(V.isScalar(e))return String(e);var t="(unknown label)";if(!y.isObject(e))return t;if(null!==this.choicesLabel){if(!D.isUndefined(e[this.choicesLabel]))return w.ensureString(e[this.choicesLabel]);if(this.choicesLabel.indexOf("{")>-1)return d.replaceStringVariables(this.choicesLabel,e,"{","}")}return this.choicesLabel?console.warn('No property "'.concat(this.choicesLabel,'" to use as label has been found. You can control it using the "choicesLabel" attribute, for:'),e):console.warn('Please define what property to use as identifier using the "choicesLabel" attribute, for:',e),t},HeadlessSelectViewModel.prototype.extractChoiceValue=function(e){return g.isFunction(this.choicesValue)?this.choicesValue(e):y.isObject(e)&&this.choicesValue?e[this.choicesValue]:e},HeadlessSelectViewModel.prototype.extractChoiceDisabledState=function(e){return g.isFunction(this.choicesDisabled)?C.ensureBoolean(this.choicesDisabled(e)):!(!y.isObject(e)||!this.choicesDisabled)&&!!e[this.choicesDisabled]},HeadlessSelectViewModel.prototype.extractChoiceGroup=function(e){if(g.isFunction(this.choicesGroup)){var i=this.choicesGroup(e);return V.isScalar(i)?String(i):null}return y.isObject(e)&&this.choicesGroup&&e[this.choicesGroup]||null},HeadlessSelectViewModel.prototype.extractChoiceIdentifier=function(e){if(g.isFunction(this.choicesIdentifier)){var i=this.choicesIdentifier(e);if(m.isPrimitive(i))return i}return V.isScalar(e)?e:y.isObject(e)?null===this.choicesIdentifier||g.isFunction(this.choicesIdentifier)||D.isUndefined(e[this.choicesIdentifier])?void(this.choicesIdentifier?console.warn('No property "'.concat(this.choicesIdentifier,'" to use as identifier has been found. You can control it using the "choicesIdentifier" attribute, for:'),e):console.warn('Please define what property to use as identifier using the "choicesIdentifier" attribute, for:',e)):e[this.choicesIdentifier]:void console.warn('Unsupported choice of type "'.concat(typeof e,'".'))},HeadlessSelectViewModel.prototype.createSelectedChoice=function(e){if(e instanceof I.SelectedChoice)return e;if(e instanceof H.Choice)return new I.SelectedChoice(e.label,e.identifier,e.value);var i=this.extractChoiceIdentifier(e);if(b.isNullOrUndefined(i))return null;for(var t=0,o=this.inlinedChoices;t<o.length;t++){var s=o[t];if(s.identifier===i)return this.createSelectedChoice(s)}return this.unsureSelectedChoicesIdentifiers.push(i),new I.SelectedChoice(this.extractChoiceLabel(e),i,e)},HeadlessSelectViewModel.prototype.maybeEnsureModel=function(e){if(!this.modelType)return e;if(!this.isValidModelInstance(e)){if(y.isObject(e)){var i=this.getTransformService().transformInverse(e,this.modelType,a.PojoTransformerSymbol);if(i.promise)throw new o.UsageException("Async transformers are not supported in a select view model. You must transform it yourself before giving it to the select component.");return i.result}throw new o.UsageException('An instance of "'.concat(String(this.modelType),'" or an object to transform is expected.'))}return e},HeadlessSelectViewModel.prototype.isValidModelInstance=function(e){return!this.modelType||e instanceof this.getModelMetadata().resolveAlias(this.modelType)},HeadlessSelectViewModel.prototype.updateChoicesSelectionStatus=function(){for(var e=[],i=[],t=0,o=v.ensureArray(this.viewData.control.value);t<o.length;t++){var s=o[t];s instanceof I.SelectedChoice&&(e.push(s.identifier),y.isObject(s.rawValue)||i.push(s.rawValue))}this.viewData.selectedChoicesCount=0,this.viewData.visibleChoicesCount=0;for(var r=0,n=this.inlinedChoices;r<n.length;r++){var c=n[r];c.selected=e.indexOf(c.identifier)>-1,c.selected&&this.viewData.selectedChoicesCount++,c.visible=!this.isLocallyFiltered(c),c.visible&&this.viewData.visibleChoicesCount++}},HeadlessSelectViewModel.prototype.isLocallyFiltered=function(e){return!(this.searchType!==F.SearchType.Local||!this.searchBufferSlug.length)&&!e.labelSlug.includes(this.searchBufferSlug)},HeadlessSelectViewModel}(q.HeadlessControlViewModel);exports.HeadlessSelectViewModel=O;
