/*!
 * Banquette Ui v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("../_virtual/_tslib.js"),i=require("@banquette/api/_cjs/prod/constant"),t=require("@banquette/config/_cjs/prod/config/configuration.service"),n=require("@banquette/dependency-injection/_cjs/prod/decorator/inject.decorator"),r=require("@banquette/dependency-injection/_cjs/prod/decorator/module.decorator"),s=require("@banquette/event/_cjs/prod/event-dispatcher"),o=require("@banquette/event/_cjs/prod/event-dispatcher.service"),l=require("@banquette/utils-misc/_cjs/prod/proxy"),a=require("@banquette/utils-random/_cjs/prod/unique-id"),u=require("@banquette/utils-type/_cjs/prod/is-null-or-undefined"),d=require("@banquette/utils-type/_cjs/prod/is-object"),p=require("@banquette/utils-type/_cjs/prod/is-string"),h=require("@banquette/utils-type/_cjs/prod/is-type"),c=require("@banquette/utils-type/_cjs/prod/is-undefined"),g=require("../config.js"),f=require("../misc/remote/remote.module.js"),m=require("./constant.js"),b=require("./event/table-request.event.js"),v=require("./event/table-response.event.js"),y=require("./filtering/filtering.module.js"),q=require("./ordering/ordering.module.js"),M=require("./pagination/pagination.module.js"),w=require("./server-result.js");require("./listener/request.listener.js"),require("./listener/response.listener.js"),require("./listener/response-transformer.listener.js");var T=function(){function TableViewModel(e,i,t){var n,r,o=this;this.configuration=e,this.globalDispatcher=i,this.id=null,this.syncUrl=!0,this.saveState=!0,this._items=[],this.visibleItems=[],this.columns=[],this.visibleColumns=[],this.indexedColumns={},this.status=m.Status.Initializing,this.errorDetail=null,this.remote=new f.RemoteModule,this.serverResultsMap={},this.temperedFetch=(n=!1,function(){n||o.initializing||(setTimeout((function(){o.fetch(),n=!1})),n=!0)}),this.updateColumns=(r=0,function(e){++r,e(),0==--r&&(o.updateVisibleColumns(),o.updateColumnsIndex())}),this.localDispatcher=new s.EventDispatcher,this.pagination=t,this.filtering=new y.FilteringModule,this.ordering=new q.OrderingModule,this.pagination.onChange(l.proxy(this.onModuleConfigurationChange,this)),this.filtering.onChange(l.proxy(this.onModuleConfigurationChange,this)),this.ordering.onChange(l.proxy(this.onOrderingConfigurationChange,this)),this.ordering.onInvalidate(l.proxy(this.onOrderingConfigurationChange,this)),this.bindApiListeners()}return Object.defineProperty(TableViewModel.prototype,"items",{get:function(){return this._items},set:function(e){var i=this;this._items=[];for(var _loop_1=function(e){var n;n=t._items.length,i._items.push({item:e,detailsVisible:!1,toggleDetails:function(){i._items[n].detailsVisible=!i._items[n].detailsVisible,i.updateView()}})},t=this,n=0,r=e;n<r.length;n++){_loop_1(r[n])}this.status=m.Status.Ready,this.updateVisibleItems(),this.updateView()},enumerable:!1,configurable:!0}),Object.defineProperty(TableViewModel.prototype,"initializing",{get:function(){return this.status===m.Status.Initializing},enumerable:!1,configurable:!0}),Object.defineProperty(TableViewModel.prototype,"fetching",{get:function(){return this.status===m.Status.Fetching},enumerable:!1,configurable:!0}),Object.defineProperty(TableViewModel.prototype,"error",{get:function(){return this.status===m.Status.Error},enumerable:!1,configurable:!0}),Object.defineProperty(TableViewModel.prototype,"ready",{get:function(){return this.status===m.Status.Ready},enumerable:!1,configurable:!0}),TableViewModel.prototype.addColumn=function(e,i){var t=this;void 0===i&&(i=null),p.isString(e)&&(e={title:e});var n=Object.assign(e,{id:u.isNullOrUndefined(e.id)?a.uniqueId():e.id,title:u.isNullOrUndefined(e.title)?"":e.title,orderingName:c.isUndefined(e.orderingName)?null:e.orderingName,visible:!!u.isNullOrUndefined(e.visible)||e.visible,hideable:!!u.isNullOrUndefined(e.hideable)||e.hideable,width:u.isNullOrUndefined(e.width)?null:e.width,orderingStatus:null});return this.updateColumns((function(){null===i||i>=t.columns.length?t.columns.push(n):t.columns.splice(i,0,n)})),n},TableViewModel.prototype.hideColumn=function(e){this.changeColumnVisibility(e,!1)},TableViewModel.prototype.showColumn=function(e){this.changeColumnVisibility(e,!0)},TableViewModel.prototype.removeColumn=function(e){var i=this;h.isType(e,d.isObject)&&(e=e.id);for(var _loop_2=function(n){if(t.columns[n].id===e)return t.updateColumns((function(){i.columns.splice(n,1)})),{value:void 0}},t=this,n=0;n<this.columns.length;++n){var r=_loop_2(n);if("object"==typeof r)return r.value}},TableViewModel.prototype.getColumn=function(e){return this.indexedColumns[e]||null},TableViewModel.prototype.clearColumns=function(){var e=this;this.updateColumns((function(){e.columns=[]}))},TableViewModel.prototype.fetch=function(){var e=this;if(this.remote.isApplicable){var i=this.remote.send(null,{},{},[m.TableTag]);this.createServerResult(i),i.promise.finally((function(){var t=e.getServerResult(i);null!==t&&i.result instanceof w.ServerResult&&i.result.id===t.id&&!i.isCanceled&&(u.isNullOrUndefined(t.ordering)||e.ordering.digestServerResponse(t.ordering),u.isNullOrUndefined(t.filtering)||e.filtering.digestServerResponse(t.filtering),u.isNullOrUndefined(t.pagination)||e.pagination.digestServerResponse(t.pagination),e.items=i.result.items)})),this.status=m.Status.Fetching,this.updateView()}},TableViewModel.prototype.bindApiListeners=function(){var e=this,t=this.configuration.get(g.UiConfigurationSymbol);this.globalDispatcher.subscribe(i.ApiEvents.BeforeRequest,(function(i){var t=e.getServerResult(i.httpEvent.request.response);if(null!==t){var n=e.globalDispatcher.dispatch(m.TableApiEvents.BeforeRequest,new b.TableRequestEvent(t,e.createEventState(),i.httpEvent)).promise;if(null!==n)return new Promise((function(e){n.finally(e)}));i.stopPropagation()}}),t.table.apiEventsPriorities.beforeRequest,[m.TableTag],[i.ApiProcessorTag]),this.globalDispatcher.subscribe(i.ApiEvents.BeforeResponse,(function(i){var t=e.getServerResult(i.httpEvent.request.response);if(null!==t){var n=e.globalDispatcher.dispatch(m.TableApiEvents.BeforeResponse,new v.TableResponseEvent(t,e.createEventState(),i.httpEvent)).promise;if(null!==n)return new Promise((function(e){n.finally(e)}));i.stopPropagation()}}),t.table.apiEventsPriorities.beforeResponse,[m.TableTag],[i.ApiProcessorTag]),this.globalDispatcher.subscribe(i.ApiEvents.RequestSuccess,(function(e){e.stopPropagation()}),1,[m.TableTag],[i.ApiProcessorTag])},TableViewModel.prototype.createEventState=function(){return{remote:{url:this.remote.url,urlParams:this.remote.urlParams,model:this.remote.model,endpoint:this.remote.endpoint,method:this.remote.method},pagination:{enabled:this.pagination.enabled,page:this.pagination.page,pageId:this.pagination.pageId,itemsPerPage:this.pagination.itemsPerPage,strategy:this.pagination.strategy},filters:this.filtering.getActiveFilters(),ordering:{columnName:this.ordering.columnName,direction:this.ordering.direction}}},TableViewModel.prototype.updateVisibleItems=function(){var e=[].concat(this.items);this.ordering.isApplicable&&!this.isModuleRemoteDependent(this.ordering)?e=this.ordering.apply(e):this.ordering.changed=!1,this.filtering.isApplicable&&!this.isModuleRemoteDependent(this.filtering)?e=this.filtering.apply(e):this.filtering.changed=!1,this.pagination.enabled&&!this.isModuleRemoteDependent(this.pagination)?e=this.pagination.digestFullItemsList(e):this.pagination.changed=!1,this.visibleItems=e,this.updateView()},TableViewModel.prototype.onModuleConfigurationChange=function(){this.initializing||(this.remote.isApplicable&&(this.pagination.changed&&this.isModuleRemoteDependent(this.pagination)||this.filtering.changed&&this.isModuleRemoteDependent(this.filtering)||this.ordering.changed&&this.isModuleRemoteDependent(this.ordering))?this.temperedFetch():this.updateVisibleItems())},TableViewModel.prototype.isModuleRemoteDependent=function(e){return!0===e.remote||"auto"===e.remote&&this.remote.isApplicable},TableViewModel.prototype.onOrderingConfigurationChange=function(){for(var e=0,i=this.columns;e<i.length;e++){var t=i[e];null!==this.ordering.columnName&&t.orderingName===this.ordering.columnName?t.orderingStatus=this.ordering.direction:t.orderingStatus=null}this.onModuleConfigurationChange()},TableViewModel.prototype.changeColumnVisibility=function(e,i){var t=this;this.updateColumns((function(){if(p.isString(e)){var n=t.getColumn(e);if(null===n)return;e=n}e.visible=i}))},TableViewModel.prototype.updateVisibleColumns=function(){this.visibleColumns=this.columns.filter((function(e){return e.visible}))},TableViewModel.prototype.updateColumnsIndex=function(){this.indexedColumns=this.columns.reduce((function(e,i){return e[i.id]=i,e}),{})},TableViewModel.prototype.updateView=function(){this.localDispatcher.dispatch(m.TableEvents.UpdateView)},TableViewModel.prototype.createServerResult=function(e){this.serverResultsMap[e.id]=new w.ServerResult},TableViewModel.prototype.getServerResult=function(e){return this.serverResultsMap[e.id]||null},TableViewModel=e.__decorate([r.Module(),e.__param(0,n.Inject(t.ConfigurationService)),e.__param(1,n.Inject(o.EventDispatcherService)),e.__param(2,n.Inject(M.PaginationModule)),e.__metadata("design:paramtypes",[t.ConfigurationService,o.EventDispatcherService,M.PaginationModule])],TableViewModel)}();exports.TableViewModel=T;
