/*!
 * Banquette Ui v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@banquette/event/_cjs/prod/event-dispatcher"),t=require("@banquette/exception/_cjs/prod/exception.factory"),i=require("@banquette/exception/_cjs/prod/usage.exception"),n=require("@banquette/http/_cjs/prod/http-response"),r=require("@banquette/utils-misc/_cjs/prod/debounce"),o=require("@banquette/utils-string/_cjs/prod/format/replace-string-variables"),s=require("@banquette/utils-type/_cjs/prod/ensure-array"),d=require("@banquette/utils-type/_cjs/prod/ensure-boolean"),a=require("@banquette/utils-type/_cjs/prod/ensure-string"),l=require("@banquette/utils-type/_cjs/prod/is-array"),u=require("@banquette/utils-type/_cjs/prod/is-function"),c=require("@banquette/utils-type/_cjs/prod/is-object"),h=require("@banquette/utils-type/_cjs/prod/is-primitive"),f=require("@banquette/utils-type/_cjs/prod/is-scalar"),p=require("@banquette/utils-type/_cjs/prod/is-undefined"),b=require("../misc/remote/remote.module.js"),v=require("./constant.js"),w=require("./event/node-removed.event-arg.js"),y=require("./node.js"),N=function(){function HeadlessTreeViewModel(){var o,d=this;this.nodesIdentifier=null,this.nodesLabel=null,this.nodesChildren=null,this.nodesDisabled=null,this.nodesExpanded=null,this.unsubscribeFunctions=[],this.noChoiceAvailable=!0,this.searchBufferSlug="",this.rawNodes=new WeakMap,this.eventDispatcher=new e.EventDispatcher,this.fetchRemoteNodes=r.debounce((o={},function(e){if(void 0===e&&(e=null),d.remote.isApplicable){var r={};if(null!==e){if(!(e instanceof y.Node)){var a=d.getNodeById(e);if(null===a)throw new i.UsageException('No node has been found for id "'.concat(e,'".'));e=a}if(null===d.remoteNodeUrlParam)throw new i.UsageException('Cannot fetch contextualized nodes because no node url parameter has been defined. Please set a value to "remoteNodeUrlParam".');if(!e.identifier)throw new i.UsageException('Your node "'.concat(e.label,'" must have a unique identifier ')+"if you want to fetch remote children for it.");r[d.remoteNodeUrlParam]=String(e.identifier)}var l=e||d.viewData.root;p.isUndefined(o[l.id])||o[l.id].request.cancel(),l.remoteFetchError=null,l.remotePending=!0,l.remoteFetchStatus=v.NodeRemoteFetchStatus.Pending,o[l.id]=d.remote.send(null,r),o[l.id].promise.then((function(e){d.setNodes(s.ensureArray(e.result),l),l.remoteFetchStatus=v.NodeRemoteFetchStatus.Idle,l.fetched=!0})).catch((function(e){if(e instanceof n.HttpResponse){if(e.isCanceled)return;e=e.error}l.remoteFetchError=t.ExceptionFactory.EnsureException(e,"Unknown error.").message,l.remoteFetchStatus=v.NodeRemoteFetchStatus.Failed})).finally((function(){l.remotePending=!1,delete o[l.id]}))}}),0,!1),this.remote=new b.RemoteModule,this.remote.updateConfiguration({allowMultiple:!0}),this.viewData={root:null}}return HeadlessTreeViewModel.prototype.dispose=function(){for(var e=0,t=this.unsubscribeFunctions;e<t.length;e++){(0,t[e])()}},HeadlessTreeViewModel.prototype.setViewData=function(e){this.viewData=e,this.viewData.root||(this.viewData.root=this.createNode({},null))},HeadlessTreeViewModel.prototype.synchronize=function(e,t){void 0===t&&(t=null),null===t&&(t=this.viewData.root);e:for(var i=0,n=e;i<n.length;i++){var r=n[i],o=this.normalizeNode(r,t);if(null!==o){var s=this.extractNodeChildren(r);s.length&&this.synchronize(s,o);for(var d=0,a=t.children;d<a.length;d++){if(a[d].id===o.id)continue e}t.children.push(o),t.childrenVisibleCount++}}},HeadlessTreeViewModel.prototype.setNodes=function(e,t){void 0===t&&(t=null),null===t&&(t=this.viewData.root),t.children=[],t.childrenVisibleCount=0,this.synchronize(e,t)},HeadlessTreeViewModel.prototype.normalizeNode=function(e,t){if(e instanceof y.Node)return e;var i=this.createNode(e,t);i.identifier=this.extractNodeIdentifier(e),i.label=this.extractNodeLabel(e),i.disabled=this.extractNodeDisabledState(e);var n=this.extractNodeExpandedState(e);return null!==n&&(i.expanded=n),c.isObject(e)&&this.rawNodes.set(e,i),i},HeadlessTreeViewModel.prototype.expandNode=function(e){this.changeNodeChildrenVisibility(e,!0)},HeadlessTreeViewModel.prototype.collapseNode=function(e){this.changeNodeChildrenVisibility(e,!1)},HeadlessTreeViewModel.prototype.toggleNode=function(e){this.changeNodeChildrenVisibility(e,"inverse")},HeadlessTreeViewModel.prototype.removeNode=function(e){var t=this,i=e instanceof y.Node?e.id:e,search=function(e){for(var n=0;n<e.children.length;++n){if(e.children[n].id===i){var r=e.children[n];return e.children.splice(n,1),e.childrenVisibleCount=e.children.length,t.eventDispatcher.dispatch(v.HeadlessTreeViewModelEvents.NodeRemoved,new w.NodeRemovedEventArg(r)),!0}if(search(e.children[n]))return!0}return!1};return search(this.viewData.root)},HeadlessTreeViewModel.prototype.onNodeRemoved=function(e){return this.eventDispatcher.subscribe(v.HeadlessTreeViewModelEvents.NodeRemoved,e)},HeadlessTreeViewModel.prototype.changeNodeChildrenVisibility=function(e,t){var i=e instanceof y.Node?e:this.getNodeById(e);i&&!i.disabled&&(i.expanded=!0===t||"inverse"===t&&!i.expanded,i.expanded&&this.remoteNodeUrlParam&&!i.fetched&&this.fetchRemoteNodes(i))},HeadlessTreeViewModel.prototype.extractNodeLabel=function(e){if(u.isFunction(this.nodesLabel)){var t=this.nodesLabel(e);return f.isScalar(t)||console.warn('The "nodesLabel" function must return a scalar value, for:',e),String(t)}if(f.isScalar(e))return String(e);var i="(unknown label)";if(l.isArray(e))return e.length>0?e[0]:i;if(!c.isObject(e))return i;if(null!==this.nodesLabel){if(!p.isUndefined(e[this.nodesLabel]))return a.ensureString(e[this.nodesLabel]);if(this.nodesLabel.indexOf("{")>-1)return o.replaceStringVariables(this.nodesLabel,e,"{","}")}return console.warn('Please define how to resolve the label using the "nodesLabel" attribute, for:',e),i},HeadlessTreeViewModel.prototype.extractNodeChildren=function(e){return u.isFunction(this.nodesChildren)?s.ensureArray(this.nodesChildren(e)):l.isArray(e)?e.slice(1):c.isObject(e)&&this.nodesChildren?s.ensureArray(e[this.nodesChildren]):[]},HeadlessTreeViewModel.prototype.extractNodeDisabledState=function(e){return u.isFunction(this.nodesDisabled)?d.ensureBoolean(this.nodesDisabled(e)):!(!c.isObject(e)||!this.nodesDisabled)&&!!e[this.nodesDisabled]},HeadlessTreeViewModel.prototype.extractNodeExpandedState=function(e){return u.isFunction(this.nodesExpanded)?d.ensureBoolean(this.nodesExpanded(e)):c.isObject(e)&&this.nodesExpanded?!!e[this.nodesExpanded]:null},HeadlessTreeViewModel.prototype.extractNodeIdentifier=function(e){if(u.isFunction(this.nodesIdentifier)){var t=this.nodesIdentifier(e);if(h.isPrimitive(t))return t}if(f.isScalar(e))return e;if(c.isObject(e)){if(null!==this.nodesIdentifier&&!u.isFunction(this.nodesIdentifier)){if(!p.isUndefined(e[this.nodesIdentifier]))return e[this.nodesIdentifier];console.warn('Identifier property "'.concat(this.nodesIdentifier,'" not found, for:'),e)}}else console.warn('Unsupported node of type "'.concat(typeof e,'".'))},HeadlessTreeViewModel.prototype.createNode=function(e,t){var i=this.rawNodes.get(e);if(!p.isUndefined(i)){var n=this.getNodeById(i.id);if(null!==n)return n}var r=new y.Node(e,t);return r.fetched=!this.remote.isApplicable||null===this.remoteNodeUrlParam,r},HeadlessTreeViewModel.prototype.getNodeById=function(e,t){void 0===t&&(t=null),t||(t=this.viewData.root);for(var i=0,n=t.children;i<n.length;i++){var r=n[i];if(r.id===e)return r;var o=this.getNodeById(e,r);if(o)return o}return null},HeadlessTreeViewModel}();exports.HeadlessTreeViewModel=N;
