/*!
 * Banquette Validation v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@banquette/exception/_cjs/prod/usage.exception"),e=require("@banquette/utils-type/_cjs/prod/is-numeric"),i=require("@banquette/utils-type/_cjs/prod/is-promise-like"),n=require("@banquette/utils-type/_cjs/prod/is-type"),r=require("@banquette/utils-type/_cjs/prod/is-undefined"),a=require("./type/valid.js"),o=require("./utils.js"),s=require("./validation-context.js"),l=function(){function AbstractVirtualContainer(t,e,i){void 0===e&&(e=!0),this.validators=t,this.sequential=e,this.groups=i,this.skipped=!1}return Object.defineProperty(AbstractVirtualContainer.prototype,"length",{get:function(){return this.validators.length},enumerable:!1,configurable:!0}),AbstractVirtualContainer.prototype.has=function(e){var i=AbstractVirtualContainer.SplitPath(e),n=i[0];if(n<this.validators.length){if(1===i.length)return!r.isUndefined(this.validators[n]);var a=this.validators[n];if(!o.isValidatorContainer(a))throw new t.UsageException('A ValidatorContainerInterface is expected for the "'.concat(n,'" component of "').concat(e,'".'));return a.has(i.slice(1).join("/"))}return!1},AbstractVirtualContainer.prototype.remove=function(e){var i=AbstractVirtualContainer.SplitPath(e),n=i[0];if(n<this.validators.length){var r=this.validators[n];if(!o.isValidatorContainer(r))throw new t.UsageException('A ValidatorContainerInterface is expected for the "'.concat(n,'" component of "').concat(e,'".'));r.remove(i.slice(1).join("/"))}else if(i.length>1)throw new t.UsageException('Missing part "'.concat(n,'" of the path "').concat(e,"."))},AbstractVirtualContainer.prototype.set=function(e,i){var n=AbstractVirtualContainer.SplitPath(e),r=n[0];if(r<this.validators.length){if(1===n.length)return void(this.validators[r]=i);var s=this.validators[r];if(!o.isValidatorContainer(s))throw new t.UsageException('A ValidatorContainerInterface is expected for the "'.concat(r,'" component of "').concat(e,'".'));s.set(n.slice(1).join("/"),i)}else{if(n.length>1)throw new t.UsageException('Missing part "'.concat(r,'" of the path "').concat(e,"."));for(var l=this.validators.length;l<r;++l)this.validators.push(a.Valid());this.validators.push(i)}},AbstractVirtualContainer.prototype.validate=function(t,e){var r=this,a=-1,o=null,l=null,u=null,c=null,p=!1;this.skipped=!0;var h=s.ValidationContext.EnsureValidationContext(t,e),getOrCreateWrapper=function(){return null===o&&(o=new Promise((function(t,e){l=t,u=e}))),o},validateNext=function(){if(++a&&!r.onNextResult(h.result,a,p)||r.validators.length<=a)return null!==o&&l(),void r.onEnd(h,a);p=!0,h.shouldValidate(r.validators[a])&&(r.validators[a].validate(t,h),r.skipped=!1,p=!1),null!==h.result.localPromise&&h.result.localPromise!==c?(o=getOrCreateWrapper(),r.sequential&&h.result.localPromise.then(validateNext).catch(u),h.result.delayResponse(o),c=h.result.localPromise,r.sequential||validateNext()):validateNext()},d=this.onStart(h);return n.isType(d,i.isPromiseLike)?(o=getOrCreateWrapper(),h.result.delayResponse(d),d.then((function(t){t?validateNext():l()})).catch(u),h.result.delayResponse(o)):d&&validateNext(),h.result},AbstractVirtualContainer.prototype.onStart=function(t){return!0},AbstractVirtualContainer.prototype.onEnd=function(t,e){},AbstractVirtualContainer.SplitPath=function(i){var n=o.splitPath(i);if(e.isNumeric(n[0]))return n[0]=parseInt(n[0],10),n;throw new t.UsageException('Invalid path component "'.concat(n[0],'" in "').concat(i,'". An integer is expected.'))},AbstractVirtualContainer}();exports.AbstractVirtualContainer=l;
