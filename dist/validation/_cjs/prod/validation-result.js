/*!
 * Banquette Validation v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t,i=require("./_virtual/_tslib.js"),e=require("@banquette/exception/_cjs/prod/exception.factory"),a=require("@banquette/exception/_cjs/prod/usage.exception"),s=require("@banquette/utils-glob/_cjs/prod/constant"),l=require("@banquette/utils-glob/_cjs/prod/match-best"),n=require("@banquette/utils-misc/_cjs/prod/proxy"),o=require("@banquette/utils-string/_cjs/prod/format/replace-string-variables"),r=require("@banquette/utils-type/_cjs/prod/ensure-array"),u=require("@banquette/utils-type/_cjs/prod/is-undefined"),h=require("./mask/normalize-mask.js"),c=require("./violation.js");exports.ValidationResultStatus=void 0,(t=exports.ValidationResultStatus||(exports.ValidationResultStatus={}))[t.Waiting=0]="Waiting",t[t.Error=1]="Error",t[t.Valid=2]="Valid",t[t.Invalid=3]="Invalid",t[t.Canceled=4]="Canceled";var p=function(){function ValidationResult(t,i){void 0===i&&(i=null),this.path=t,this.parent=i,this.violations=[],this.children=[],this.promise=null,this.localPromise=null,this.errorDetail=null,this.cancelCallback=null,this.previousPromise=null,this.promiseResolve=null,this.promiseReject=null,this.setStatus(exports.ValidationResultStatus.Valid),this.parent&&this.parent.addChild(this)}return ValidationResult.prototype.addChild=function(t){if(t.parent!==this)throw new a.UsageException("Invalid child context assignation. The parent does not match the current context.");this.children.push(t)},ValidationResult.prototype.addViolation=function(t,i,e){void 0===e&&(e={}),i=o.replaceStringVariables(i,e),this.violations.push(new c.Violation(this.path,t,i)),this.status===exports.ValidationResultStatus.Valid&&(this.setStatus(exports.ValidationResultStatus.Invalid),this.parent&&this.getRoot().update())},ValidationResult.prototype.getViolationsArray=function(t){void 0===t&&(t=[]),t=h.normalizeMasks(t,this.path);var i=ValidationResult.ShouldMatch(this,t),e=[];if(i.fullyMatch&&(e=e.concat(this.violations)),i.fullyMatch||i.rawResult.pattern===s.MatchType.Partial)for(var a=0,l=this.children;a<l.length;a++){var n=l[a];e=e.concat(n.getViolationsArray(t))}return e},ValidationResult.prototype.getViolationsStringsArray=function(t){void 0===t&&(t=[]);for(var i=[],e=0,a=this.getViolationsArray(t);e<a.length;e++){var s=a[e];i.push("".concat(s.path,": ").concat(s.message||s.type))}return i},ValidationResult.prototype.getViolationsMap=function(t){void 0===t&&(t=[]);for(var i={},e=0,a=this.getViolationsArray(t);e<a.length;e++){var s=a[e];u.isUndefined(i[s.path])&&(i[s.path]=[]),i[s.path].push(s)}return i},ValidationResult.prototype.clearViolations=function(t){if(void 0===t&&(t=!0),this.violations=[],t)for(var i=0,e=this.children;i<e.length;i++){e[i].clearViolations(!0)}this.status===exports.ValidationResultStatus.Invalid&&this.setStatus(exports.ValidationResultStatus.Valid)},ValidationResult.prototype.getRoot=function(){return this.parent?this.parent.getRoot():this},ValidationResult.prototype.cancel=function(t){void 0===t&&(t=[]);var i=ValidationResult.ShouldMatch(this,t);if(null!==this.cancelCallback&&i.fullyMatch&&this.cancelCallback(),i.fullyMatch||i.rawResult.pattern===s.MatchType.Partial)for(var e=0,a=this.children;e<a.length;e++){a[e].cancel(t)}this.setStatus(exports.ValidationResultStatus.Canceled)},ValidationResult.prototype.onReady=function(){return i.__awaiter(this,void 0,void 0,(function(){return i.__generator(this,(function(t){switch(t.label){case 0:return null===this.promise?[3,2]:[4,this.promise];case 1:return t.sent(),[2,this];case 2:return[2,this]}}))}))},ValidationResult.prototype.update=function(){if(this.status!==exports.ValidationResultStatus.Waiting){for(var t=!this.violations.length,i=0,e=this.children;i<e.length;i++){var a=e[i];if(a.update(),a.error)return void this.setStatus(exports.ValidationResultStatus.Error);a.valid||(t=!1)}this.setStatus(t?exports.ValidationResultStatus.Valid:exports.ValidationResultStatus.Invalid)}},ValidationResult.prototype.delayResponse=function(t,i){var e=this;if(void 0===i&&(i=null),this.setStatus(exports.ValidationResultStatus.Waiting),null===this.promise&&(this.promise=new Promise((function(t,i){e.promiseResolve=t,e.promiseReject=i})).then((function(){return e.canceled||(e.setStatus(e.violations.length>0?exports.ValidationResultStatus.Invalid:exports.ValidationResultStatus.Valid),e.update()),e.cleanupAsync(),e})).catch((function(t){return e.fail(t),e}))),this.parent&&this.parent.delayResponse(this.promise),null===this.cancelCallback)this.cancelCallback=i;else if(null!==i){var a=this.cancelCallback;this.cancelCallback=function(){a(),i()}}var s=(null===this.localPromise?t:Promise.all([this.localPromise,t])).then((function(){return s===e.previousPromise&&e.promiseResolve(e),e.cancelCallback=null,e.localPromise=null,e})).catch(n.proxy(this.promiseReject,this));this.localPromise=s,this.previousPromise=s},ValidationResult.prototype.fail=function(t){this.status!==exports.ValidationResultStatus.Canceled&&(this.errorDetail=e.ExceptionFactory.EnsureException(t),this.setStatus(exports.ValidationResultStatus.Error)),null!==this.promiseReject&&this.promiseReject(t),this.cleanupAsync()},ValidationResult.prototype.setStatus=function(t){this.status=t,this.valid=this.status===exports.ValidationResultStatus.Valid,this.invalid=this.status===exports.ValidationResultStatus.Invalid,this.error=this.status===exports.ValidationResultStatus.Error,this.waiting=this.status===exports.ValidationResultStatus.Waiting,this.canceled=this.status===exports.ValidationResultStatus.Canceled},ValidationResult.prototype.cleanupAsync=function(){this.cancelCallback=null,this.promiseResolve=null,this.promiseReject=null,this.previousPromise=null,this.promise=null},ValidationResult.ShouldMatch=function(t,i){var e=r.ensureArray(i),a=e.length?l.matchBest(e,t.path):{pattern:s.MatchType.Full,tags:s.MatchType.Full};return{rawResult:a,fullyMatch:a.pattern===s.MatchType.Full&&a.tags>=s.MatchType.Partial}},ValidationResult}();exports.ValidationResult=p;
