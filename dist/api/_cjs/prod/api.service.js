/*!
 * Banquette Api v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./_virtual/_tslib.js"),t=require("@banquette/config/_cjs/prod/config/configuration.service"),i=require("@banquette/dependency-injection/_cjs/prod/decorator/inject.decorator"),r=require("@banquette/dependency-injection/_cjs/prod/decorator/service.decorator"),n=require("@banquette/event/_cjs/prod/event-dispatcher.service"),s=require("@banquette/exception/_cjs/prod/usage.exception"),o=require("@banquette/http/_cjs/prod/constants"),p=require("@banquette/http/_cjs/prod/http.service"),u=require("@banquette/model/_cjs/prod/model-metadata.service"),a=require("@banquette/utils-misc/_cjs/prod/proxy"),d=require("@banquette/utils-object/_cjs/prod/get-object-value"),c=require("@banquette/utils-type/_cjs/prod/is-array"),l=require("@banquette/utils-type/_cjs/prod/is-null-or-undefined"),h=require("@banquette/utils-type/_cjs/prod/is-promise-like"),v=require("@banquette/utils-type/_cjs/prod/is-string"),q=require("@banquette/utils-type/_cjs/prod/is-undefined"),f=require("./api-endpoint.js"),m=require("./api-endpoint-storage.service.js"),g=require("./api-request.builder.js"),A=require("./config.js"),b=require("./constant.js"),S=require("./event/api-before-response.event.js"),R=require("./event/api-request.event.js"),y=require("./event/api-response.event.js");require("./listener/request-model-transformer.listener.js"),require("./listener/response-model-transformer.listener.js");var E=function(){function ApiService(e,t,i,r,n){this.configuration=e,this.eventDispatcher=t,this.http=i,this.modelMetadata=r,this.endpointsStorage=n,this.generatedEndpoints={},this.knownRequests={};var s=this.configuration.get(A.ApiConfigurationSymbol);this.eventDispatcher.subscribe(o.HttpEvents.BeforeRequest,a.proxy(this.onBeforeRequest,this),s.eventsPriorities.beforeRequest,[b.ApiTag]),this.eventDispatcher.subscribe(o.HttpEvents.BeforeResponse,a.proxy(this.onBeforeResponse,this),s.eventsPriorities.beforeResponse,[b.ApiTag]),this.eventDispatcher.subscribe(o.HttpEvents.RequestSuccess,a.proxy(this.onRequestSuccess,this),s.eventsPriorities.requestSuccess,[b.ApiTag]),this.eventDispatcher.subscribe(o.HttpEvents.RequestFailure,a.proxy(this.onRequestFailure,this),s.eventsPriorities.requestFailure,[b.ApiTag])}return ApiService.prototype.build=function(){return new g.ApiRequestBuilder},ApiService.prototype.get=function(e,t,i){return this.send(this.build().method(o.HttpMethod.GET).endpoint(e).model(t||null).params(i||{}).getRequest())},ApiService.prototype.post=function(e,t,i,r){return this.send(this.build().method(o.HttpMethod.POST).endpoint(e).model(t||null).payload(i).params(r||{}).getRequest())},ApiService.prototype.put=function(e,t,i,r){return this.send(this.build().method(o.HttpMethod.PUT).endpoint(e).model(t||null).payload(i).params(r||{}).getRequest())},ApiService.prototype.patch=function(e,t,i,r){return this.send(this.build().method(o.HttpMethod.PATCH).endpoint(e).model(t||null).payload(i).params(r||{}).getRequest())},ApiService.prototype.delete=function(e,t,i){return this.send(this.build().method(o.HttpMethod.DELETE).endpoint(e).model(t||null).params(i||{}).getRequest())},ApiService.prototype.send=function(e,t,i,r){var n;if(v.isString(e)){var o=this.build();o.endpoint(e),q.isUndefined(t)||o.model(t),o.payload(i),o.params(r||{}),n=o.getRequest()}else n=e;var p=null;if(null!==n.endpoint){var u=null!==n.model?this.modelMetadata.resolveAlias(c.isArray(n.model)?n.model[0]:n.model):null;p=this.endpointsStorage.getEndpoint(n.endpoint,u)}if(null===p){if(l.isNullOrUndefined(n.url)||!n.url.length)throw new s.UsageException("You must define either an endpoint or a url.");var a=n.method+":"+n.url;q.isUndefined(this.generatedEndpoints[a])&&(this.generatedEndpoints[a]=new f.ApiEndpoint({url:n.url,method:n.method,params:{"*":null}})),p=this.generatedEndpoints[a]}var d=p.buildRequest(n.payload,n.toEndpointOverride());return d.tags.push(b.ApiTag),d.extras=Object.assign(d.extras||{},{_apiRequestId:n.id}),this.knownRequests[n.id]=n,this.http.send(d)},ApiService.prototype.onBeforeRequest=function(e){return this.dispatchEvent(b.ApiEvents.BeforeRequest,e,R.ApiRequestEvent)},ApiService.prototype.onBeforeResponse=function(e){return this.dispatchEvent(b.ApiEvents.BeforeResponse,e,S.ApiBeforeResponseEvent)},ApiService.prototype.onRequestSuccess=function(e){return this.dispatchEventAndDispose(b.ApiEvents.RequestSuccess,e,y.ApiResponseEvent)},ApiService.prototype.onRequestFailure=function(e){return this.dispatchEventAndDispose(b.ApiEvents.RequestFailure,e,y.ApiResponseEvent)},ApiService.prototype.dispatchEvent=function(e,t,i){var r=this.httpToApiRequest(t.request);if(r){var n=this.eventDispatcher.dispatchWithErrorHandling(e,new i(r,t),!0,t.request.tags).promise;return null!==n?new Promise((function(e){n.finally(e)})):void 0}},ApiService.prototype.dispatchEventAndDispose=function(e,t,i){var r=this,n=this.dispatchEvent(e,t,i),clean=function(){var e=r.httpToApiRequest(t.request);e&&!q.isUndefined(r.knownRequests[e.id])&&delete r.knownRequests[e.id]};return!q.isUndefined(n)&&h.isPromiseLike(n)?n.finally(clean):clean(),n},ApiService.prototype.httpToApiRequest=function(e){var t=d.getObjectValue(e.extras,"_apiRequestId",0);return q.isUndefined(this.knownRequests[t])?(console.warn('A request that doesn\'t originate from the ApiService as been tagged with "ApiTag".'),null):this.knownRequests[t]},ApiService=e.__decorate([r.Service(),e.__param(0,i.Inject(t.ConfigurationService)),e.__param(1,i.Inject(n.EventDispatcherService)),e.__param(2,i.Inject(p.HttpService)),e.__param(3,i.Inject(u.ModelMetadataService)),e.__param(4,i.Inject(m.ApiEndpointStorageService)),e.__metadata("design:paramtypes",[t.ConfigurationService,n.EventDispatcherService,p.HttpService,u.ModelMetadataService,m.ApiEndpointStorageService])],ApiService)}();exports.ApiService=E;
