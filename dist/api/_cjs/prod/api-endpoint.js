/*!
 * Banquette Api v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@banquette/exception/_cjs/prod/usage.exception"),t=require("@banquette/http/_cjs/prod/constants"),r=require("@banquette/http/_cjs/prod/decoder/json.decoder"),i=require("@banquette/http/_cjs/prod/encoder/json.encoder"),n=require("@banquette/http/_cjs/prod/http-request.builder"),a=require("@banquette/utils-object/_cjs/prod/extend"),s=require("@banquette/utils-type/_cjs/prod/ensure-object"),u=require("@banquette/utils-type/_cjs/prod/ensure-string"),o=require("@banquette/utils-type/_cjs/prod/is-array"),l=require("@banquette/utils-type/_cjs/prod/is-function"),p=require("@banquette/utils-type/_cjs/prod/is-object"),d=require("@banquette/utils-type/_cjs/prod/is-string"),h=require("@banquette/utils-type/_cjs/prod/is-type"),y=require("@banquette/utils-type/_cjs/prod/is-undefined"),c=require("./api-endpoint-override.js"),m=require("./exception/invalid-parameter.exception.js"),q=require("./exception/missing-required-parameter.exception.js"),f=require("./exception/unsupported-parameters.exception.js"),b=function(){function ApiEndpoint(e){this.timeout=null,this.withCredentials=!1,this.mimeType=null,this.retry=null,this.retryDelay=null,this.priority=null,this.tags=[],this.extras={},d.isString(e)&&(e={url:e}),this.url=this.normalizeUrl(e.url),this.method=e.method||t.HttpMethod.GET,this.headers=s.ensureObject(e.headers),this.params=a.extend(this.buildParametersFromUrl(this.url),this.normalizeParameters(e.params),!0),this.payloadType=e.payloadType||i.PayloadTypeJson,this.responseType=e.responseType||r.ResponseTypeJson}return ApiEndpoint.prototype.buildRequest=function(e,r){var i=r instanceof c.ApiEndpointOverride?r:null,swap=function(e,t){return null===i||y.isUndefined(i[e])?t:i[e]},a=swap("params",null===i?r:{});if(p.isObject(e))for(var s=0,u=Object.keys(e);s<u.length;s++){var o=u[s];!y.isUndefined(this.params[o])&&y.isUndefined(a[o])&&(a[o]=e[o])}var l=this.sortAndValidateParameters(a);return(new n.HttpRequestBuilder).url(this.url).params(l.url,t.UrlParameterType.Url).params(l.query,t.UrlParameterType.Query).method(swap("method",this.method)).payload(e,swap("payloadType",this.payloadType)).responseType(swap("responseType",this.responseType)).timeout(swap("timeout",this.timeout)).withCredentials(swap("withCredentials",this.withCredentials)).mimeType(swap("mimeType",this.mimeType)).retry(swap("retry",this.retry)).retryDelay(swap("retryDelay",this.retryDelay)).headers(swap("headers",this.headers)).tags(swap("tags",this.tags)).extras(swap("extras",this.extras)).getRequest()},ApiEndpoint.prototype.buildParametersFromUrl=function(e){for(var t,r={},i=new RegExp("{\\s*([a-z0-9*._-]+)\\s*}","gi");null!==(t=i.exec(e));)o.isArray(t)&&t.length>1&&(r[t[1]]={url:!0,required:!0,defaultValue:void 0,validator:null});return r},ApiEndpoint.prototype.sortAndValidateParameters=function(t){for(var r=Object.assign({},t),i={url:{},query:{}},processItem=function(t,r,i){if(y.isUndefined(r)){if(y.isUndefined(i.defaultValue)){if(i.required)throw new q.MissingRequiredParameterException(t);return}r=i.defaultValue}if(r=u.ensureString(r),null!==i.validator){var n=i.validator.validate(r);if(n.waiting)throw new e.UsageException("Asynchronous validators are not supported in parameters.");if(!n.valid)throw new m.InvalidParameterException(t,n.getViolationsArray().join(", "))}return r},n=null,a=0,s=Object.keys(this.params);a<s.length;a++){if("*"!==(c=s[a])){var o=this.params[c],l=processItem(c,r[c],o);y.isUndefined(l)||(i[o.url?"url":"query"][c]=encodeURIComponent(l),delete r[c])}else n=this.params[c]}var p=Object.keys(r);if(p.length>0){if(null===n)throw new f.UnsupportedParametersException(p,"The following parameters have not been defined for this endpoint: ".concat(p.join(", "),".\n                    You can use a wildcard parameter (name it '*') to accept any parameter."));for(var d=0,h=Object.keys(r);d<h.length;d++){var c;l=processItem(c=h[d],r[c],n);y.isUndefined(l)||(i.query[c]=l)}}return i},ApiEndpoint.prototype.normalizeUrl=function(e){return e.length?("/"===(e=e.replace(/\\/g,"/").replace(/([^:])(\/\/+)/g,"$1/"))[0]||e.match(/^[a-z]+:\/\//i)||(e="//"+e),e):"/"},ApiEndpoint.prototype.normalizeParameters=function(e){if(y.isUndefined(e))return{};for(var t={},r=0,i=Object.keys(e);r<i.length;r++){var n=i[r],s=e[n];!0===s?s={required:!0}:null===s?s={}:h.isType(s,p.isObject)&&h.isType(s,(function(e){return l.isFunction(e.validate)}))&&(s={validator:s});var u=null!==this.url.match(new RegExp("{".concat(n,"}")));y.isUndefined(s.required)&&(s.required=u),t[n]=a.extend({},[{required:!1,defaultValue:void 0,validator:null},s,{url:u}])}return t},ApiEndpoint}();exports.ApiEndpoint=b;
