/*!
 * Banquette Api v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("../_virtual/_tslib.js"),r=require("@banquette/dependency-injection/_cjs/prod/decorator/inject-lazy.decorator"),t=require("@banquette/dependency-injection/_cjs/prod/decorator/inject.decorator"),n=require("@banquette/dependency-injection/_cjs/prod/decorator/module.decorator"),o=require("@banquette/exception/_cjs/prod/usage.exception"),a=require("@banquette/http/_cjs/prod/http-response"),s=require("@banquette/model/_cjs/prod/constants"),i=require("@banquette/model/_cjs/prod/model-metadata.service"),u=require("@banquette/model/_cjs/prod/model-transform-metadata.service"),l=require("@banquette/model/_cjs/prod/model.factory.service"),p=require("@banquette/model/_cjs/prod/transformer/transform-context"),c=require("@banquette/model/_cjs/prod/transformer/transform-pipeline"),d=require("@banquette/model/_cjs/prod/transformer/transform.service"),m=require("@banquette/model/_cjs/prod/transformer/type/root/pojo"),f=require("@banquette/utils-type/_cjs/prod/is-array"),v=require("@banquette/utils-type/_cjs/prod/is-undefined"),y=require("@banquette/validation/_cjs/prod/type/not-empty"),q=require("../api-endpoint-storage.service.js"),T=Symbol("http"),b=function(m){function HttpTransformer(e,r,t,n,o){var a=m.call(this,e,r,t)||this;return a.modelMetadata=e,a.transformMetadata=r,a.modelFactory=t,a.endpointStorage=n,a.transformService=o,a}return e.__extends(HttpTransformer,m),HttpTransformer.prototype.getTransformerSymbol=function(){return T},HttpTransformer.prototype.doTransform=function(e,r){if(null!==e.parent&&e.parent.type===T)return m.prototype.doTransform.call(this,e,r);var t=e.getValidatedExtra({endpoint:[y.NotEmpty(),null],parameters:[null,{}]}),n=t.endpoint,o=t.parameters,a=this.endpointStorage.getEndpoint(n,e.ctor);m.prototype.doTransform.call(this,e,r);var respond=function(r,t){for(var n=0,a=Object.keys(t);n<a.length;n++){var s=a[n];!v.isUndefined(r.params[s])&&v.isUndefined(o[s])&&(o[s]=t[s])}return e.result.setResult(r.buildRequest(t,o)),e.result},s=e.result.localPromise;return null===s?respond(a,e.result.result):(e.result.delayResponse(new Promise((function(r,t){s.then((function(){r(respond(a,e.result.result))})).catch(t)}))),e.result)},HttpTransformer.prototype.doTransformInverse=function(e,r,t){var n=this;if(null!==e.parent&&e.parent.type===T)return m.prototype.doTransformInverse.call(this,e,r,t);if(!(e.value instanceof a.HttpResponse))throw new o.UsageException("The inverse transform of HttpTransformer expect an HttpResponse.");var s=null,i=null,delayResponse=function(){e.result.delayResponse(new Promise((function(e,r){s=e,i=r})))},transformResponse=function(){var r=f.isArray(e.value.result),t=r?e.value.result:[e.value.result],o=[],a=0,next=function(){if(a>=t.length)return o.length>0&&e.result.setResult(r?o:o[0]),void(null!==s&&s());!function(r,t){var o=n.modelFactory.create(e.ctor,e),a=new p.TransformContext(e,e.type,e.ctor,r,e.property,e.extra),i=new c.TransformPipeline(a.result,n.getTransformableProperties(e)),u=m.prototype.doTransformInverse.call(n,a,o,i);null!==u.promise?(null===s&&delayResponse(),u.promise.then((function(){t(u)}))):t(u)}(t[a++],(function(r){if(r.error)return e.result.fail(r.errorDetail),void(null!==i&&i(r.errorDetail));o.push(r.result),next()}))};next()};return e.value.isPending&&null!==e.value.promise?(delayResponse(),e.value.promise.then(transformResponse)):transformResponse(),e.result},HttpTransformer=e.__decorate([n.Module(s.ModelTransformerTag),e.__param(0,t.Inject(i.ModelMetadataService)),e.__param(1,t.Inject(u.ModelTransformMetadataService)),e.__param(2,t.Inject(l.ModelFactoryService)),e.__param(3,t.Inject(q.ApiEndpointStorageService)),e.__param(4,r.InjectLazy((function(){return d.TransformService}))),e.__metadata("design:paramtypes",[i.ModelMetadataService,u.ModelTransformMetadataService,l.ModelFactoryService,q.ApiEndpointStorageService,d.TransformService])],HttpTransformer)}(m.PojoTransformer);exports.HttpTransformer=b,exports.HttpTransformerSymbol=T;
