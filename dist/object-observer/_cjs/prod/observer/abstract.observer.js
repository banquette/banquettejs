/*!
 * Banquette ObjectObserver v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@banquette/event/_cjs/prod/event-dispatcher"),e=require("@banquette/exception/_cjs/prod/usage.exception"),r=require("@banquette/utils-glob/_cjs/prod/constant"),s=require("@banquette/utils-glob/_cjs/prod/match"),n=require("@banquette/utils-misc/_cjs/prod/proxy"),i=require("@banquette/utils-type/_cjs/prod/is-object"),a=require("@banquette/utils-type/_cjs/prod/is-undefined"),o=require("../constant.js"),u=require("../event/mutation.event.js"),c=require("../event/mutations-collection.event.js"),b=require("../mutation.js"),h=require("../observer.factory.js"),p=require("../utils.js"),v=0,l=function(){function AbstractObserver(t,e,r){void 0===r&&(r=null);var s,i=this;this.target=e,this.id=++v,this.eventDispatcher=null,this.subscribeCounts={},this.mutationsQueue=[],this.parents=[],this.queueNotify=(s=!1,function(t){i.mutationsQueue.push(t),s||(s=!0,queueMicrotask((function(){null!==i.eventDispatcher&&i.eventDispatcher.dispatchWithErrorHandling(o.ObserverEvents.ChangedAsync,new c.MutationsCollectionEvent(i.mutationsQueue)),i.mutationsQueue=[],s=!1})))}),null!==r&&this.parents.push({name:t,parent:r}),this.proxy=new Proxy(e,{get:n.proxy(this.get,this),set:n.proxy(this.set,this),deleteProperty:n.proxy(this.deleteProperty,this)}),this.observe(e)}return AbstractObserver.GetPriority=function(){return 0},AbstractObserver.Supports=function(t){throw new e.UsageException("`AbstractObserver::Supports()` must be overridden.")},AbstractObserver.prototype.subscribe=function(t,e,r){var s=this;return void 0===e&&(e=null),void 0===r&&(r=null),this.doSubscribe(o.ObserverEvents.ChangedSync,(function(n){s.matchMutation(n.mutation,e,r)&&t(n)}))},AbstractObserver.prototype.subscribeAsync=function(t,e,r){var s=this;return void 0===e&&(e=null),void 0===r&&(r=null),this.doSubscribe(o.ObserverEvents.ChangedAsync,(function(n){var i=s.filterMutations(n.mutations,e,r);i.length&&t(new c.MutationsCollectionEvent(i))}))},AbstractObserver.prototype.observe=function(t){},AbstractObserver.prototype.get=function(t,e){return e===o.ObserverInstance?this:t[e]},AbstractObserver.prototype.set=function(t,e,r){var s=t[e],n=this.observeProperty(String(e),r);return r!==s&&(this.detachValue(s),t[e]=n,this.notify(new b.Mutation(a.isUndefined(s)?o.MutationType.Insert:o.MutationType.Update,[String(e)],s,n,this.target))),!0},AbstractObserver.prototype.deleteProperty=function(t,e){var r=t[e];return this.detachValue(r),delete t[e],this.notify(new b.Mutation(o.MutationType.Delete,[String(e)],r,void 0,this.target)),!0},AbstractObserver.prototype.addParent=function(t,e){this.parents.push({parent:t,name:e})},AbstractObserver.prototype.updateName=function(t,e){for(var r=0,s=this.parents;r<s.length;r++){var n=s[r];n.parent===e&&(n.name=t)}},AbstractObserver.prototype.detach=function(t){for(var e=0;e<this.parents.length;++e)this.parents[e].parent===t&&this.parents.splice(e--,1)},AbstractObserver.prototype.notify=function(t){if(this.parents.length>0)for(var e=0,r=this.parents;e<r.length;e++){var s=r[e];s.parent.notify(new b.Mutation(t.type,[s.name].concat(t.pathParts),t.oldValue,t.newValue,t.target))}null!==this.eventDispatcher&&(this.subscribeCounts[o.ObserverEvents.ChangedSync]&&this.eventDispatcher.dispatchWithErrorHandling(o.ObserverEvents.ChangedSync,new u.MutationEvent(t)),this.subscribeCounts[o.ObserverEvents.ChangedAsync]&&this.queueNotify(t))},AbstractObserver.prototype.observeProperty=function(t,e){if(i.isObject(e)){var r=p.extractObserver(e);if(r instanceof AbstractObserver)return r.id!==this.id&&r.addParent(this,t),e}return h.ObserverFactory.Supports(e)?h.ObserverFactory.Create(e,this,t).proxy:e},AbstractObserver.prototype.detachValue=function(t){if(i.isObject(t)){var e=p.extractObserver(t);e instanceof AbstractObserver&&e!==this&&e.detach(this)}},AbstractObserver.prototype.matchMutation=function(t,e,n){if(null!==e&&(e&t.type)!==t.type)return!1;if(null!==n&&s.match(n,t.path).pattern!==r.MatchType.Full)return!1;return!0},AbstractObserver.prototype.filterMutations=function(t,e,r){var s=this;return t.filter((function(t){return s.matchMutation(t,e,r)}))},AbstractObserver.prototype.doSubscribe=function(e,r){var s,n=this;null===this.eventDispatcher&&(this.eventDispatcher=new t.EventDispatcher,this.subscribeCounts=((s={})[o.ObserverEvents.ChangedSync]=0,s[o.ObserverEvents.ChangedAsync]=0,s));var i=!1,a=this.eventDispatcher.subscribe(e,r);return this.subscribeCounts[e]++,function(){i||(n.subscribeCounts[e]--,a()),i=!0}},AbstractObserver}();exports.AbstractObserver=l;
