/*!
 * Banquette Event v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@banquette/exception/_cjs/prod/exception.factory"),t=require("@banquette/utils-array/_cjs/prod/array-intersect"),r=require("@banquette/utils-misc/_cjs/prod/not"),i=require("@banquette/utils-object/_cjs/prod/get-symbol-description"),n=require("@banquette/utils-type/_cjs/prod/ensure-array"),s=require("@banquette/utils-type/_cjs/prod/is-null-or-undefined"),a=require("@banquette/utils-type/_cjs/prod/is-type"),o=require("@banquette/utils-type/_cjs/prod/is-undefined"),u=require("./dispatch-result.js"),c=require("./event-arg.js"),l=Symbol(),p=function(){function EventDispatcher(){this.subscribers={},this.queue={}}return EventDispatcher.prototype.subscribe=function(e,t,r,i,n){var s=this;void 0===r&&(r=0),void 0===i&&(i=null),void 0===n&&(n=[]);var a,u=this.subscribers[e];o.isUndefined(u)&&(this.subscribers[e]=u=[]),n.length||n.push(l);var c,p=u.length,h={callback:t,priority:r,filteringTags:i,propagationTags:n};for(a=0;a<p&&u[a].priority>=r;++a);return a>=p?u.push(h):u.splice(a,0,h),o.isUndefined(c=this.queue[e])||(delete this.queue[e],window.setTimeout((function(){for(var t=0,r=c;t<r.length;t++){var i=r[t];s.dispatchWithErrorHandling(e,i.arg)}}))),function(){for(var e=0;e<u.length;++e)if(u[e].callback===t){u.splice(e,1);break}}},EventDispatcher.prototype.dispatch=function(e,i,n,o){void 0===n&&(n=!1),void 0===o&&(o=[]);for(var l=a.isType(i,r.Not(s.isNullOrUndefined))?i:new c.EventArg,p=[],h=[].concat(this.subscribers[e]||[]),d=new u.DispatchResult,g=-1,next=function(){if(++g>=h.length)return!1;var e=h[g];if(g>0&&l.propagationStopped&&(Array.prototype.push.apply(p,h[g-1].propagationTags),l.restorePropagation()),!t.arrayIntersect(p,e.propagationTags).length&&(null===e.filteringTags||!o.length&&!e.filteringTags.length||t.arrayIntersect(o,e.filteringTags).length>0))try{var r=e.callback(l);return d.registerCall({subscriber:e,result:r,event:l}),!n||null===d.localPromise||(d.localPromise.then(next),!1)}catch(e){return d.fail(e),!1}return!0},f=h.length>0;f;)f=next();return i&&i.defaultPrevented&&d.preventDefault(),d},EventDispatcher.prototype.dispatchWithErrorHandling=function(t,r,n,s){void 0===n&&(n=!1),void 0===s&&(s=[]);var a=this.dispatch(t,r,n,s),handleError=function(r){var n='Dispatch failed for Symbol("'.concat(i.getSymbolDescription(t),'"). Reason: ').concat(e.ExceptionFactory.EnsureException(r).message);console.error(n,r)};return a.promise?a.promise.catch(handleError):a.error&&handleError(a.errorDetail),a},EventDispatcher.prototype.dispatchSafe=function(e,t){var r;if(t=s.isNullOrUndefined(t)?new c.EventArg:t,(this.subscribers[e]||[]).length>0)this.dispatchWithErrorHandling(e,t);else{var i=n.ensureArray(this.queue[e]);i.push({event:t}),Object.assign(this.queue,((r={})[e]=i,r))}},EventDispatcher.prototype.clear=function(e){s.isNullOrUndefined(e)?this.subscribers={}:this.subscribers[e]=[]},EventDispatcher}();exports.EventDispatcher=p;
