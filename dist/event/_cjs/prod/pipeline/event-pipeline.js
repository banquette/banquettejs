/*!
 * Banquette Event v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@banquette/utils-object/_cjs/prod/clone-deep"),n=require("@banquette/utils-type/_cjs/prod/ensure-array"),r=require("@banquette/utils-type/_cjs/prod/is-array"),t=require("@banquette/utils-type/_cjs/prod/is-integer"),i=require("@banquette/utils-type/_cjs/prod/is-object"),s=require("@banquette/utils-type/_cjs/prod/is-string"),u=require("@banquette/utils-type/_cjs/prod/is-symbol"),o=require("@banquette/utils-type/_cjs/prod/is-type"),c=require("@banquette/utils-type/_cjs/prod/is-undefined"),l=require("../constant.js"),a=require("../dispatch-result.js"),p=require("../event-dispatcher.js"),q=require("./sequence-context.js"),h=function(){function EventPipeline(){this.sequences={},this.dispatcher=new p.EventDispatcher,this.unsubscribeFunctions={}}return EventPipeline.prototype.add=function(e,a,p){var q;void 0===a&&(a=l.DefaultSequenceName),void 0===p&&(p=l.SequenceErrorBasicBehavior.StopAll),(s.isString(e)||u.isSymbol(e)||o.isType(e,(function(e){return i.isObject(e)&&(!c.isUndefined(e.event)||!c.isUndefined(e.sequences))})))&&(e=[e]),r.isArray(e)&&((q={})[a]=e,e=q);for(var h=e,v=0,f=Object.keys(h);v<f.length;v++){var d=f[v];c.isUndefined(this.sequences[d])&&(this.sequences[d]={items:[],onError:p});for(var b=0,y=n.ensureArray(h[d]);b<y.length;b++){var E=y[b];s.isString(E)&&(E=[E]),u.isSymbol(E)&&(E={event:E});var S=E.onError||p;this.sequences[d].items.push({event:E.event||null,sequences:r.isArray(E)?E:E.sequences||null,priority:E.priority||0,onError:t.isInteger(S)?S:n.ensureArray(S)})}this.sequences[d].items.sort((function(e,n){return n.priority-e.priority}))}return this},EventPipeline.prototype.remove=function(e,r,t){if(void 0===r&&(r=l.DefaultSequenceName),void 0===t&&(t=!0),c.isUndefined(this.sequences[r]))return this;for(var i=0,o=n.ensureArray(e);i<o.length;i++){for(var a=o[i],p=0;p<this.sequences[r].items.length;++p){var q=this.sequences[r].items[p];(u.isSymbol(a)&&q.event===a||s.isString(a)&&null!==q.sequences&&q.sequences.indexOf(a)>-1)&&this.sequences[r].items.splice(p--,1)}t&&this.unsubscribeIfUnused(a)}return this},EventPipeline.prototype.subscribe=function(e,n,r){return c.isUndefined(this.unsubscribeFunctions[e])&&(this.unsubscribeFunctions[e]=[]),this.unsubscribeFunctions[e].push(this.dispatcher.subscribe(e,n,r)),this},EventPipeline.prototype.start=function(e){return void 0===e&&(e=l.DefaultSequenceName),this.runSequences(n.ensureArray(e))},EventPipeline.prototype.stop=function(){},EventPipeline.prototype.dispose=function(){this.sequences={},this.unsubscribeFunctions={},this.dispatcher.clear()},EventPipeline.prototype.runSequences=function(n,r){var t=this,i=-1,s=new a.DispatchResult(c.isUndefined(r)?null:r.result);return function(){var u=++i<n.length?n[i]:null;if(!u||c.isUndefined(t.sequences[u]))return s;var o=new q.SequenceContext(u,s,r||null),l=t.runSequence(e.cloneDeep(t.sequences[u]),o);null!==l.promise&&s.delayResponse(l.promise)}(),s},EventPipeline.prototype.runSequence=function(e,n){var t=this,i=-1,s=new a.DispatchResult(n.result),onError=function(t,i,u){i.onError===l.SequenceErrorBasicBehavior.Undefined&&(i.onError=e.onError||l.DefaultSequenceErrorBehavior),r.isArray(i.onError)?dispatchItem({event:null,sequences:i.onError,priority:0,onError:l.SequenceErrorBasicBehavior.Undefined},u):(i.onError===l.SequenceErrorBasicBehavior.StopSequence?n.stopSequence(!1):i.onError===l.SequenceErrorBasicBehavior.StopAll&&n.stopSequence(!0),s.fail(t),u())},dispatchItem=function(e,r){try{var i=null;null!==e.event?(n.event=e.event,(i=t.dispatcher.dispatch(e.event,n,!0)).error&&s.fail(i.errorDetail)):null!==e.sequences&&(i=t.runSequences(e.sequences,n)),null!==i&&null!==i.promise?(s.delayResponse(i.promise),s.localPromise.then((function(){i.error?onError(i.errorDetail,e,r):r()}))):r()}catch(n){onError(n,e,r)}},next=function(){if(!(++i>=e.items.length||n.sequenceStopped)){var r=e.items[i];dispatchItem(r,next)}};return next(),s},EventPipeline.prototype.unsubscribeIfUnused=function(e){if(!c.isUndefined(this.unsubscribeFunctions[e])&&this.unsubscribeFunctions[e].length)e:for(var n=0,r=Object.keys(this.sequences);n<r.length;n++){for(var t=r[n],i=0,s=this.sequences[t].items;i<s.length;i++){if(s[i].event===e)continue e}for(var u=0,o=this.unsubscribeFunctions[e];u<o.length;u++){(0,o[u])()}delete this.unsubscribeFunctions[e]}},EventPipeline}();exports.EventPipeline=h;
