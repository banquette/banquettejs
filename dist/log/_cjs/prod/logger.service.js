/*!
 * Banquette Log v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./_virtual/_tslib.js"),t=require("@banquette/config/_cjs/prod/config/configuration.service"),i=require("@banquette/dependency-injection/_cjs/prod/decorator/inject.decorator"),r=require("@banquette/dependency-injection/_cjs/prod/decorator/service.decorator"),o=require("@banquette/fingerprint/_cjs/prod/fingerprint.service"),n=require("@banquette/storage/_cjs/prod/storage.service"),s=require("@banquette/utils-misc/_cjs/prod/noop"),g=require("@banquette/utils-misc/_cjs/prod/proxy"),c=require("@banquette/utils-object/_cjs/prod/extend"),a=require("@banquette/utils-reflection/_cjs/prod/get-caller"),u=require("@banquette/utils-type/_cjs/prod/ensure-array"),l=require("@banquette/utils-type/_cjs/prod/ensure-serializable"),p=require("@banquette/utils-type/_cjs/prod/ensure-string"),h=require("@banquette/utils-type/_cjs/prod/is-array"),v=require("@banquette/utils-type/_cjs/prod/is-null-or-undefined"),f=require("@banquette/utils-type/_cjs/prod/is-undefined"),L=require("./constants.js"),d=function(){function LoggerService(e,t,i){this.storage=e,this.config=t,this.fingerprintGenerator=i,this.logsQueue=[],this.isPersisting=!1,this.isWaitingForPersist=!1,this.listen(t.get("log.level"))}var d;return d=LoggerService,LoggerService.prototype.listen=function(e){this.maxLevel=e},LoggerService.prototype.emergency=function(e,t){this.log(L.LogLevel.EMERGENCY,e,t)},LoggerService.prototype.alert=function(e,t){this.log(L.LogLevel.ALERT,e,t)},LoggerService.prototype.critical=function(e,t){this.log(L.LogLevel.CRITICAL,e,t)},LoggerService.prototype.error=function(e,t){this.log(L.LogLevel.ERROR,e,t)},LoggerService.prototype.warning=function(e,t){this.log(L.LogLevel.WARNING,e,t)},LoggerService.prototype.notice=function(e,t){this.log(L.LogLevel.NOTICE,e,t)},LoggerService.prototype.info=function(e,t){this.log(L.LogLevel.INFO,e,t)},LoggerService.prototype.debug=function(e,t){this.log(L.LogLevel.DEBUG,e,t)},LoggerService.prototype.log=function(e,t,i){var r=this;e>this.maxLevel||this.improveContext(i).then((function(i){var o={level:e,message:d.resolveMessagePlaceholders(t,i),context:l.ensureSerializable(i,5)};r.register(o),"dev"===r.config.get("env")&&(o.level<=L.LogLevel.ERROR?console.error(o.message):o.level===L.LogLevel.WARNING?console.warn(o.message):console.log(o.message))})).catch(s.noop)},LoggerService.prototype.register=function(e){this.isLoaded()?(this.logs.push(e),this.persist()):(this.logsQueue.push(e),this.load().catch(s.noop).finally(g.proxy(this.persist,this)))},LoggerService.prototype.clear=function(){this.logs=[],this.logsQueue=[],this.storage.remove(this.config.get("log.storageKey")).catch(s.noop)},LoggerService.prototype.getAll=function(){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return this.isLoaded()?[2,this.logs]:[4,this.load()];case 1:return[2,e.sent()]}}))}))},LoggerService.prototype.isLoaded=function(){return h.isArray(this.logs)},LoggerService.prototype.load=function(){var e=this;return v.isNullOrUndefined(this.loadingPromise)?(this.loadingPromise=new Promise((function(t){e.storage.get(e.config.get("log.storageKey")).then((function(t){e.logs=u.ensureArray(t)})).catch((function(){e.logs=[]})).finally((function(){e.loadingPromise=null,e.logs=e.logs.concat(e.logsQueue),e.logsQueue=[],t(e.logs)}))})),this.loadingPromise):this.loadingPromise},LoggerService.prototype.persist=function(){var e=this;this.isLoaded()&&(this.isPersisting?this.isWaitingForPersist=!0:(this.isPersisting=!0,this.logs.length>this.config.get("log.maximumCount")&&(this.logs=this.logs.splice(-this.config.get("log.maximumCount"))),this.storage.set(this.config.get("log.storageKey"),this.logs).catch(s.noop).finally((function(){e.isPersisting=!1,e.isWaitingForPersist&&(e.isWaitingForPersist=!1,e.persist())}))))},LoggerService.prototype.improveContext=function(e){var t=this,i=a.getCaller(/^LoggerService/);return new Promise((function(r,o){t.improveContextAsync(c.extend({_caller:i},e||{})).then(r,o)}))},LoggerService.prototype.improveContextAsync=function(t){return e.__awaiter(this,void 0,void 0,(function(){var i;return e.__generator(this,(function(e){switch(e.label){case 0:if(!f.isUndefined(this.fingerprint))return[3,4];e.label=1;case 1:return e.trys.push([1,3,,4]),i=this,[4,this.fingerprintGenerator.getFingerprint()];case 2:return i.fingerprint=e.sent(),[3,4];case 3:return e.sent(),this.fingerprint=null,[3,4];case 4:return[2,c.extend({_fp:this.fingerprint},t)]}}))}))},LoggerService.resolveMessagePlaceholders=function(e,t){if(e.indexOf("{")<0)return e;for(var i,r=e,o=new RegExp("{([a-z]\\w*)}","ig");null!==(i=o.exec(e));){var n=p.ensureString(t[i[1]]);r=r.replace(i[0],n)}return r},LoggerService=d=e.__decorate([r.Service(),e.__param(0,i.Inject(n.StorageService)),e.__param(1,i.Inject(t.ConfigurationService)),e.__param(2,i.Inject(o.FingerprintService)),e.__metadata("design:paramtypes",[n.StorageService,t.ConfigurationService,o.FingerprintService])],LoggerService)}();exports.LoggerService=d;
