/*!
 * Banquette VueUi v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";var e=require("../../../_virtual/_tslib.js"),t=require("@banquette/http/_cjs/prod/constants"),o=require("@banquette/ui/_cjs/prod/form/select/constant"),i=require("@banquette/ui/_cjs/prod/form/select/selected-choice"),n=require("@banquette/utils-array/_cjs/prod/ensure-in-enum"),r=require("@banquette/utils-misc/_cjs/prod/debounce"),a=require("@banquette/utils-object/_cjs/prod/get-object-keys"),p=require("@banquette/utils-type/_cjs/prod/is-array"),s=require("@banquette/utils-type/_cjs/prod/is-undefined"),c=require("@banquette/vue-remix-icons/_cjs/prod/close-circle"),d=require("@banquette/vue-typescript/_cjs/prod/decorator/component.decorator"),l=require("@banquette/vue-typescript/_cjs/prod/decorator/expose.decorator"),m=require("@banquette/vue-typescript/_cjs/prod/decorator/import.decorator"),u=require("@banquette/vue-typescript/_cjs/prod/decorator/prop.decorator"),h=require("@banquette/vue-typescript/_cjs/prod/decorator/template-ref.decorator"),_=require("@banquette/vue-typescript/_cjs/prod/decorator/themeable.decorator"),v=require("@banquette/vue-typescript/_cjs/prod/decorator/watch.decorator"),y=require("@banquette/vue-typescript/_cjs/prod/theme/bind-theme.directive"),g=require("@vueuse/core");require("../../../dropdown/dropdown.component.vue.js"),require("../../../dropdown/dropdown-divider.component.vue.js"),require("../../../dropdown/dropdown-item.component.vue.js"),require("../../../misc/call/call.component.vue.js"),require("../../../misc/conditional-wrapper/conditional-wrapper.component.vue.js"),require("../../../misc/remote/remote.component.vue.js"),require("../../../misc/teleport/teleport.component.vue.js");var b=require("../../../misc/click-outside.directive.js");require("../../../misc/collapsable.directive.js"),require("../../../misc/stick-to.directive.js"),require("../../../misc/teleport.directive.js"),require("@banquette/api/_cjs/prod/api.service"),require("@banquette/dependency-injection/_cjs/prod/injector"),require("@banquette/utils-misc/_cjs/prod/proxy"),require("@banquette/vue-typescript/_cjs/prod/vue-builder"),require("../../../misc/client-only.component.vue.js"),require("../../../progress/progress-circular/progress-circular.component.vue.js"),require("../../../tag/tag.component.vue.js");var S=require("../../abstract-vue-form.component.js");require("../../base-input/base-input.component.vue.js");var C=require("../../base-input/base-input.composable.js"),f=require("../../constant.js"),F=require("../constant.js"),q=require("./choice-slot-wrapper.component.js");require("./choice/choice.component.vue.js");var j=require("./i18n-defaults.js"),P=require("./select.view-model.js"),w=require("./theme-configuration.js"),I=require("./wrapped-selected-choice.js"),T=require("./choice/choice.component.vue_vue_type_script_lang.vue.js"),O=require("../../../tag/tag.component.vue_vue_type_script_lang.vue.js"),E=require("../../../dropdown/dropdown.component.vue_vue_type_script_lang.vue.js"),V=require("../../base-input/base-input.component.vue_vue_type_script_lang.vue.js"),B=require("../../../progress/progress-circular/progress-circular.component.vue_vue_type_script_lang.vue.js"),W=function(S){function FormSelectComponent(){var e=S.call(this)||this;return e.dropdownWidth=0,e.inputWrapperResizeUnsubscribe=null,e.lastBlurTime=0,e.lastKeyStrokeTime=0,e.onInputChange=r.debounce((function(){e.v.isInputReadonly||e.vm.setSearchString(e.v.inputValue),e.v.inputValue?e.v.base.placeholder="":e.v.base.placeholder=e.baseComposable.placeholder,e.vm.allowCreation&&(e.v.creationBuffer=e.v.inputValue)}),100),e.eventPipeline.subscribe(f.ViewModelEvents.Configure,(function(){e.onBasePropsChange(),e.syncChoices(),e.updateSearchConfiguration(),e.updateSelectionVisibilityTracking()})),e}return e.__extends(FormSelectComponent,S),FormSelectComponent.prototype.mounted=function(){var e=this;S.prototype.mounted.call(this),this.observerInputWrapperSize((function(t){e.dropdownWidth=t[0].contentRect.width,e.updateTagsVisibility()}))},FormSelectComponent.prototype.beforeUnmount=function(){S.prototype.beforeUnmount.call(this),this.inputWrapperResizeUnsubscribe&&this.inputWrapperResizeUnsubscribe()},FormSelectComponent.prototype.onKeyDown=function(e){this.lastKeyStrokeTime=(new Date).getTime(),this.vm.onKeyDown(e),this.updateInput(),"Enter"===e.key&&this.allowCreation&&(this.v.inputValue=this.v.creationBuffer="")},FormSelectComponent.prototype.selectChoice=function(e){this.vm.selectChoice(e)},FormSelectComponent.prototype.deselectChoice=function(e){this.vm.deselectChoice(e)},FormSelectComponent.prototype.deselectAll=function(){this.vm.deselectAll(),this.v.base.placeholder=this.baseComposable.placeholder},FormSelectComponent.prototype.removeItem=function(e){for(var t=0;t<this.v.control.value.length;++t)this.v.control.value[t].identifier===e.identifier&&this.v.control.value.splice(t,1)},FormSelectComponent.prototype.toggleSelectedPopover=function(){this.v.selectedPopoverVisible=!this.v.selectedPopoverVisible},FormSelectComponent.prototype.hideSelectedPopover=function(){this.v.selectedPopoverVisible=!1},FormSelectComponent.prototype.onInputWrapperClick=function(){(new Date).getTime()-this.lastBlurTime<150||(this.inputEl.focus(),this.vm.showChoices(),this.updateInput())},FormSelectComponent.prototype.onInputFocus=function(){(new Date).getTime()-this.lastBlurTime<150||(this.v.control.onFocus(),this.v.isInputFocused=!0)},FormSelectComponent.prototype.onInputBlur=function(){this.v.isInputReadonly||(this.v.inputValue=this.v.inputPlaceholder),this.v.control.onBlur(),this.v.isInputFocused=!1,this.lastBlurTime=(new Date).getTime(),s.isUndefined(this.vm)||this.vm.hideChoices()},FormSelectComponent.prototype.setupViewModel=function(){var e=new P.SelectViewModel(this.proxy,this.baseComposable);return e.choicesOriginOrdering=[F.BeforeSlotOrigin,o.ChoiceOrigin.User,F.PropOrigin,o.ChoiceOrigin.Default,o.ChoiceOrigin.Remote,F.AfterSlotOrigin],e},FormSelectComponent.prototype.onFocusChanged=function(e){S.prototype.onFocusChanged.call(this,e),e&&(this.v.selectedPopoverVisible=!1)},FormSelectComponent.prototype.onBasePropsChange=function(){this.vm.modelType=this.model,this.vm.choicesLabel=this.choicesLabel,this.vm.choicesIdentifier=this.choicesIdentifier,this.vm.choicesValue=this.choicesValue,this.vm.choicesDisabled=this.choicesDisabled,this.vm.choicesGroup=this.choicesGroup,this.vm.closeOnSelection=this.closeOnSelection,this.v.dropdownTeleport=this.dropdownTeleport,this.v.dropdownZIndex=this.dropdownZIndex},FormSelectComponent.prototype.syncChoices=function(){this.vm.setChoices(this.choices||[],F.PropOrigin)},FormSelectComponent.prototype.onSelectionChange=function(){var e=this;(new Date).getTime()-this.lastKeyStrokeTime>50&&!this.v.multiple&&this.inputEl.blur(),this.updateInput(),this.updateSelected(),setTimeout((function(){e.updateTagsVisibility()})),this.$emit("change",this.v.control.value)},FormSelectComponent.prototype.onChoiceVisibilityChange=function(e){e&&!this.v.isInputReadonly?(this.v.inputValue=this.v.searchBuffer,this.v.base.placeholder=""):e||(this.v.inputValue===this.v.searchBuffer&&(this.v.inputValue=""),this.v.base.placeholder=this.baseComposable.placeholder)},FormSelectComponent.prototype.updateSearchConfiguration=function(){this.v.multiple=this.multiple,this.vm.searchType=this.searchType,this.vm.searchRemoteParamName=this.searchRemoteParamName,this.vm.searchMinLength=this.searchMinLength,this.vm.allowCreation=this.allowCreation,this.v.isInputReadonly=this.vm.searchType===o.SearchType.None&&!this.allowCreation},FormSelectComponent.prototype.syncRemoteProps=function(){this.vm.remote.updateConfiguration({url:this.url,endpoint:this.endpoint,method:this.method,urlParams:this.urlParams,headers:this.headers,model:this.model})},FormSelectComponent.prototype.updateSelectionVisibilityTracking=function(){if(this.v.multiple=this.multiple,this.v.isHeightLocked=this.lockHeight,!this.v.needsSelectionPopover){for(var e=0,t=a.getObjectKeys(this.v.selected);e<t.length;e++){var o=t[e];this.v.selected[o].visible=!0}this.v.selectedPopoverVisible=!1,this.v.selectedInPopover=[]}this.v.multiple?(p.isArray(this.v.control.value)||(this.v.control.value=s.isUndefined(this.v.control.value)?[]:[this.v.control.value]),this.onSelectionChange()):p.isArray(this.v.control.value)&&(this.v.control.value=this.v.control.value.length>0?this.v.control.value[0]:void 0),this.v.multiple&&(this.v.inputValue="",this.v.inputPlaceholder="")},FormSelectComponent.prototype.updateInput=function(){if(!this.multiple){var e=this.v.control.value instanceof i.SelectedChoice?this.v.control.value.label:"";this.v.inputPlaceholder=e,!this.v.isInputReadonly&&this.v.isInputFocused&&this.v.choicesVisible&&e===this.v.inputValue&&this.v.searchBuffer!==e?this.v.inputValue="":this.v.choicesVisible||(this.v.inputValue=e)}},FormSelectComponent.prototype.updateSelected=function(){var e={};if(p.isArray(this.v.control.value))for(var t=0,o=this.v.control.value;t<o.length;t++){var i=o[t];s.isUndefined(this.v.selected[i.id])?e[i.id]=new I.WrappedSelectedChoice(i,!this.v.needsSelectionPopover):e[i.id]=this.v.selected[i.id]}this.v.selected=e},FormSelectComponent.prototype.updateTagsVisibility=function(){if(this.v.needsSelectionPopover&&this.tagSelectionWrapperEl&&p.isArray(this.v.control.value)){var e=0,t=this.tagSelectionWrapperEl.getBoundingClientRect(),o=this.tagSelectionWrapperEl.children.length;this.v.selectedInPopover=[];for(var i=0;i<o;++i){var n=this.tagSelectionWrapperEl.children[i],r=parseInt(n.getAttribute("data-id")||"0",10);if(!s.isUndefined(this.v.selected[r])){var a=n.getBoundingClientRect();i<o-1&&t.right-a.right<=55||i===o-1&&t.right-a.right<0?(this.v.selected[r].visible=!1,i===o-1&&a.width<55&&e>0&&this.v.selected[e].visible&&(this.v.selected[e].visible=!1,this.v.selectedInPopover.push(this.v.selected[e].choice)),this.v.selectedInPopover.push(this.v.selected[r].choice)):this.v.selected[r].visible=!0,e=r}}this.v.selectedInPopover.length?this.$refs.additionalTagsAggregator||setTimeout(this.$forceUpdate):this.v.selectedPopoverVisible=!1}},FormSelectComponent.prototype.observerInputWrapperSize=function(e){var t,o=this;this.inputWrapperResizeUnsubscribe&&this.inputWrapperResizeUnsubscribe(),this.inputWrapperResizeUnsubscribe=function(){t(),o.inputWrapperResizeUnsubscribe=null},this.inputWrapperEl&&(this.dropdownTarget=this.inputWrapperEl.parentElement,t=g.useResizeObserver(this.dropdownTarget,e).stop)},e.__decorate([u.Prop({type:Array,default:null}),e.__metadata("design:type",Object)],FormSelectComponent.prototype,"choices",void 0),e.__decorate([u.Prop({type:[String,Function],default:"label"}),e.__metadata("design:type",Object)],FormSelectComponent.prototype,"choicesLabel",void 0),e.__decorate([u.Prop({type:[String,Function],default:"id"}),e.__metadata("design:type",Object)],FormSelectComponent.prototype,"choicesIdentifier",void 0),e.__decorate([u.Prop({type:[String,Function],default:null}),e.__metadata("design:type",Object)],FormSelectComponent.prototype,"choicesValue",void 0),e.__decorate([u.Prop({type:[String,Function],default:"disabled"}),e.__metadata("design:type",Object)],FormSelectComponent.prototype,"choicesDisabled",void 0),e.__decorate([u.Prop({type:[String,Function],default:"group"}),e.__metadata("design:type",Object)],FormSelectComponent.prototype,"choicesGroup",void 0),e.__decorate([u.Prop({type:Boolean,default:!1}),e.__metadata("design:type",Boolean)],FormSelectComponent.prototype,"multiple",void 0),e.__decorate([u.Prop({type:Boolean,default:!1}),e.__metadata("design:type",Boolean)],FormSelectComponent.prototype,"lockHeight",void 0),e.__decorate([u.Prop({type:Boolean,default:!1}),e.__metadata("design:type",Boolean)],FormSelectComponent.prototype,"allowCreation",void 0),e.__decorate([u.Prop({type:Boolean,default:!1}),e.__metadata("design:type",Boolean)],FormSelectComponent.prototype,"clearable",void 0),e.__decorate([u.Prop({type:[String,Boolean],default:"auto"}),e.__metadata("design:type",Object)],FormSelectComponent.prototype,"closeOnSelection",void 0),e.__decorate([m.Import(C.BaseInputComposable,!1),e.__metadata("design:type",C.BaseInputComposable)],FormSelectComponent.prototype,"baseComposable",void 0),e.__decorate([u.Prop({type:String,default:null}),e.__metadata("design:type",Object)],FormSelectComponent.prototype,"model",void 0),e.__decorate([u.Prop({name:"remoteUrl",type:String,default:null}),e.__metadata("design:type",Object)],FormSelectComponent.prototype,"url",void 0),e.__decorate([u.Prop({name:"remoteEndpoint",type:String,default:null}),e.__metadata("design:type",Object)],FormSelectComponent.prototype,"endpoint",void 0),e.__decorate([u.Prop({name:"remoteMethod",type:String,default:t.HttpMethod.GET,transform:function(e){return n.ensureInEnum(e,t.HttpMethod,t.HttpMethod.GET)}}),e.__metadata("design:type",String)],FormSelectComponent.prototype,"method",void 0),e.__decorate([u.Prop({name:"remoteUrlParams",type:Object,default:{}}),e.__metadata("design:type",Object)],FormSelectComponent.prototype,"urlParams",void 0),e.__decorate([u.Prop({name:"remoteHeaders",type:Object,default:{}}),e.__metadata("design:type",Object)],FormSelectComponent.prototype,"headers",void 0),e.__decorate([u.Prop({name:"searchType",type:String,transform:function(e){return n.ensureInEnum(e,o.SearchType,o.SearchType.None)}}),e.__metadata("design:type",String)],FormSelectComponent.prototype,"searchType",void 0),e.__decorate([u.Prop({name:"searchRemoteParamName",type:[String,Array],default:"search"}),e.__metadata("design:type",Object)],FormSelectComponent.prototype,"searchRemoteParamName",void 0),e.__decorate([u.Prop({name:"searchMinLength",type:Number,default:0}),e.__metadata("design:type",Number)],FormSelectComponent.prototype,"searchMinLength",void 0),e.__decorate([u.Prop({name:"dropdownTeleport",type:[Object,String],default:null}),e.__metadata("design:type",Object)],FormSelectComponent.prototype,"dropdownTeleport",void 0),e.__decorate([u.Prop({name:"dropdownZIndex",type:[Number,String],default:void 0,transform:function(e){return s.isUndefined(e)?void 0:parseInt(e,10)}}),e.__metadata("design:type",Object)],FormSelectComponent.prototype,"dropdownZIndex",void 0),e.__decorate([u.Prop({type:Object,default:j.I18nDefaults}),e.__metadata("design:type",Object)],FormSelectComponent.prototype,"i18n",void 0),e.__decorate([l.Expose(),e.__metadata("design:type",Object)],FormSelectComponent.prototype,"v",void 0),e.__decorate([l.Expose(),e.__metadata("design:type",Number)],FormSelectComponent.prototype,"dropdownWidth",void 0),e.__decorate([l.Expose(),e.__metadata("design:type",HTMLElement)],FormSelectComponent.prototype,"dropdownTarget",void 0),e.__decorate([h.TemplateRef("input"),e.__metadata("design:type",HTMLElement)],FormSelectComponent.prototype,"inputEl",void 0),e.__decorate([h.TemplateRef("inputWrapper"),e.__metadata("design:type",Object)],FormSelectComponent.prototype,"inputWrapperEl",void 0),e.__decorate([h.TemplateRef("tagSelectionWrapper"),e.__metadata("design:type",Object)],FormSelectComponent.prototype,"tagSelectionWrapperEl",void 0),e.__decorate([l.Expose(),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[KeyboardEvent]),e.__metadata("design:returntype",void 0)],FormSelectComponent.prototype,"onKeyDown",null),e.__decorate([l.Expose(),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[Object]),e.__metadata("design:returntype",void 0)],FormSelectComponent.prototype,"selectChoice",null),e.__decorate([l.Expose(),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[Object]),e.__metadata("design:returntype",void 0)],FormSelectComponent.prototype,"deselectChoice",null),e.__decorate([l.Expose(),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[]),e.__metadata("design:returntype",void 0)],FormSelectComponent.prototype,"deselectAll",null),e.__decorate([l.Expose(),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[i.SelectedChoice]),e.__metadata("design:returntype",void 0)],FormSelectComponent.prototype,"removeItem",null),e.__decorate([l.Expose(),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[]),e.__metadata("design:returntype",void 0)],FormSelectComponent.prototype,"toggleSelectedPopover",null),e.__decorate([l.Expose(),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[]),e.__metadata("design:returntype",void 0)],FormSelectComponent.prototype,"hideSelectedPopover",null),e.__decorate([l.Expose(),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[]),e.__metadata("design:returntype",void 0)],FormSelectComponent.prototype,"onInputWrapperClick",null),e.__decorate([l.Expose(),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[]),e.__metadata("design:returntype",void 0)],FormSelectComponent.prototype,"onInputFocus",null),e.__decorate([l.Expose(),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[]),e.__metadata("design:returntype",void 0)],FormSelectComponent.prototype,"onInputBlur",null),e.__decorate([l.Expose(),e.__metadata("design:type",Object)],FormSelectComponent.prototype,"onInputChange",void 0),e.__decorate([v.Watch(["model","choicesLabel","choicesIdentifier","choicesValue","choicesDisabled","choicesGroup","closeOnSelection","dropdownTeleport","dropdownZIndex"],{immediate:!1}),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[]),e.__metadata("design:returntype",void 0)],FormSelectComponent.prototype,"onBasePropsChange",null),e.__decorate([v.Watch("choices",{immediate:!1}),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[]),e.__metadata("design:returntype",void 0)],FormSelectComponent.prototype,"syncChoices",null),e.__decorate([v.Watch("v.control.value"),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[]),e.__metadata("design:returntype",void 0)],FormSelectComponent.prototype,"onSelectionChange",null),e.__decorate([v.Watch("v.choicesVisible",{immediate:v.ImmediateStrategy.BeforeMount}),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[Boolean]),e.__metadata("design:returntype",void 0)],FormSelectComponent.prototype,"onChoiceVisibilityChange",null),e.__decorate([v.Watch(["searchType","searchRemoteParamName","searchMinLength","allowCreation","multiple"],{immediate:!1}),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[]),e.__metadata("design:returntype",void 0)],FormSelectComponent.prototype,"updateSearchConfiguration",null),e.__decorate([v.Watch(["model","remoteUrl","remoteEndpoint","remoteMethod","remoteUrlParams","remoteHeaders"],{immediate:v.ImmediateStrategy.BeforeMount}),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[]),e.__metadata("design:returntype",void 0)],FormSelectComponent.prototype,"syncRemoteProps",null),e.__decorate([v.Watch(["multiple","lockHeight"],{immediate:!1}),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[]),e.__metadata("design:returntype",void 0)],FormSelectComponent.prototype,"updateSelectionVisibilityTracking",null),FormSelectComponent=e.__decorate([_.Themeable(w.ThemeConfiguration),d.Component({name:"bt-form-select",components:[V,T,q,O,E,B,c.IconRemixCloseCircle],directives:[b.ClickOutsideDirective,y.BindThemeDirective],emits:["focus","blur","change"]}),e.__metadata("design:paramtypes",[])],FormSelectComponent)}(S.AbstractVueFormComponent);module.exports=W;
