/*!
 * Banquette VueUi v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";var e=require("../../_virtual/_tslib.js"),t=require("@banquette/form/_cjs/prod/form-control"),o=require("@banquette/ui/_cjs/prod/tree/node"),r=require("@banquette/utils-misc/_cjs/prod/are-equal"),n=require("@banquette/utils-type/_cjs/prod/ensure-array"),i=require("@banquette/utils-type/_cjs/prod/is-function"),a=require("@banquette/utils-type/_cjs/prod/is-object"),s=require("@banquette/utils-type/_cjs/prod/is-primitive"),u=require("@banquette/utils-type/_cjs/prod/is-undefined"),c=require("@banquette/vue-typescript/_cjs/prod/decorator/component.decorator"),d=require("@banquette/vue-typescript/_cjs/prod/decorator/expose.decorator"),p=require("@banquette/vue-typescript/_cjs/prod/decorator/import.decorator"),l=require("@banquette/vue-typescript/_cjs/prod/decorator/prop.decorator"),h=require("@banquette/vue-typescript/_cjs/prod/decorator/ref.decorator"),m=require("@banquette/vue-typescript/_cjs/prod/decorator/themeable.decorator"),v=require("@banquette/vue-typescript/_cjs/prod/theme/bind-theme.directive");require("../../tree/tree.component.vue.js"),require("../base-input/base-input.component.vue.js");var b=require("../base-input/base-input.composable.js"),f=require("../abstract-vue-form.component.js"),y=require("../constant.js"),x=require("./theme-configuration.js"),q=require("./tree.view-model.js"),C=require("../../tree/tree.component.vue_vue_type_script_lang.vue.js"),F=require("../base-input/base-input.component.vue_vue_type_script_lang.vue.js"),_=function(f){function FormTreeComponent(){var e=null!==f&&f.apply(this,arguments)||this;return e.checkboxesData={},e.unsubscribeFunctions=[],e.nodesSelectionUpdateStack=[],e}return e.__extends(FormTreeComponent,f),FormTreeComponent.prototype.beforeMount=function(){var e=this;f.prototype.beforeMount.call(this),this.proxy.onReady((function(){e.v.control.value=u.isUndefined(e.v.control.value)||e.v.control.value===y.UndefinedValue?[]:n.ensureArray(e.v.control.value)})),this.base.floatingLabel=!1},FormTreeComponent.prototype.beforeUnmount=function(){f.prototype.beforeUnmount.call(this);for(var e=0,t=this.unsubscribeFunctions;e<t.length;e++){(0,t[e])()}this.unsubscribeFunctions=[]},FormTreeComponent.prototype.getCheckboxData=function(e){return u.isUndefined(this.checkboxesData[e.id])&&(this.checkboxesData[e.id]=this.createCheckboxDataForNode(e)),this.checkboxesData[e.id]},FormTreeComponent.prototype.setupViewModel=function(){return new q.TreeViewModel(this.proxy,this.base)},FormTreeComponent.prototype.addNodeValueToSelection=function(e){if(this.getNodeValueIndexInFormControlValue(e)<0){var t=this.extractNodeValue(e);u.isUndefined(t)||(this.v.control.value.push(t),this.v.control.value=this.v.control.value.slice(0))}},FormTreeComponent.prototype.removeNodeValueFromSelection=function(e){var t=this.getNodeValueIndexInFormControlValue(e);t>-1&&(this.v.control.value.splice(t,1),this.v.control.value=this.v.control.value.slice(0))},FormTreeComponent.prototype.createCheckboxDataForNode=function(e){var o=this,r=new t.FormControl;return this.unsubscribeFunctions.push(r.onValueChanged((function(t){t.newValue?o.addNodeValueToSelection(e):o.removeNodeValueFromSelection(e),o.updateChildNodes(e),o.updateParentNodes(e)}))),queueMicrotask((function(){(o.getNodeValueIndexInFormControlValue(e)>-1||e.parent&&!u.isUndefined(o.checkboxesData[e.parent.id])&&o.checkboxesData[e.parent.id].control.value)&&r.setValue(!0)})),{control:r,indeterminate:!1}},FormTreeComponent.prototype.updateChildNodes=function(e){if(!(u.isUndefined(this.checkboxesData[e.id])||this.nodesSelectionUpdateStack.indexOf(e.id)>-1)){var t=this.checkboxesData[e.id].control.value;this.nodesSelectionUpdateStack.push(e.id);for(var o=0,r=e.children;o<r.length;o++){var n=r[o];u.isUndefined(this.checkboxesData[n.id])||(this.checkboxesData[n.id].control.value!==t?this.checkboxesData[n.id].control.setValue(t):(this.updateChildNodes(n),this.updateParentNodes(e)))}this.nodesSelectionUpdateStack.pop()}},FormTreeComponent.prototype.updateParentNodes=function(e){if(!(u.isUndefined(this.checkboxesData[e.id])||this.nodesSelectionUpdateStack.indexOf(e.id)>-1)){this.nodesSelectionUpdateStack.push(e.id);for(var t=e.parent;t;){if(!u.isUndefined(this.checkboxesData[t.id])){for(var o=0,r=0,n=0,i=0,a=t.children;i<a.length;i++){var s=a[i];u.isUndefined(this.checkboxesData[s.id])||(this.checkboxesData[s.id].indeterminate?r++:this.checkboxesData[s.id].control.value?++o:++n)}this.checkboxesData[t.id].indeterminate=!1,!o||n||r?(this.nodesSelectionUpdateStack.push(t.id),this.checkboxesData[t.id].indeterminate=r>0||o>0&&n>0,this.checkboxesData[t.id].control.setValue(!1),this.nodesSelectionUpdateStack.pop()):this.checkboxesData[t.id].control.setValue(!0)}t=t.parent}this.nodesSelectionUpdateStack.pop()}},FormTreeComponent.prototype.getNodeValueIndexInFormControlValue=function(e){for(var t=this.extractNodeComparableValue(e),o=0;o<this.v.control.value.length;++o){var n=this.v.control.value[o];if(s.isPrimitive(n)){if(t===n)return o}else{var i=this.extractValueIdentifier(n);if(null!==i){if(i===t)return o}else if(r.areEqual(n,t))return o}}return-1},FormTreeComponent.prototype.extractNodeValue=function(e){return i.isFunction(this.nodesValue)?this.nodesValue(e.originalValue):a.isObject(e.originalValue)&&this.nodesValue?e.originalValue[this.nodesValue]:e.originalValue},FormTreeComponent.prototype.extractNodeComparableValue=function(e){var t=this.extractNodeValue(e);if(s.isPrimitive(t))return t;var o=this.extractValueIdentifier(t);return null!==o?o:t},FormTreeComponent.prototype.extractValueIdentifier=function(e){return i.isFunction(this.valueIdentifier)?this.valueIdentifier(e):this.valueIdentifier&&s.isPrimitive(e[this.valueIdentifier])?e[this.valueIdentifier]:null},e.__decorate([p.Import(b.BaseInputComposable,{floatingLabel:!1}),e.__metadata("design:type",b.BaseInputComposable)],FormTreeComponent.prototype,"base",void 0),e.__decorate([l.Prop({type:[String,Function],default:null}),e.__metadata("design:type",Object)],FormTreeComponent.prototype,"nodesValue",void 0),e.__decorate([l.Prop({type:[String,Function],default:null}),e.__metadata("design:type",Object)],FormTreeComponent.prototype,"valueIdentifier",void 0),e.__decorate([d.Expose(),e.__metadata("design:type",Object)],FormTreeComponent.prototype,"v",void 0),e.__decorate([h.Ref(),e.__metadata("design:type",Object)],FormTreeComponent.prototype,"checkboxesData",void 0),e.__decorate([d.Expose(),e.__metadata("design:type",Function),e.__metadata("design:paramtypes",[o.Node]),e.__metadata("design:returntype",Object)],FormTreeComponent.prototype,"getCheckboxData",null),FormTreeComponent=e.__decorate([m.Themeable(x.ThemeConfiguration),c.Component({name:"bt-form-tree",components:[F,C],directives:[v.BindThemeDirective]})],FormTreeComponent)}(f.AbstractVueFormComponent);module.exports=_;
