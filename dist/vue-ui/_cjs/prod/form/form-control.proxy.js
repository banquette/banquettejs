/*!
 * Banquette VueUi v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var o=require("../_virtual/_tslib.js"),t=require("@banquette/dependency-injection/_cjs/prod/decorator/inject.decorator"),e=require("@banquette/dependency-injection/_cjs/prod/decorator/module.decorator"),r=require("@banquette/dependency-injection/_cjs/prod/injector"),n=require("@banquette/exception/_cjs/prod/usage.exception"),i=require("@banquette/form/_cjs/prod/exception/component-not-found.exception"),a=require("@banquette/form/_cjs/prod/form-control"),l=require("@banquette/utils-misc/_cjs/prod/proxy"),d=require("@banquette/utils-type/_cjs/prod/is-function"),s=require("@banquette/utils-type/_cjs/prod/is-object"),u=require("@banquette/utils-type/_cjs/prod/is-string"),p=require("@banquette/vue-typescript/_cjs/prod/decorator/composable.decorator"),c=require("@banquette/vue-typescript/_cjs/prod/decorator/computed.decorator"),m=require("@banquette/vue-typescript/_cjs/prod/decorator/lifecycle.decorator"),y=require("@banquette/vue-typescript/_cjs/prod/decorator/prop.decorator"),h=require("@banquette/vue-typescript/_cjs/prod/decorator/watch.decorator"),f=require("./form-storage.service.js"),_=function(){function FormControlProxy(o){this.formStorage=o,this.fallbackForm=null,this.fallbackGetControl=null,this.vModelControl=null,this.methodsQueue=[],this.onReadySubscribers=[],this.onDetachSubscribers=[],this.isInternalControl=!1}var _;return _=FormControlProxy,Object.defineProperty(FormControlProxy.prototype,"id",{get:function(){return this.getFromControl("id",0)},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"formId",{get:function(){return this.getFromControl("formId","")},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"path",{get:function(){return this.getFromControl("path",null)},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"valid",{get:function(){return this.getFromControl("valid",!0)},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"invalid",{get:function(){return!this.valid},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"notValidated",{get:function(){return this.getFromControl("notValidated",!1)},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"validated",{get:function(){return!this.notValidated},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"validating",{get:function(){return this.getFromControl("validating",!1)},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"notValidating",{get:function(){return!this.validating},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"validatedAndValid",{get:function(){return this.getFromControl("validatedAndValid",!1)},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"busy",{get:function(){return this.getFromControl("busy",!1)},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"notBusy",{get:function(){return!this.busy},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"disabled",{get:function(){return this.getFromControl("disabled",!0)},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"enabled",{get:function(){return!this.disabled},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"dirty",{get:function(){return this.getFromControl("dirty",!1)},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"pristine",{get:function(){return!this.dirty},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"touched",{get:function(){return this.getFromControl("touched",!1)},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"untouched",{get:function(){return!this.touched},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"changed",{get:function(){return this.getFromControl("changed",!1)},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"unchanged",{get:function(){return!this.changed},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"focused",{get:function(){return null!==this.viewModel&&null!==this.focusedViewModel&&this.focusedViewModel.id===this.viewModel.id},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"unfocused",{get:function(){return!this.focused},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"errors",{get:function(){return this.getFromControl("errors",[])},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"ready",{get:function(){return null!==this.bridge},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"focusedViewModel",{get:function(){return this.getFromControl("focusedViewModel",null)},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"value",{get:function(){return this.getFromControl("value",null)},enumerable:!1,configurable:!0}),Object.defineProperty(FormControlProxy.prototype,"defaultValue",{get:function(){if(this.bridge)return this.bridge.defaultValue},enumerable:!1,configurable:!0}),FormControlProxy.prototype.onComponentUnmounted=function(){this._formRef&&(this._formRef.ref.release(),this._formRef=null),this.controlAddedUnsubscribe&&(this.controlAddedUnsubscribe(),this.controlAddedUnsubscribe=null),this.bridge&&this.viewModel&&this.bridge.unsetViewModel(this.viewModel),this.onReadySubscribers=[],this.onDetachSubscribers=[]},FormControlProxy.prototype.setViewModel=function(o){this.viewModel=o,this._control&&(this.bridge=this._control.setViewModel(this.viewModel))},FormControlProxy.prototype.unsetViewModel=function(){this.onControlUnassigned(),this.viewModel=null},FormControlProxy.prototype.markAsDisabled=function(){this.callControlMethod("markAsDisabled",!0,!0)},FormControlProxy.prototype.markAsEnabled=function(){this.callControlMethod("markAsEnabled",!0,!0)},FormControlProxy.prototype.markAsFocused=function(){this.callControlMethod("markAsFocused",!0,!0)},FormControlProxy.prototype.markAsBlurred=function(){this.callControlMethod("markAsBlurred",!0,!0)},FormControlProxy.prototype.markAsBusy=function(){this.callControlMethod("markAsBusy",!0,!0)},FormControlProxy.prototype.markAsNotBusy=function(){this.callControlMethod("markAsNotBusy",!0,!0)},FormControlProxy.prototype.setDefaultValue=function(o){this.callControlMethod("setDefaultValue",!1,!0,o)},FormControlProxy.prototype.setValue=function(o){this.callControlMethod("setValue",!1,!1,o)},FormControlProxy.prototype.reset=function(){this.callControlMethod("reset")},FormControlProxy.prototype.getExtras=function(){var o=this.callControlMethod("getExtra",!1);return o.done?o.returnValue:{}},FormControlProxy.prototype.setExtras=function(o){this.callControlMethod("setExtras",!0,!1,o)},FormControlProxy.prototype.getExtra=function(o,t){var e=this.callControlMethod("getExtras",!1,!1,o,t);return e.done?e.returnValue:t},FormControlProxy.prototype.setExtra=function(o,t){this.callControlMethod("setExtra",!1,!1,o,t)},FormControlProxy.prototype.setValidator=function(o){this.callControlMethod("setValidator",!0,!0,o)},FormControlProxy.prototype.setFallbackForm=function(o){this.fallbackForm=o,this._control||this.updateFormAndControl()},FormControlProxy.prototype.setFallbackGetControl=function(o){this.fallbackGetControl=o,this._control||this.updateFormAndControl()},FormControlProxy.prototype.getControl=function(){return this._control||(this._control=new a.FormControl,this.isInternalControl=!0,this.onControlAssigned(this._control)),this._control},FormControlProxy.prototype.setControl=function(o){if(this._control){if(o.id===this._control.id)return;this.onControlUnassigned()}this._control=o,this.isInternalControl=!0,this.onControlAssigned(this._control)},FormControlProxy.prototype.onBeforeValueChange=function(o,t){return this.subscribeToControl("onBeforeValueChange",o,t)},FormControlProxy.prototype.onStateChanged=function(o,t){return this.subscribeToControl("onStateChanged",o,t)},FormControlProxy.prototype.onValueChanged=function(o,t){return this.subscribeToControl("onValueChanged",o,t)},FormControlProxy.prototype.onErrorsChanged=function(o,t){return this.subscribeToControl("onErrorsChanged",o,t)},FormControlProxy.prototype.onReady=function(o){var t=this;return this.bridge&&o(this),this.onReadySubscribers.push(o),function(){t.onReadySubscribers=t.onReadySubscribers.filter((function(t){return t!==o}))}},FormControlProxy.prototype.onDetach=function(o){var t=this;return this.onDetachSubscribers.push(o),function(){t.onDetachSubscribers=t.onDetachSubscribers.filter((function(t){return t!==o}))}},FormControlProxy.prototype.updateFormAndControl=function(){if(!this.isInternalControl){this._form=this.resolveForm();var o=this.resolveControl(this._form);o!==this._control&&(!this._control||o&&o.id===this._control.id||this.onControlUnassigned(),this._control=o,this._control&&this.onControlAssigned(this._control)),this._control||!this._form||this.controlAddedUnsubscribe?this._control&&this.controlAddedUnsubscribe&&(this.controlAddedUnsubscribe(),this.controlAddedUnsubscribe=null):this.controlAddedUnsubscribe=this._form.onControlAdded(l.proxy(this.updateFormAndControl,this))}},FormControlProxy.prototype.callControlMethod=function(o,t,e){var r=arguments;void 0===t&&(t=!0),void 0===e&&(e=!1);for(var n=[],i=3;i<arguments.length;i++)n[i-3]=r[i];var a={method:o,args:n,done:!1,returnValue:void 0,skippable:e};return this.bridge?(a.returnValue=this.bridge[o].apply(this.bridge,n),a.done=!0):t&&this.methodsQueue.push(a),a},FormControlProxy.prototype.subscribeToControl=function(o,t,e){var r=this,n=this.callControlMethod(o,!0,!1,t,e);return function(){if(n.done&&d.isFunction(n.returnValue))n.returnValue();else if(!n.done)for(var o=0;o<r.methodsQueue.length;++o)if(r.methodsQueue[o]===n){r.methodsQueue.splice(o,1);break}}},FormControlProxy.prototype.flushControlMethodsQueue=function(o,t){for(var e=[],r=this.methodsQueue.length-1;r>=0;r--)if(this.methodsQueue[r].skippable){if(e.indexOf(this.methodsQueue[r].method)>-1){this.methodsQueue.splice(r,1);continue}e.push(this.methodsQueue[r].method)}for(var n=0,i=this.methodsQueue;n<i.length;n++){var a=i[n];a.returnValue=o[a.method].apply(t,a.args),a.done=!0}this.methodsQueue=[]},FormControlProxy.prototype.resolveControl=function(o){if(!this.control)return null;if(this.control instanceof a.FormControl)return this.control;if(!u.isString(this.control)||null===o)return null;var t=this.control,e=t.indexOf(":");e>-1&&(t=t.substring(e+1));try{var r=o.getByPath(t);if(!(r instanceof a.FormControl))throw new n.UsageException('The control path "'.concat(t,"\" doesn't resolve to a FormControl."));return r}catch(o){if(o instanceof i.ComponentNotFoundException){if(null!==this.fallbackGetControl){var l=this.fallbackGetControl(t);if(l instanceof a.FormControl)return l}return null}throw o}},FormControlProxy.prototype.resolveForm=function(){if(s.isObject(this.form))return this.form;var o=u.isString(this.form)?this.form:null;if(null===o&&u.isString(this.control)&&this.control.indexOf(":")>-1&&(o=this.control.substring(0,this.control.indexOf(":"))),null!==o&&(!this._formRef||this._formRef.name!==o)){var t=this.formStorage.getRef(o);this._formRef=null!==t?{name:o,ref:t}:t}return this._formRef?this._formRef.ref.obj:null===this.form?this.fallbackForm:null},FormControlProxy.prototype.getFromControl=function(o,t){return this.bridge?this.bridge[o]:t},FormControlProxy.prototype.onControlAssigned=function(o){if(this.viewModel){this.bridge=o.setViewModel(this.viewModel),this.flushControlMethodsQueue(this.bridge,o);for(var t=0,e=this.onReadySubscribers;t<e.length;t++){(0,e[t])(this)}}},FormControlProxy.prototype.onControlUnassigned=function(){this.bridge&&this.viewModel&&this.bridge.unsetViewModel(this.viewModel),this.bridge=null;for(var o=0,t=this.onDetachSubscribers;o<t.length;o++){(0,t[o])()}},o.__decorate([y.Prop({type:[String,Object],default:null}),o.__metadata("design:type",Object)],FormControlProxy.prototype,"form",void 0),o.__decorate([y.Prop({type:[String,Object],default:null}),o.__metadata("design:type",Object)],FormControlProxy.prototype,"control",void 0),o.__decorate([c.Computed(!1),o.__metadata("design:type",Number),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"id",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",String),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"formId",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",String),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"path",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",Boolean),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"valid",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",Boolean),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"invalid",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",Boolean),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"notValidated",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",Boolean),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"validated",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",Boolean),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"validating",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",Boolean),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"notValidating",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",Boolean),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"validatedAndValid",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",Boolean),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"busy",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",Boolean),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"notBusy",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",Boolean),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"disabled",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",Boolean),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"enabled",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",Boolean),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"dirty",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",Boolean),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"pristine",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",Boolean),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"touched",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",Boolean),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"untouched",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",Boolean),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"changed",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",Boolean),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"unchanged",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",Boolean),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"focused",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",Boolean),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"unfocused",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",Array),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"errors",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",Boolean),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"ready",null),o.__decorate([c.Computed(!1),o.__metadata("design:type",Object),o.__metadata("design:paramtypes",[])],FormControlProxy.prototype,"focusedViewModel",null),o.__decorate([m.Lifecycle("unmounted"),o.__metadata("design:type",Function),o.__metadata("design:paramtypes",[]),o.__metadata("design:returntype",void 0)],FormControlProxy.prototype,"onComponentUnmounted",null),o.__decorate([h.Watch(["form","control"],{immediate:h.ImmediateStrategy.NextTick}),o.__metadata("design:type",Function),o.__metadata("design:paramtypes",[]),o.__metadata("design:returntype",void 0)],FormControlProxy.prototype,"updateFormAndControl",null),FormControlProxy=_=o.__decorate([e.Module(),p.Composable((function(){return r.Injector.Get(_)})),o.__param(0,t.Inject(f.FormStorageService)),o.__metadata("design:paramtypes",[f.FormStorageService])],FormControlProxy)}();exports.FormControlProxy=_;
