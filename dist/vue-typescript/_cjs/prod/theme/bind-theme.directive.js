/*!
 * Banquette VueTypescript v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("../_virtual/_tslib.js"),t=require("@banquette/exception/_cjs/prod/usage.exception"),n=require("@banquette/utils-misc/_cjs/prod/proxy"),i=require("../constants.js"),s=require("../decorator/directive.decorator.js"),r=require("../utils/converters.js"),a=require("../vue.js"),o=require("./utils/get-themes-for-component.js"),c=require("./utils/match-variants.js"),h=require("./utils/split-variant-string.js"),u=require("./vue-themes.js"),p=function(a){function BindThemeDirective(){var e,t=null!==a&&a.apply(this,arguments)||this;return t.trackingThemes=[],t.activeVariantsAttributesStr="",t.globalUnsubscribeFns=[],t.computeChangesUnsubscribeFns=[],t.scheduleForceUpdate=(e=!1,function(){e||(e=!0,t.instance.$nextTick((function(){t.forceUpdate(),e=!1})))}),t}return e.__extends(BindThemeDirective,a),BindThemeDirective.prototype.created=function(e,n){var i=this;this.instance=r.anyToTsInst(n.instance);var s=r.anyToComponentMetadata(n.instance),a=s?s.themeable:null;if(!this.instance||!s)throw new t.UsageException('The "v-bt-bind-theme" directive can only be used on vue-typescript components.');if(!a)throw new t.UsageException('You must add a @Themeable() decorator to your component to use the "v-bt-bind-theme" directive.');this.metadata=s,this.configuration=a,this.globalUnsubscribeFns.push(u.VueThemes.OnChanged((function(){i.computeChanges(e)})))},BindThemeDirective.prototype.beforeMount=function(e){this.computeChanges(e)},BindThemeDirective.prototype.beforeUpdate=function(e){this.computeChanges(e)},BindThemeDirective.prototype.updated=function(){for(var e=0,t=this.trackingThemes;e<t.length;e++){t[e].notifyComponentChange(this.metadata.component.name)}},BindThemeDirective.prototype.unmounted=function(){for(var e=0,t=this.computeChangesUnsubscribeFns;e<t.length;e++){(0,t[e])()}for(var n=0,i=this.globalUnsubscribeFns;n<i.length;n++){(0,i[n])()}this.computeChangesUnsubscribeFns=[],this.globalUnsubscribeFns=[]},BindThemeDirective.prototype.computeChanges=function(e){var t=this,s=o.getThemesForComponent(this.instance),r=[],a=[],u=h.splitVariantString(this.instance[this.configuration.prop]||"");this.instance[i.ACTIVE_VARIANTS]=[];for(var p=0,m=s;p<m.length;p++){for(var d=m[p],l=d.getVariants(this.metadata.component.name),v={theme:d,trackedParentComponents:[]},_loop_1=function(e){c.matchVariant(e,u,b.instance)&&(b.instance[i.ACTIVE_VARIANTS].push(e),a.push(e.uid),e.applyIds.length>0&&(b.instance[i.ACTIVE_VARIANTS]=b.instance[i.ACTIVE_VARIANTS].concat(l.filter((function(n){return null!==n.publicId&&e.applyIds.indexOf(n.publicId)>-1&&t.instance[i.ACTIVE_VARIANTS].indexOf(n)<0&&(a.push(n.uid),!0)})))),e.use(b.instance,b.configuration));for(var n=0,s=e.selector.candidates;n<s.length;n++)for(var r=0,o=s[n].parents;r<o.length;r++){var h=o[r];h.name!==b.metadata.component.name&&v.trackedParentComponents.indexOf(h.name)<0&&v.trackedParentComponents.push(h.name)}},b=this,g=0,f=l;g<f.length;g++){_loop_1(f[g])}v.trackedParentComponents.length>0&&r.push(v)}var T=a.sort().join("#");if(this.activeVariantsAttributesStr!==T){this.trackingThemes=[];for(var C=0,A=this.computeChangesUnsubscribeFns;C<A.length;C++){(0,A[C])()}for(var V=0,y=this.activeVariantsAttributesStr.split("#");V<y.length;V++){var U=y[V];U&&e.removeAttribute("data-"+U)}for(var I=0,_=this.instance[i.ACTIVE_VARIANTS];I<_.length;I++){var q=_[I];e.setAttribute("data-"+q.uid,""),this.computeChangesUnsubscribeFns.push(q.onChange(n.proxy(this.scheduleForceUpdate,this)))}for(var x=0,D=r;x<D.length;x++){q=D[x];this.computeChangesUnsubscribeFns.push(q.theme.onComponentsChange(q.trackedParentComponents,(function(){t.computeChanges(e)}))),this.trackingThemes.push(q.theme)}this.activeVariantsAttributesStr=T}},BindThemeDirective.prototype.forceUpdate=function(){this.instance.$forceUpdateComputed(),this.instance.$forceUpdate()},BindThemeDirective=e.__decorate([s.Directive("bt-bind-theme")],BindThemeDirective)}(a.Vue);exports.BindThemeDirective=p;
