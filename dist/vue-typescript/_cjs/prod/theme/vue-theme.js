/*!
 * Banquette VueTypescript v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@banquette/utils-misc/_cjs/prod/is-server"),t=require("@banquette/utils-string/_cjs/prod/format/trim"),n=require("@banquette/utils-type/_cjs/prod/ensure-array"),i=require("@banquette/utils-type/_cjs/prod/is-undefined"),s=require("../utils/get-unique-random-id.js"),a=require("./constant.js"),r=require("./event/theme-component-changed.event.js"),o=require("./event/theme.event.js"),c=require("./utils/inject-context-in-css-source.js"),h=require("./utils/normalize-variant-selector.js"),l=require("./vue-theme-variant.js"),u=function(){function VueTheme(e,t){this.name=e,this.eventDispatcher=t,this.variants={},this.usageCount=0,this.id=s.getUniqueRandomId()}return VueTheme.prototype.getVariants=function(e){return i.isUndefined(this.variants[e])?[]:this.variants[e].variants},VueTheme.prototype.getVariant=function(e,t){var n=this,s=h.normalizeVariantSelector(e),a=s.identifier;if(i.isUndefined(this.variants[t])&&(this.variants[t]={variants:[],variantsIndex:{},styleElement:null}),i.isUndefined(this.variants[t].variantsIndex[a])){var r=new l.VueThemeVariant(this,s,this.eventDispatcher);this.variants[t].variantsIndex[a]={variant:r,onUseUnsubscribeFn:r.onUse((function(e){e.variant===r&&(n.variants[t].variantsIndex[a].onUseUnsubscribeFn(),n.injectInDOM())})),onChangeUnsubscribeFn:r.onChange((function(e){e.variant===r&&n.injectInDOM()})),onPriorityChangedUnsubscribeFn:r.onPriorityChange((function(){n.variants[t].variants=n.variants[t].variants.sort((function(e,t){return e.priorityNumber-t.priorityNumber}))}))},this.variants[t].variants.push(r)}return this.variants[t].variantsIndex[a].variant},VueTheme.prototype.removeVariant=function(e,t){var n=h.normalizeVariantSelector(e).identifier;if(!i.isUndefined(this.variants[t])&&!i.isUndefined(this.variants[t].variantsIndex[n])){this.variants[t].variantsIndex[n].onUseUnsubscribeFn(),this.variants[t].variantsIndex[n].onChangeUnsubscribeFn();var s=this.variants[t].variantsIndex[n],a=this.variants[t].variants.indexOf(s.variant);a>-1&&this.variants[t].variants.splice(a,1),delete this.variants[t].variantsIndex[n]}},VueTheme.prototype.clear=function(e){if(void 0===e&&(e=null),null!==e)for(var t=0,s=n.ensureArray(e);t<s.length;t++){var a=s[t];if(!i.isUndefined(this.variants[a])){for(var r=0,o=Object.values(this.variants[a]);r<o.length;r++){var c=o[r];c.onUseUnsubscribeFn(),c.onChangeUnsubscribeFn()}delete this.variants[a]}}else this.variants={}},VueTheme.prototype.use=function(){++this.usageCount,this.injectInDOM(),this.eventDispatcher.dispatch(a.ThemesEvents.ThemeChanged,new o.ThemeEvent(this))},VueTheme.prototype.free=function(){--this.usageCount<=0&&this.clearDOM(),this.eventDispatcher.dispatch(a.ThemesEvents.ThemeChanged,new o.ThemeEvent(null))},VueTheme.prototype.injectInDOM=function(){if(!e.isServer()){for(var n=[],s=0,r=Object.keys(this.variants);s<r.length;s++){for(var o=r[s],h="",l=this.variants[o],u=0,v=l.variants;u<v.length;u++){var d=v[u];if(d.used){for(var m=t.trim(d.rawCss),f=0,p=Object.keys(d.cssSelectorsMap);f<p.length;f++)for(var y=p[f],_loop_1=function(e){for(var t="",n=e.split(" "),s=Object.keys(d.cssSelectorsMap[y]),a=0,r=n;a<r.length;a++){var o=r[a],c=d.configuration.css.selectors.static[o];if(i.isUndefined(c)){c=null;for(var h=0,l=d.configuration.css.selectors.dynamic;h<l.length;h++){var u=l[h],v=Array.from(o.matchAll(u.pattern));if(v.length>0){t+=(t?" ":"")+u.selector,v.forEach((function(e,n){t=t.replace("$".concat(n+1),e[1])}));break}}}else t+=(t?" ":"")+c}if(t&&t.length>0){m+=t+" {\n";for(var f=0,p=s;f<p.length;f++){var g=p[f];m+="".concat(g,": ").concat(d.cssSelectorsMap[y][g],";\n")}m+="}\n"}},g=0,b=y.split(",");g<b.length;g++){_loop_1(b[g])}m.length>0&&(m=c.injectContextInCssSource(m,d.theme.id,"data-".concat(d.uid),d.scopeId),m+="\n");var T=Object.keys(d.cssVarsMap);if(T.length>0){n.push(d.theme.id),m+=".".concat(d.theme.id," [data-").concat(d.uid,"]")+(null!==d.scopeId?"[".concat(d.scopeId,"]"):""),m+=" {\n";for(var V=0,E=T;V<E.length;V++){var C=E[V];if(!i.isUndefined(d.configuration.css.vars[C])){var U=d.configuration.css.vars[C],j="";"@"===U[0]&&(U=U.substring(1),j=d.configuration.componentName),m+="    --".concat(j).concat(U,": ").concat(d.cssVarsMap[C],";")+"\n"}}m+="}\n"}h+=m}}if(h.length>0){if(null===l.styleElement){var x=document.createElement("style");x.setAttribute("type","text/css"),l.styleElement=x;var I=VueTheme.ActiveWildcardStyleElements.length;if(I&&VueTheme.ActiveWildcardStyleElements[I-1].parentNode&&VueTheme.ActiveWildcardStyleElements[I-1].nextSibling)VueTheme.ActiveWildcardStyleElements[I-1].parentNode.insertBefore(x,VueTheme.ActiveWildcardStyleElements[I-1].nextSibling);else{var S=Array.from(document.head.children),q=void 0;for(q=0;q<S.length;++q)if("style"===S[q].tagName.toLowerCase()){document.head.insertBefore(x,S[q]);break}q>=S.length&&document.head.appendChild(x)}this.name===a.ThemeWildcard&&VueTheme.ActiveWildcardStyleElements.push(x)}l.styleElement.innerHTML=h}else if(null!==l.styleElement){if(this.name===a.ThemeWildcard)for(q=0;q<VueTheme.ActiveWildcardStyleElements.length;++q)if(VueTheme.ActiveWildcardStyleElements[q]===l.styleElement){VueTheme.ActiveWildcardStyleElements.splice(q,1);break}l.styleElement.remove(),l.styleElement=null}}document.documentElement.classList.add(this.id)}},VueTheme.prototype.clearDOM=function(){for(var e=0,t=Object.keys(this.variants);e<t.length;e++){var n=t[e],i=this.variants[n];null!==i.styleElement&&(i.styleElement.remove(),i.styleElement=null)}document.documentElement.classList.remove(this.id)},VueTheme.prototype.notifyComponentChange=function(e){this.eventDispatcher.dispatch(a.ThemesEvents.ThemeComponentChanged,new r.ThemeComponentChangedEvent(this,e))},VueTheme.prototype.onUpdated=function(e){return this.eventDispatcher.subscribe(a.ThemesEvents.VariantUpdated,e)},VueTheme.prototype.onComponentsChange=function(e,t){var n=this;return this.eventDispatcher.subscribe(a.ThemesEvents.ThemeComponentChanged,(function(i){i.theme===n&&e.indexOf(i.componentName)>-1&&t()}))},VueTheme.ActiveWildcardStyleElements=[],VueTheme}();exports.VueTheme=u;
