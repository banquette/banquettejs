/*!
 * Banquette ModelForm v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./_virtual/_tslib.js"),t=require("@banquette/dependency-injection/_cjs/prod/decorator/inject.decorator"),r=require("@banquette/dependency-injection/_cjs/prod/decorator/module.decorator"),o=require("@banquette/exception/_cjs/prod/exception.factory"),n=require("@banquette/exception/_cjs/prod/usage.exception"),i=require("@banquette/form/_cjs/prod/exception/component-not-found.exception"),a=require("@banquette/form/_cjs/prod/form-control"),s=require("@banquette/model/_cjs/prod/model-metadata.service"),m=require("@banquette/model/_cjs/prod/model-transform-metadata.service"),c=require("@banquette/model/_cjs/prod/model-watcher.service"),l=require("@banquette/model/_cjs/prod/transformer/transform-context"),u=require("@banquette/model/_cjs/prod/transformer/transform.service"),d=require("@banquette/model/_cjs/prod/utils"),h=require("@banquette/object-observer/_cjs/prod/index"),f=require("@banquette/utils-misc/_cjs/prod/proxy"),p=require("@banquette/utils-type/_cjs/prod/ensure-array"),y=require("@banquette/utils-type/_cjs/prod/is-array"),b=require("@banquette/utils-type/_cjs/prod/is-object"),F=require("@banquette/utils-type/_cjs/prod/is-string"),M=require("@banquette/utils-type/_cjs/prod/is-undefined"),x=require("./contants.js"),g=require("./transformer/form-control.js"),C=require("./transformer/form-object.js"),v=require("./transformer/root/form.js"),T=require("./transformer/utils.js"),S=function(){function FormModelBinder(e,t,r,o){this.modelMetadata=e,this.transformMetadata=t,this.transformService=r,this.modelWatcher=o,this.canMutateForm=!1,this.ignoreFormUpdate=!1,this.ignoreModelUpdate=!1,this.valueTransformers=new WeakMap,this.transformersTrees=new WeakMap,this.contextStack=[]}return Object.defineProperty(FormModelBinder.prototype,"currentContextCtor",{get:function(){for(var e=this.contextStack.length-1;e>=0;--e)if(this.contextStack[e].ctor!==Array)return this.contextStack[e].ctor;return this.model.constructor},enumerable:!1,configurable:!0}),Object.defineProperty(FormModelBinder.prototype,"currentContextProperty",{get:function(){for(var e=this.contextStack.length-1;e>=0;--e)if(this.contextStack[e].ctor!==Array)return this.contextStack[e].property;return null},enumerable:!1,configurable:!0}),FormModelBinder.prototype.bind=function(e,t){return this.form=t,this.model=e,this.syncFormObjectWithModel(t,this.model),this.form.onControlAdded(f.proxy(this.throwOnUnauthorizedFormMutation,this),0,!1),this.form.onControlRemoved(f.proxy(this.throwOnUnauthorizedFormMutation,this),0,!1),this.form.onValueChanged(f.proxy(this.onFormValueChange,this),0,!1),this.modelWatcher.watchTransformableProperties(e,v.FormTransformerSymbol,f.proxy(this.onModelChange,this))},FormModelBinder.prototype.syncFormObjectWithModel=function(e,t){for(var r=this.getModelTransformersTree(t.constructor),o=0,n=Object.keys(r.children);o<n.length;o++){var i=n[o];this.pushContext(t.constructor,i,t),M.isUndefined(r.children[i])||this.syncFormWithModelPart(r.children[i],e,t,i),this.popContext()}},FormModelBinder.prototype.syncFormWithModelPart=function(e,t,r,o){e.transformer.type===x.FormControlTransformerSymbol?this.syncFormControlWithModelAttribute(e,t,r,o):e.transformer.type===x.FormObjectTransformerSymbol?this.syncFormObjectWithModelAttribute(e,t,r,o):e.transformer.type===x.FormArrayTransformerSymbol&&this.syncFormArrayWithModelAttribute(e,t,r,o)},FormModelBinder.prototype.syncFormObjectWithModelAttribute=function(e,t,r,o){var n=this.getOrCreateFormComponent(t,r,e,o);if(n){if(!b.isObject(r[o])&&n.component.parent)return void n.component.detach();for(var i=0,a=Object.keys(e.children);i<a.length;i++){var s=a[i];this.pushContext(e.ctor,s,r[o]),this.syncFormWithModelPart(e.children[s],n.component,b.isObject(r)?r[o]:null,s),this.popContext()}}},FormModelBinder.prototype.syncFormArrayWithModelAttribute=function(e,t,r,o){var n=this.getOrCreateFormComponent(t,r,e,o);if(n)for(var i=b.isObject(r)?p.ensureArray(r[o]):[],a=0;a<i.length;++a)this.pushContext(Array,String(a),r[o]),this.syncFormWithModelPart(e.children["*"],n.component,i,a)},FormModelBinder.prototype.syncFormControlWithModelAttribute=function(e,t,r,o){try{this.ignoreFormUpdate=!0;var n=this.getOrCreateFormComponent(t,r,e,o);if(n){var i=b.isObject(r)?r[o]:void 0;M.isUndefined(e.valueTransformer)||(i=this.handleTransformResult(e.valueTransformer.transform(this.buildTransformContext(this.currentContextCtor,i,this.currentContextProperty)))),n.isNew?(n.component.setDefaultValue(i),n.component.reset()):n.component.setValue(i)}}finally{this.ignoreFormUpdate=!1}},FormModelBinder.prototype.getOrCreateFormComponent=function(e,t,r,o){try{return{component:e.get(o),isNew:!1}}catch(a){if(!(a instanceof i.ComponentNotFoundException))throw a;var n=this.handleTransformResult(r.transformer.transform(this.buildTransformContext(this.currentContextCtor,b.isObject(t)?t[o]:null,this.currentContextProperty)));return n?(e.set(o,n),{component:n,isNew:!0}):null}},FormModelBinder.prototype.onModelChange=function(e){var t=this;if(!this.ignoreModelUpdate)if(e.mutation.type!==h.MutationType.Delete){var r=0;try{var o=e.mutation.path.split("/"),n=this.form,i=this.model,a=this.getModelTransformersTree(this.model.constructor),pushContext_1=function(e,o,n){return++r&&t.pushContext(e,o,n)},s=void 0;for(s=1;s<o.length;++s){var m=a.transformer.type===x.FormArrayTransformerSymbol?"*":o[s];if("*"===m&&e.mutation.type===h.MutationType.Insert&&y.isArray(e.mutation.target))pushContext_1(this.currentContextCtor,o[s-1],i);else{if(a=a.children[m],M.isUndefined(a))return;if(s>1&&(n=n.get(o[s-1]),i=i[o[s-1]]),a.transformer.type===x.FormObjectTransformerSymbol&&pushContext_1(a.ctor,o[s],i),a.transformer.type===x.FormControlTransformerSymbol){pushContext_1(this.currentContextCtor,o[s],i);break}}}if(!F.isString(this.currentContextProperty))return;this.mutateForm((function(){var e=t.currentContextProperty;a.transformer.type===x.FormControlTransformerSymbol?t.syncFormControlWithModelAttribute(a,n,i,e):a.transformer.type===x.FormObjectTransformerSymbol?(pushContext_1(i.constructor,e,i),t.syncFormObjectWithModelAttribute(a,n,i,e)):a.transformer.type===x.FormArrayTransformerSymbol&&t.syncFormArrayWithModelAttribute(a,n,i,e)}))}finally{this.popContext(r)}}else try{this.form.get(e.mutation.path).detach()}catch(e){}},FormModelBinder.prototype.onFormValueChange=function(e){if(!this.ignoreFormUpdate)try{if(this.ignoreModelUpdate=!0,!(e.source instanceof a.FormControl))return;for(var t=e.source.path.split("/"),r=this.model,o=1;o<t.length-1;++o){if(!b.isObject(r[t[o]]))return;r=r[t[o]]}if(b.isObject(r)){var n=t[t.length-1],i=this.getModelTransformersTree(r.constructor);M.isUndefined(i.children[n])?r[n]=e.newValue:r[n]=this.handleTransformResult(i.children[n].transformer.transformInverse(new l.TransformContext(null,v.FormTransformerSymbol,r.constructor,e.source,n)))}}finally{this.ignoreModelUpdate=!1}},FormModelBinder.prototype.throwOnUnauthorizedFormMutation=function(){if(!this.canMutateForm)throw new n.UsageException("Form mutations must be done through the model when bound.")},FormModelBinder.prototype.handleTransformResult=function(e){if(null!==e.promise)throw new n.UsageException("Asynchronous transformers are not supported by the FormModelBinder.");if(e.error)throw o.ExceptionFactory.EnsureException(e.errorDetail);return e.result},FormModelBinder.prototype.getModelTransformersTree=function(e,t){void 0===t&&(t=[]);var r=this.transformersTrees.get(e);if(!M.isUndefined(r))return r;for(var o={ctor:e,transformer:C.FormObject(),modelFactory:this.modelMetadata.getFactory(e),children:{}},i=this.transformMetadata.getAll(e,v.FormTransformerSymbol),a=0,s=Object.keys(i);a<s.length;a++){var m=s[a],c=d.ensureCompleteTransformer(T.isFormTransformer(i[m])?i[m]:g.FormControl(i[m]));o.children[m]={transformer:c};for(var l=o.children[m];c.type===x.FormArrayTransformerSymbol;)l.transformer=c,l.children={"*":{}},l=l.children["*"],c=c.getChild(),l.transformer=c;if(c.type===x.FormObjectTransformerSymbol){var u=this.modelMetadata.getRelation(e,m);if(null===u)throw new n.UsageException('You must define a relation for the "'.concat(m,'" attribute\n                        of "').concat(e.name,'" if you set a "FormObject" transformer on it.'));t.indexOf(u)<0&&(t.push(u),Object.assign(l,this.getModelTransformersTree(u,t)),t.pop())}else l.valueTransformer=c.getChild()}return o},FormModelBinder.prototype.pushContext=function(e,t,r){this.contextStack.push({ctor:e,property:t,value:r})},FormModelBinder.prototype.popContext=function(e){void 0===e&&(e=1),e<=this.contextStack.length?this.contextStack.splice(this.contextStack.length-e,e):this.contextStack=[]},FormModelBinder.prototype.buildTransformContext=function(e,t,r,o){for(var n=new l.TransformContext(null,v.FormTransformerSymbol,this.model.constructor,this.model,null),i=0;i<this.contextStack.length-1;++i)n=new l.TransformContext(n,v.FormTransformerSymbol,this.contextStack[i].ctor,this.contextStack[i].value[this.contextStack[i].property],this.contextStack[i].property);return new l.TransformContext(n,v.FormTransformerSymbol,e,t,r,o)},FormModelBinder.prototype.mutateForm=function(e){try{this.canMutateForm=!0,e()}finally{this.canMutateForm=!1}},FormModelBinder=e.__decorate([r.Module(),e.__param(0,t.Inject(s.ModelMetadataService)),e.__param(1,t.Inject(m.ModelTransformMetadataService)),e.__param(2,t.Inject(u.TransformService)),e.__param(3,t.Inject(c.ModelWatcherService)),e.__metadata("design:paramtypes",[s.ModelMetadataService,m.ModelTransformMetadataService,u.TransformService,c.ModelWatcherService])],FormModelBinder)}();exports.FormModelBinder=S;
