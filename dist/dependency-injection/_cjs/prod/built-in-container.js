/*!
 * Banquette DependencyInjection v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./_virtual/_tslib.js"),t=require("@banquette/exception/_cjs/prod/usage.exception"),n=require("@banquette/utils-type/_cjs/prod/is-array"),r=require("@banquette/utils-type/_cjs/prod/is-undefined"),i=require("./metadata.container.js"),s=function(){function BuiltInContainer(){this.singletons=new WeakMap,this.resolutionInstances=[],this.resolutionStack=[]}return BuiltInContainer.prototype.get=function(e){var t=this.resolveInjectable(e);return this.assignResolutionInstancesPropertyDependencies(),t},BuiltInContainer.prototype.getMultiple=function(e){var t=this,s=0;return new Proxy([],{get:function(o,a){if(s===i.MetadataContainer.TagsVersion)return r.isUndefined(a)?o:o[a];s=i.MetadataContainer.TagsVersion,o.splice(0,o.length);for(var u=0,l=i.MetadataContainer.GetForTag(e);u<l.length;u++){var p=l[u],c=t.resolveInjectable(p.identifier);if(n.isArray(c))for(var h=0,d=c;h<d.length;h++){var g=d[h];o.push(g)}else o.push(c);t.assignResolutionInstancesPropertyDependencies()}return r.isUndefined(a)?o:o[a]}})},BuiltInContainer.prototype.has=function(e){return null!==i.MetadataContainer.Get(e)},BuiltInContainer.prototype.resolveInjectable=function(t){var n,r,s=i.MetadataContainer.GetOrFail(t);if(s.singleton&&this.singletons.has(t))return this.singletons.get(t);try{this.pushToStack(t);for(var o=[],a=0,u=s.constructorDependencies;a<u.length;a++){var l=u[a];o.push(this.resolveDependency(l))}r=new((n=s.ctor).bind.apply(n,e.__spreadArray([void 0],o,!1))),this.resolutionInstances.push(r)}finally{this.popFromStack()}return s.singleton&&this.singletons.set(t,r),r},BuiltInContainer.prototype.resolveDependency=function(e){if(null!==e.tags)return this.getMultiple(e.tags);var t=null!==e.eager?e.eager:e.lazy();return this.resolveInjectable(t)},BuiltInContainer.prototype.assignResolutionInstancesPropertyDependencies=function(){var t=e.__spreadArray([],this.resolutionInstances,!0);this.resolutionInstances=[];for(var n=0,r=t;n<r.length;n++)for(var s=r[n],o=i.MetadataContainer.GetOrFail(s.constructor),a=0,u=Object.keys(o.propertiesDependencies);a<u.length;a++){var l=u[a];s[l]=this.resolveDependency(o.propertiesDependencies[l].type)}this.resolutionInstances.length>0&&this.assignResolutionInstancesPropertyDependencies()},BuiltInContainer.prototype.pushToStack=function(e){if(this.resolutionStack.indexOf(e)>=0){var n=this.resolutionStack.concat([e]).reduce((function(e,t){return e.push(t.name),e}),[]).join(" --\x3e ");throw this.resolutionStack=[],new t.UsageException("Circular dependency found: ".concat(n))}this.resolutionStack.push(e)},BuiltInContainer.prototype.popFromStack=function(){this.resolutionStack.pop()},BuiltInContainer}();exports.BuiltInContainer=s;
