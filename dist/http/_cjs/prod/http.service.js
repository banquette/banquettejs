/*!
 * Banquette Http v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./_virtual/_tslib.js"),t=require("@banquette/config/_cjs/prod/config/configuration.service"),r=require("@banquette/dependency-injection/_cjs/prod/decorator/inject.decorator"),s=require("@banquette/dependency-injection/_cjs/prod/decorator/service.decorator"),i=require("@banquette/dependency-injection/_cjs/prod/injector"),n=require("@banquette/event/_cjs/prod/event-dispatcher.service"),u=require("@banquette/exception/_cjs/prod/exception.factory"),o=require("@banquette/exception/_cjs/prod/usage.exception"),a=require("@banquette/promise/_cjs/prod/observable-promise"),c=require("@banquette/utils-misc/_cjs/prod/make-reassignable"),p=require("@banquette/utils-misc/_cjs/prod/noop"),h=require("@banquette/utils-misc/_cjs/prod/proxy"),l=require("@banquette/utils-string/_cjs/prod/is-non-empty-string"),d=require("@banquette/utils-type/_cjs/prod/is-null-or-undefined"),q=require("@banquette/utils-type/_cjs/prod/is-string"),v=require("./constants.js"),f=require("./event/before-response.event.js"),g=require("./event/request.event.js"),y=require("./event/response.event.js"),m=require("./exception/authentication.exception.js"),E=require("./exception/network.exception.js"),H=require("./exception/request-canceled.exception.js"),R=require("./exception/request.exception.js"),x=require("./http-request.builder.js"),S=require("./http-response.js"),b=require("./network-watcher.service.js"),w=require("./utils.js"),j=function(){function HttpService(e,t,r){this.config=e,this.eventDispatcher=t,this.networkWatcher=r,this.requestsQueue=[],this.queueProcessTimeout=null,this.initialized=!1,this.runningRequestsCount=0}var j;return j=HttpService,HttpService.prototype.build=function(){return new x.HttpRequestBuilder},HttpService.prototype.get=function(e,t){return this.send(this.build().method(v.HttpMethod.GET).url(e).params(t||{}).getRequest())},HttpService.prototype.post=function(e,t,r){return this.send(this.build().method(v.HttpMethod.POST).url(e).payload(t).params(r||{}).getRequest())},HttpService.prototype.put=function(e,t,r){return this.send(this.build().method(v.HttpMethod.PUT).url(e).payload(t).params(r||{}).getRequest())},HttpService.prototype.patch=function(e,t,r){return this.send(this.build().method(v.HttpMethod.PATCH).url(e).payload(t).params(r||{}).getRequest())},HttpService.prototype.delete=function(e,t){return this.send(this.build().method(v.HttpMethod.DELETE).url(e).params(t||{}).getRequest())},HttpService.prototype.send=function(e){var t,r,s;this.initialize();var i=c.makeReassignable(new S.HttpResponse(e,v.HttpResponseStatus.Pending,new a.ObservablePromise((function(e,i,n){t=e,r=i,s=n}))));return e.setResponse(i),this.queueRequest(e,i,0,t,r,s),i},HttpService.prototype.executeQueuedRequest=function(t){return e.__awaiter(this,void 0,void 0,(function(){var r,s,n,o;return e.__generator(this,(function(e){switch(e.label){case 0:if(t.response.isCanceled)return[2,void this.removeFromQueue(t)];e.label=1;case 1:return e.trys.push([1,5,6,7]),r=i.Injector.Get(this.adapterIdentifier),t.tryCount||t.request.setAdapter(r),t.triesLeft--,t.isExecuting=!0,this.runningRequestsCount++,[4,this.ensureDispatchSucceeded(this.eventDispatcher.dispatchWithErrorHandling(v.HttpEvents.BeforeRequest,new g.RequestEvent(t.request),!0,t.request.tags))];case 2:return e.sent(),j.EnsureValidRequest(t.request),t.tryCount++,t.request.incrementTryCount(),(s=r.execute(t.request)).progress(t.progress),[4,s];case 3:return n=e.sent(),[4,this.ensureDispatchSucceeded(this.eventDispatcher.dispatchWithErrorHandling(v.HttpEvents.BeforeResponse,new f.BeforeResponseEvent(n,t.request),!0,t.request.tags))];case 4:return e.sent(),this.handleRequestResponse(n,t),[3,7];case 5:return o=e.sent(),this.handleRequestFailure(t,u.ExceptionFactory.EnsureException(o)),[3,7];case 6:return t.isExecuting=!1,this.runningRequestsCount--,[7];case 7:return[2]}}))}))},HttpService.prototype.handleRequestResponse=function(e,t){if(t.response.httpStatusCode=e.status,t.response.url=e.url,t.response.httpHeaders=e.headers,t.response.result=e.response,"2"===e.status.toString()[0])t.response.setStatus(v.HttpResponseStatus.Success),t.resolve(t.response),this.eventDispatcher.dispatchWithErrorHandling(v.HttpEvents.RequestSuccess,new y.ResponseEvent(t.request,t.response),!0,t.request.tags),this.removeFromQueue(t);else{var r=w.httpStatusToText(e.status),s=401===e.status||403===e.status?new m.AuthenticationException(r):new R.RequestException(r);this.handleRequestFailure(t,s)}},HttpService.prototype.handleRequestFailure=function(e,t){if(t instanceof E.NetworkException&&t.retryable&&e.triesLeft>0)return e.executeAt=j.CalculateNextTryTime(e),e.isExecuting=!1,this.eventDispatcher.dispatchWithErrorHandling(v.HttpEvents.RequestQueued,new g.RequestEvent(e.request),!0,e.request.tags),void(this.networkWatcher.isOnline()&&this.processQueue());e.response.error=t,e.response.setStatus(t instanceof H.RequestCanceledException?v.HttpResponseStatus.Canceled:v.HttpResponseStatus.Error),e.reject(e.response),this.eventDispatcher.dispatchWithErrorHandling(v.HttpEvents.RequestFailure,new y.ResponseEvent(e.request,e.response),!0,e.request.tags),this.removeFromQueue(e)},HttpService.prototype.processQueue=function(){for(var e=(new Date).getTime(),t=this.config.get("http.maxSimultaneousRequests"),r=0,s=this.requestsQueue;r<s.length;r++){var i=s[r];!i.isExecuting&&i.executeAt<=e&&this.runningRequestsCount<t&&this.executeQueuedRequest(i).catch(p.noop)}this.scheduleQueueForProcess()},HttpService.prototype.removeFromQueue=function(e){for(var t=0;t<this.requestsQueue.length;++t)if(this.requestsQueue[t]===e)return void this.requestsQueue.splice(t,1)},HttpService.prototype.queueRequest=function(e,t,r,s,i,n){var o=this,a=0,c={request:e,timeout:this.config.get("http.requestTimeout"),tryCount:0,triesLeft:1+Math.max(0,null!==e.retry?e.retry:this.config.get("http.requestRetryCount")),retryDelay:null!==e.retryDelay?e.retryDelay:this.config.get("http.requestRetryDelay"),executeAt:r,resolve:s,reject:i,progress:n,isExecuting:!1,isError:!1,response:t};for(this.networkWatcher.watch();a<this.requestsQueue.length&&this.requestsQueue[a].request.priority>=e.priority;++a);this.requestsQueue.splice(a,0,c),e.setCancelCallback((function(){o.handleRequestFailure(c,new H.RequestCanceledException)})),this.scheduleQueueForProcess();var p=this.eventDispatcher.dispatchWithErrorHandling(v.HttpEvents.RequestQueued,new g.RequestEvent(e),!0,e.tags);p.error&&this.handleRequestFailure(c,u.ExceptionFactory.EnsureException(p.errorDetail))},HttpService.prototype.scheduleQueueForProcess=function(){var e=this;if(null===this.queueProcessTimeout&&this.requestsQueue.length){for(var t=(new Date).getTime(),r=null,s=0,i=this.requestsQueue;s<i.length;s++){var n=i[s];if(!n.isExecuting){var u=n.executeAt>0?Math.max(0,n.executeAt-t):0;(null===r||r>u)&&(r=u)}}null!==r&&(this.queueProcessTimeout=setTimeout((function(){e.queueProcessTimeout=null,e.processQueue()}),r))}},HttpService.prototype.onNetworkAvailabilityChange=function(e){if(e.available){for(var t=0,r=this.requestsQueue;t<r.length;t++){var s=r[t];s.isError&&(s.executeAt=0)}null!==this.queueProcessTimeout&&(clearTimeout(this.queueProcessTimeout),this.queueProcessTimeout=null),this.scheduleQueueForProcess()}},HttpService.prototype.initialize=function(){if(!this.initialized){if(this.adapterIdentifier=this.config.get("http.adapter"),d.isNullOrUndefined(this.adapterIdentifier))throw new o.UsageException('You must define a network adapter in the global configuration to use the Http service (key "http.adapter").');if(!i.Injector.Has(this.adapterIdentifier))throw new o.UsageException('You must register your adapter into the injector using the "@Module()" decorator.');this.eventDispatcher.subscribe(v.NetworkEvents.AvailabilityChange,h.proxy(this.onNetworkAvailabilityChange,this)),this.initialized=!0}},HttpService.prototype.ensureDispatchSucceeded=function(t){return e.__awaiter(this,void 0,void 0,(function(){return e.__generator(this,(function(e){switch(e.label){case 0:return null===t.promise?[3,2]:[4,t.promise];case 1:e.sent(),e.label=2;case 2:if(t.error)throw t.errorDetail;return[2]}}))}))},HttpService.CalculateNextTryTime=function(e){var t=(new Date).getTime();return"auto"!==e.retryDelay?t+e.retryDelay:t+Math.min(3e4,Math.pow(10,e.tryCount))},HttpService.EnsureValidRequest=function(e){if(!l.isNonEmptyString(e.url))throw new o.UsageException("You must define a valid url.");j.EnsureValidPayload(e.payload)},HttpService.EnsureValidPayload=function(e){if(!(null===e||q.isString(e)||e instanceof Blob||e instanceof FormData||e instanceof ArrayBuffer||e instanceof Uint8Array||e instanceof URLSearchParams))throw new o.UsageException("Invalid body. Ensure that you have registered an encoder for this type of payload.")},HttpService=j=e.__decorate([s.Service(),e.__param(0,r.Inject(t.ConfigurationService)),e.__param(1,r.Inject(n.EventDispatcherService)),e.__param(2,r.Inject(b.NetworkWatcherService)),e.__metadata("design:paramtypes",[t.ConfigurationService,Object,b.NetworkWatcherService])],HttpService)}();exports.HttpService=j;
