/*!
 * Banquette Form v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@banquette/event/_cjs/prod/event-dispatcher"),e=require("@banquette/exception/_cjs/prod/usage.exception"),n=require("@banquette/utils-array/_cjs/prod/remove-from-array"),r=require("@banquette/utils-glob/_cjs/prod/match-best"),a=require("@banquette/utils-misc/_cjs/prod/proxy"),o=require("@banquette/utils-object/_cjs/prod/get-object-keys"),i=require("@banquette/utils-random/_cjs/prod/unique-id"),s=require("@banquette/utils-type/_cjs/prod/ensure-array"),c=require("@banquette/utils-type/_cjs/prod/is-function"),u=require("@banquette/utils-type/_cjs/prod/is-undefined"),l=require("@banquette/validation/_cjs/prod/create-validator"),p=require("@banquette/validation/_cjs/prod/validation-result"),h=require("./constant.js"),d=require("./event/errors-changed.form-event.js"),m=require("./event/form-event.js"),b=require("./event/state-changed.form-event.js"),f=require("./event/validation-end.form-event.js"),v=require("./form-error.js"),C=require("./form-validation-context.js"),g=function(){function AbstractFormComponent(){var t,e,n=this;this.id=++AbstractFormComponent.MaxId,this.parent=null,this.validator=null,this.validationStrategy=h.ValidationStrategy.Inherit,this.validationGroups=h.InheritValidationGroup,this.errors=[],this.activeStates=[h.InverseState.Enabled,h.InverseState.UnFocused,h.InverseState.Pristine,h.InverseState.UnTouched,h.InverseState.NotBusy,h.InverseState.UnChanged,h.InverseState.Valid,h.InverseState.Validated,h.InverseState.NotValidating,h.InverseState.Virtual],this.additionalPatternTags=[],this.contextsStack=[],this.validationStatus=h.ValidationStatus.Unknown,this.currentValidationResult=null,this.basicStates=((t={})[h.BasicState.Dirty]=[],t[h.BasicState.Touched]=[],t[h.BasicState.Changed]=[],t[h.BasicState.Busy]=[],t[h.BasicState.Invalid]=[],t[h.BasicState.NotValidated]=[],t[h.BasicState.Validating]=[],t[h.BasicState.Focused]=[],t[h.BasicState.Concrete]=[],t),this.contextualizedStates=((e={})[h.ContextualizedState.Disabled]={},e),this.eventDispatcher=null,this.treeId=null,this.extras={},this.activeControl_=null,this.reset=n.proxifyWithContext(a.proxy(n.doReset,n),h.CallContext.Reset)}return Object.defineProperty(AbstractFormComponent.prototype,"formId",{get:function(){return null!==this.parent?this.root.formId:(null===this.treeId&&(this.treeId=i.uniqueId()),this.treeId)},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"path",{get:function(){if(this.parent){var t=this.parent.path;return t+("/"!==t?"/":"")+this.name}return"/"},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"valid",{get:function(){return!this.invalid},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"invalid",{get:function(){return this.basicStates[h.BasicState.Invalid].length>0},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"notValidated",{get:function(){return this.basicStates[h.BasicState.NotValidated].length>0},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"validated",{get:function(){return!this.notValidated},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"validating",{get:function(){return this.basicStates[h.BasicState.Validating].length>0},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"notValidating",{get:function(){return!this.validating},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"validatedAndValid",{get:function(){return this.validated&&this.validated&&!this.validating},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"busy",{get:function(){return this.basicStates[h.BasicState.Busy].length>0},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"notBusy",{get:function(){return!this.busy},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"disabled",{get:function(){return Object.keys(this.contextualizedStates[h.ContextualizedState.Disabled]).length>0},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"enabled",{get:function(){return!this.disabled},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"dirty",{get:function(){return this.basicStates[h.BasicState.Dirty].length>0},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"pristine",{get:function(){return!this.dirty},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"touched",{get:function(){return this.basicStates[h.BasicState.Touched].length>0},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"untouched",{get:function(){return!this.touched},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"changed",{get:function(){return this.basicStates[h.BasicState.Changed].length>0},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"unchanged",{get:function(){return!this.changed},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"focused",{get:function(){return this.basicStates[h.BasicState.Focused].length>0},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"unfocused",{get:function(){return!this.focused},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"concrete",{get:function(){return this.basicStates[h.BasicState.Concrete].length>0},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"virtual",{get:function(){return!this.concrete},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"name",{get:function(){return null!==this.parent?this.parent.decorated.getNameOf(this):null},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"root",{get:function(){return null!==this.parent?this.parent.root:this},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"size",{get:function(){return 1},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"sizeDeep",{get:function(){return 1},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"errorsDeep",{get:function(){return this.errors},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"errorsDeepMap",{get:function(){var t;return(t={})[this.path]=this.errors,t},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"activeBasicStates",{get:function(){return this.activeStates.filter((function(t){return h.BasicStates.indexOf(t)>-1}))},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormComponent.prototype,"activeControl",{get:function(){return null!==this.parent?this.parent.activeControl:this.activeControl_},set:function(t){null!==this.parent?this.parent.activeControl=t:this.activeControl_=t},enumerable:!1,configurable:!0}),AbstractFormComponent.prototype.setParent=function(t){return null!==this.parent&&this.unsetParent(),this.parent=t,this.buildChildComponentDecorator()},AbstractFormComponent.prototype.isGroup=function(){return null!==this.children},AbstractFormComponent.prototype.setValidator=function(t){var e=this,n=this;if(null!==this.currentValidationResult&&(this.currentValidationResult.cancel(),this.unmarkBasicState(h.BasicState.Validating,this.id)),null!==t){var onFinish_1=function(){e.currentValidationResult&&!e.currentValidationResult.canceled&&(e.unmarkBasicState(h.BasicState.Validating,e.id),e.unmarkBasicState(h.BasicState.NotValidated,e.id)),e.currentValidationResult=null};this.validator=l.createValidator({validate:function(e){if(n.virtual)return e.result;try{n.markBasicState(h.BasicState.Validating,n.id);var r=t.validate(e.value,e);return n.currentValidationResult=r,r.waiting?r.onReady().then(onFinish_1).catch(onFinish_1):onFinish_1(),r}catch(t){throw onFinish_1(),t}}},t.tags,t.groups)}else this.validator=null;null!==this.validator&&this.concrete?this.markBasicState(h.BasicState.NotValidated,this.id):this.unmarkBasicState(h.BasicState.NotValidated,this.id)},AbstractFormComponent.prototype.setValidationStrategy=function(t){this.validationStrategy=t},AbstractFormComponent.prototype.setValidationGroups=function(t){this.validationGroups=null!==t?s.ensureArray(t):null},AbstractFormComponent.prototype.detach=function(){null!==this.parent&&this.parent.remove(this)},AbstractFormComponent.prototype.isRoot=function(){return null===this.parent},AbstractFormComponent.prototype.disable=function(){this.markAsDisabled()},AbstractFormComponent.prototype.enable=function(){this.markAsEnabled()},AbstractFormComponent.prototype.validate=function(){return this.doValidate(this.validator)},AbstractFormComponent.prototype.markAsVirtual=function(){this.unmarkBasicState(h.BasicState.Concrete,this.id),this.unmarkBasicState(h.BasicState.NotValidated,this.id)},AbstractFormComponent.prototype.markAsConcrete=function(){this.markBasicState(h.BasicState.Concrete,this.id),null!==this.validator&&this.markBasicState(h.BasicState.NotValidated,this.id)},AbstractFormComponent.prototype.addError=function(t,e){var n=this,r=new v.FormError(this.path,t,e);this.errors.push(r),this.markBasicState(h.BasicState.Invalid,this.id),this.dispatch(h.FormEvents.ErrorsChanged,(function(){return new d.ErrorsChangedFormEvent(n,n.errors.slice(0))}))},AbstractFormComponent.prototype.clearErrors=function(t){var e=this;void 0===t&&(t=!1),this.errors=[],t||(this.unmarkBasicState(h.BasicState.Invalid,this.id),this.dispatch(h.FormEvents.ErrorsChanged,(function(){return new d.ErrorsChangedFormEvent(e,[])})))},AbstractFormComponent.prototype.clearErrorsDeep=function(t){void 0===t&&(t=!1),this.clearErrors(t)},AbstractFormComponent.prototype.matchPattern=function(t){return r.matchBest(s.ensureArray(t),this.path,this.activeStates.concat(this.additionalPatternTags))},AbstractFormComponent.prototype.getExtras=function(){return this.extras},AbstractFormComponent.prototype.setExtras=function(t){this.extras=t},AbstractFormComponent.prototype.getExtra=function(t,e){return u.isUndefined(this.extras[t])?e:this.extras[t]},AbstractFormComponent.prototype.setExtra=function(t,e){this.extras[t]=e},AbstractFormComponent.prototype.onValueChanged=function(t,e,n){return void 0===n&&(n=!0),this.subscribe(h.FormEvents.ValueChanged,t,e,n)},AbstractFormComponent.prototype.onStateChanged=function(t,e,n){return void 0===n&&(n=!0),this.subscribe(h.FormEvents.StateChanged,t,e,n)},AbstractFormComponent.prototype.onValidationStart=function(t,e,n){return this.subscribe(h.FormEvents.ValidationStart,t,e,n)},AbstractFormComponent.prototype.onValidationEnd=function(t,e,n){return this.subscribe(h.FormEvents.ValidationEnd,t,e,n)},AbstractFormComponent.prototype.onErrorsChanged=function(t,e,n){return void 0===n&&(n=!0),this.subscribe(h.FormEvents.ErrorsChanged,t,e,n)},AbstractFormComponent.prototype.subscribe=function(t,e,n,r){void 0===n&&(n=0),void 0===r&&(r=!0);var a=[],o=this.getEventDispatcher();return a.push(o.subscribe(t,e,n)),r||u.isUndefined(h.EventsInheritanceMap[t])||a.push(o.subscribe(h.EventsInheritanceMap[t],e)),function(){for(var t=0,e=a;t<e.length;t++){(0,e[t])()}}},AbstractFormComponent.prototype.updateValue=function(){null!==this.parent&&this.parent.updateValue()},AbstractFormComponent.prototype.updateValidator=function(){null!==this.parent&&this.parent.updateValidator()},AbstractFormComponent.prototype.doReset=function(){null!==this.activeControl&&this.activeControl.id===this.id&&this.activeControl.blur(),this.concrete&&null!==this.validator&&this.markBasicState(h.BasicState.NotValidated,this.id),this.unmarkBasicState([h.BasicState.Touched,h.BasicState.Dirty],this.id),this.validationStatus=h.ValidationStatus.Unknown,this.clearErrors()},AbstractFormComponent.prototype.validateIfStrategyMatches=function(t){(this.getConcreteValidationStrategy()&t)===t&&this.validate()},AbstractFormComponent.prototype.getConcreteValidationStrategy=function(){return this.validationStrategy===h.ValidationStrategy.Inherit?null!==this.parent?this.parent.getConcreteValidationStrategy():h.DefaultValidationStrategy:this.validationStrategy},AbstractFormComponent.prototype.getConcreteValidationGroups=function(){return this.validationGroups===h.InheritValidationGroup?null!==this.parent?this.parent.getConcreteValidationGroups():[]:s.ensureArray(this.validationGroups)},AbstractFormComponent.prototype.dispatch=function(t,e){if(null!==this.eventDispatcher){c.isFunction(e)&&(e=e());var n=this.getEventDispatcher().dispatch(t,e);if(n.error)throw n.errorDetail}null!==this.parent&&this.parent.dispatch(t,e)},AbstractFormComponent.prototype.doValidate=function(t,e){var n=this;void 0===e&&(e=!0);var r=new m.FormEvent(this);if(this.dispatch(h.FormEvents.ValidationStart,(function(){return r})),null===t||r.defaultPrevented){var a=new p.ValidationResult("/");return this.handleValidationResult(a,e),!0}var o=this.getConcreteValidationGroups(),i=new C.FormValidationContext(this.root,this.path,null,null,this.value,void 0,o);if(!i.shouldValidate(t))return!0;var s=t.validate(this.value,i);return s.waiting?new Promise((function(t,r){s.onReady().then((function(r){n.handleValidationResult(r,e),t(r.valid)})).catch(r)})):(this.handleValidationResult(s,e),s.valid)},AbstractFormComponent.prototype.handleValidationResult=function(t,n){var r=this;if(!t.canceled){if(t.waiting)throw new e.UsageException("The ValidationResult is still waiting.");if(this.clearErrors(!0),t.valid)this.unmarkBasicState(h.BasicState.Invalid,this.id);else{for(var a=0,o=t.violations;a<o.length;a++){var i=o[a];this.addError(i.type,i.message)}t.violations.length>0?this.markBasicState(h.BasicState.Invalid,this.id):this.unmarkBasicState(h.BasicState.Invalid,this.id)}this.unmarkBasicState(h.BasicState.NotValidated,this.id),this.dispatch(h.FormEvents.ValidationEnd,(function(){return new f.ValidationEndFormEvent(r,t)}))}},AbstractFormComponent.prototype.pushContext=function(t){this.contextsStack.push({context:t,component:this.id})},AbstractFormComponent.prototype.popContext=function(){this.contextsStack.pop()},AbstractFormComponent.prototype.hasContext=function(t){for(var e=0,n=this.contextsStack;e<n.length;e++){var r=n[e];if(t===h.CallContext.External){if(r.context===t)return!0}else if((r.context&t)===t)return!0}return!1},AbstractFormComponent.prototype.getCallContextComponentId=function(t){return h.ComponentRelatedCallContexts.indexOf(t)>-1?this.id:0},AbstractFormComponent.prototype.resolveStateCallContext=function(){for(var t=[],n=0,r=[h.CallContext.ViewModel,h.CallContext.Parent,h.CallContext.Child];n<r.length;n++){var a=r[n];this.hasContext(a)&&t.push(a)}if(t.length>1)throw new e.UsageException("Try to update a state while multiple suitable call contexts are available.");return t.length>0?t[0]:h.CallContext.External},AbstractFormComponent.prototype.buildContextualizedApi=function(t,e){for(var n={},r=0,a=o.getObjectKeys(t);r<a.length;r++){var i=a[r];n[i]=this.proxifyWithContext(t[i],e)}return n},AbstractFormComponent.prototype.proxifyWithContext=function(t,e){var n=this;return function(){for(var r=arguments,a=[],o=0;o<arguments.length;o++)a[o]=r[o];try{return n.pushContext(e),t.apply(n,a)}finally{n.popContext()}}},AbstractFormComponent.prototype.markAsDisabled=function(){this.markContextualizedState(h.ContextualizedState.Disabled)},AbstractFormComponent.prototype.markAsEnabled=function(){this.unmarkContextualizedState(h.ContextualizedState.Disabled)},AbstractFormComponent.prototype.dispatchStateChange=function(t,e){var n=this;this.dispatch(h.FormEvents.StateChanged,(function(){return new b.StateChangedFormEvent(n,t,e)}))},AbstractFormComponent.prototype.markBasicState=function(t,e){for(var n=this,r=s.ensureArray(t),_loop_1=function(t){a.basicStates[t].indexOf(e)<0&&(a.basicStates[t].push(e),a.updateActiveState(t,!1),a.dispatch(h.FormEvents.StateChanged,(function(){return new b.StateChangedFormEvent(n,t,!0)}))),null!==a.parent&&a.parent.markBasicState(t,e)},a=this,o=0,i=r;o<i.length;o++){_loop_1(i[o])}},AbstractFormComponent.prototype.unmarkBasicState=function(t,e){for(var n=this,r=s.ensureArray(t),_loop_2=function(t){var r=a.basicStates[t].indexOf(e);r>-1&&(a.basicStates[t].splice(r,1),0===a.basicStates[t].length&&a.updateActiveState(t,!0),a.dispatch(h.FormEvents.StateChanged,(function(){return new b.StateChangedFormEvent(n,t,!1)}))),null!==a.parent&&a.parent.unmarkBasicState(t,e)},a=this,o=0,i=r;o<i.length;o++){_loop_2(i[o])}},AbstractFormComponent.prototype.markContextualizedState=function(t){var e=this.resolveStateCallContext();u.isUndefined(this.contextualizedStates[t][e])&&(this.contextualizedStates[t][e]=[]);var n=this.getCallContextComponentId(e);this.contextualizedStates[t][e].indexOf(n)<0&&(this.contextualizedStates[t][e].push(n),1===Object.keys(this.contextualizedStates[t]).length&&(this.dispatchStateChange(t,!0),this.updateActiveState(t,!1)))},AbstractFormComponent.prototype.unmarkContextualizedState=function(t){var e=this.resolveStateCallContext(),n=this.getCallContextComponentId(e);if(!u.isUndefined(this.contextualizedStates[t][e])){var r=this.contextualizedStates[t][e].indexOf(n);r>=0&&(this.contextualizedStates[t][e].splice(r,1),0===this.contextualizedStates[t][e].length&&(delete this.contextualizedStates[t][e],0===Object.keys(this.contextualizedStates[t]).length&&(this.dispatchStateChange(t,!1),this.updateActiveState(t,!0))))}},AbstractFormComponent.prototype.propagateStatesToParent=function(){null!==this.parent&&(null!==this.activeControl&&this.activeControl.blur(),this.parent.markBasicState(this.activeBasicStates,this.id))},AbstractFormComponent.prototype.removeStatesFromParent=function(){null!==this.parent&&this.parent.unmarkBasicState(this.activeBasicStates,this.id)},AbstractFormComponent.prototype.updateActiveState=function(t,e){var r=e?t:h.StatesInverseMap[t],a=e?h.StatesInverseMap[t]:t;this.activeStates.indexOf(a)<0&&this.activeStates.push(a),n.removeFromArray(this.activeStates,r)},AbstractFormComponent.prototype.getEventDispatcher=function(){return null===this.eventDispatcher&&(this.eventDispatcher=new t.EventDispatcher),this.eventDispatcher},AbstractFormComponent.prototype.unsetParent=function(){null!==this.parent&&null!==this.name&&this.parent.decorated.remove(this.name),this.parent=null},AbstractFormComponent.prototype.buildChildComponentDecorator=function(){var t=this;return Object.assign({get decorated(){return t}},this.buildContextualizedApi({setValue:this.setValue,setDefaultValue:this.setDefaultValue,unsetParent:this.unsetParent,enable:this.enable,disable:this.disable,propagateStatesToParent:this.propagateStatesToParent,removeStatesFromParent:this.removeStatesFromParent,validate:this.validate,handleValidationResult:this.handleValidationResult},h.CallContext.Parent))},AbstractFormComponent.MaxId=0,AbstractFormComponent}();exports.AbstractFormComponent=g;
