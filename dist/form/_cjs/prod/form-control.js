/*!
 * Banquette Form v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./_virtual/_tslib.js"),t=require("@banquette/exception/_cjs/prod/usage.exception"),r=require("@banquette/utils-misc/_cjs/prod/are-equal"),a=require("@banquette/utils-object/_cjs/prod/clone-deep-primitive"),o=require("@banquette/utils-object/_cjs/prod/get-object-keys"),i=require("./abstract-form-component.js"),n=require("./constant.js"),s=require("./event/before-value-change.form-event.js"),l=require("./event/value-changed.form-event.js"),u=function(i){function FormControl(e,t){var o,u=i.call(this)||this;return u.children=null,u.viewModels=[],u.currentViewModels=[],u.setValue=(o=!1,function(e){try{if(o||r.areEqual(u.lastValue,e))return;o=!0;var t=new s.BeforeValueChangeFormEvent(u,u.lastValue,e);if(u.dispatch(n.FormEvents.BeforeValueChange,t),!t.changeAccepted)return void u.viewModels.forEach((function(e){e.setValue(u.lastValue)}));r.areEqual(t.newValue,e)||u.viewModels.forEach((function(e){e.setValue(t.newValue)})),e=t.newValue,u.value=e,u.dispatch(n.FormEvents.ValueChanged,(function(){return new l.ValueChangedFormEvent(u,u.lastValue,u.value)})),u.lastValue=a.cloneDeepPrimitive(u.value),u.viewModels.forEach((function(t){t!==u.focusedViewModel&&t.setValue(e)})),u.markBasicState(n.BasicState.Dirty),r.areEqual(u.defaultValue,e)?u.unmarkBasicState(n.BasicState.Changed):u.markBasicState(n.BasicState.Changed),u.hasContext(n.CallContext.Reset)||u.validateIfStrategyMatches(n.ValidationStrategy.OnChange),null===u.parent||u.hasContext(n.CallContext.Parent)||u.updateValue()}finally{o=!1}}),u.proxifyWithContext((function(){u.disable()}),n.CallContext.ViewModel)(),u.additionalPatternTags.push("control"),u.value=e,u.lastValue=a.cloneDeepPrimitive(e),u.defaultValue=a.cloneDeepPrimitive(e),u.setValidator(t||null),u}return e.__extends(FormControl,i),FormControl.prototype.setDefaultValue=function(e){this.defaultValue=a.cloneDeepPrimitive(e)},FormControl.prototype.setViewModel=function(e){if(this.viewModels.indexOf(e)>-1)throw new t.UsageException("The view model is already associated with this control.");this.viewModels.push(e);try{this.pushContext(n.CallContext.ViewModel),this.enable(),this.markAsConcrete(),null!==this.parent&&this.parent.updateValue()}finally{this.popContext()}return e.setValue(this.value),this.buildControlViewDecorator(e)},FormControl.prototype.unsetViewModel=function(e){var t=this.viewModels.indexOf(e);t>-1&&this.viewModels.splice(t,1),this.viewModels.length||this.markAsVirtual()},FormControl.prototype.focus=function(){this.viewModels.length>0&&this.viewModels[0].focus()},FormControl.prototype.blur=function(){this.viewModels.forEach((function(e){e.blur()}))},FormControl.prototype.doReset=function(){null!==this.parent&&this.parent.pushContext(n.CallContext.Reset,!0),this.setValue(this.defaultValue),i.prototype.doReset.call(this),null!==this.parent&&this.parent.popContext(!0)},FormControl.prototype.setValidator=function(e){i.prototype.setValidator.call(this,e),this.updateValidator()},FormControl.prototype.onBeforeValueChange=function(e,t){return this.subscribe(n.FormEvents.BeforeValueChange,e,t,!0)},FormControl.prototype.markAsFocused=function(){this.activeControl!==this&&(null!==this.activeControl&&this.activeControl.id!==this.id&&this.activeControl.blur(),this.activeControl=this,this.markBasicState(n.BasicState.Focused),this.validateIfStrategyMatches(n.ValidationStrategy.OnFocus),this.currentViewModels.length&&(this.focusedViewModel=this.currentViewModels[this.currentViewModels.length-1]))},FormControl.prototype.markAsBlurred=function(){this.activeControl===this&&(this.activeControl=null,this.markBasicState(n.BasicState.Touched),this.validateIfStrategyMatches(n.ValidationStrategy.OnBlur)),this.unmarkBasicState(n.BasicState.Focused),this.currentViewModels.length&&this.currentViewModels[this.currentViewModels.length-1]!==this.focusedViewModel||(this.focusedViewModel=null)},FormControl.prototype.markAsBusy=function(){this.markBasicState(n.BasicState.Busy)},FormControl.prototype.markAsNotBusy=function(){this.unmarkBasicState(n.BasicState.Busy)},FormControl.prototype.markBasicState=function(e){i.prototype.markBasicState.call(this,e,this.id)},FormControl.prototype.unmarkBasicState=function(e){i.prototype.unmarkBasicState.call(this,e,this.id)},FormControl.prototype.buildControlViewDecorator=function(e){var t=this;return Object.assign({get id(){return t.id},get formId(){return t.formId},get path(){return t.path},get valid(){return t.valid},get invalid(){return t.invalid},get validated(){return t.validated},get notValidated(){return t.notValidated},get validating(){return t.validating},get notValidating(){return t.notValidating},get validatedAndValid(){return t.validatedAndValid},get busy(){return t.busy},get notBusy(){return t.notBusy},get disabled(){return t.disabled},get enabled(){return t.enabled},get dirty(){return t.dirty},get pristine(){return t.pristine},get touched(){return t.touched},get untouched(){return t.untouched},get changed(){return t.changed},get unchanged(){return t.unchanged},get focused(){return t.focused},get unfocused(){return t.unfocused},get errors(){return t.errors},get defaultValue(){return t.defaultValue},get value(){return t.value},get focusedViewModel(){return t.focusedViewModel||null}},this.buildContextualizedViewModelApi({setValue:this.setValue,markAsDisabled:this.markAsDisabled,markAsEnabled:this.markAsEnabled,markAsFocused:this.markAsFocused,markAsBlurred:this.markAsBlurred,markAsBusy:this.markAsBusy,markAsNotBusy:this.markAsNotBusy,unsetViewModel:this.unsetViewModel,setDefaultValue:this.setDefaultValue,reset:this.reset,setExtras:this.setExtras,getExtras:this.getExtras,setExtra:this.setExtra,getExtra:this.getExtra,setValidator:this.setValidator,onStateChanged:this.onStateChanged,onValueChanged:this.onValueChanged,onBeforeValueChange:this.onBeforeValueChange,onErrorsChanged:this.onErrorsChanged},e))},FormControl.prototype.buildContextualizedViewModelApi=function(e,t){for(var r=this,a={},i=0,s=o.getObjectKeys(e);i<s.length;i++){var l=s[i];a[l]=function(e,a){return function(){for(var e=arguments,o=[],i=0;i<arguments.length;i++)o[i]=e[i];try{return r.currentViewModels.push(t),a.apply(r,o)}finally{r.currentViewModels.pop()}}}(0,this.proxifyWithContext(e[l],n.CallContext.ViewModel))}return a},FormControl}(i.AbstractFormComponent);exports.FormControl=u;
