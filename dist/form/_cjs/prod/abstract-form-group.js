/*!
 * Banquette Form v0.0.0 (CommonJS)
 * (c) 2022-2022 Julien Pinto
 * Released under Apache License, Version 2.0
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("./_virtual/_tslib.js"),e=require("@banquette/exception/_cjs/prod/usage.exception"),r=require("@banquette/utils-glob/_cjs/prod/constant"),o=require("@banquette/utils-misc/_cjs/prod/noop"),a=require("@banquette/utils-string/_cjs/prod/format/ltrim"),i=require("@banquette/utils-string/_cjs/prod/format/trim"),n=require("@banquette/utils-type/_cjs/prod/ensure-array"),s=require("@banquette/utils-type/_cjs/prod/is-undefined"),c=require("@banquette/validation/_cjs/prod/type/compose"),u=require("@banquette/validation/_cjs/prod/type/container"),p=require("./abstract-form-component.js"),l=require("./constant.js"),d=require("./event/validation-end.form-event.js"),h=require("./exception/component-not-found.exception.js"),f=require("./form-components-collection.js"),m=function(p){function AbstractFormGroup(){var t,e,r,o,a,i,n=p.call(this)||this;return n.foreachFilters=((t={})[l.FilterGroup.External]=((e={})[l.BasicState.Concrete]=!0,e),t[l.FilterGroup.UpdateValue]=((r={})[l.BasicState.Concrete]=!0,r),t[l.FilterGroup.Validate]=((o={})[l.BasicState.Concrete]=!0,o[l.ContextualizedState.Disabled]=!1,o),t[l.FilterGroup.Size]=((a={})[l.BasicState.Concrete]=!0,a),t[l.FilterGroup.Errors]=((i={})[l.BasicState.Concrete]=!0,i[l.BasicState.Invalid]=!0,i),t),n.selfValidator=null,n.containerValidator=u.Container({}),n.additionalPatternTags.push("group"),n.onStateChanged((function(t){t.state===l.BasicState.Concrete&&t.newValue&&n.updateValue()})),n}return t.__extends(AbstractFormGroup,p),Object.defineProperty(AbstractFormGroup.prototype,"length",{get:function(){return this.count()},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormGroup.prototype,"size",{get:function(){return this.length+1},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormGroup.prototype,"sizeDeep",{get:function(){var t=1;return this.forEach((function(e){t+=e.sizeDeep}),this.foreachFilters[l.FilterGroup.Size]),t},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormGroup.prototype,"errorsDeep",{get:function(){var t=this.errors;return this.forEach((function(e){t=t.concat(e.errorsDeep)}),this.foreachFilters[l.FilterGroup.Errors]),t},enumerable:!1,configurable:!0}),Object.defineProperty(AbstractFormGroup.prototype,"errorsDeepMap",{get:function(){var t,e=((t={})[this.path]=this.errors,t);return this.forEach((function(t){Object.assign(e,t.errorsDeepMap)}),this.foreachFilters[l.FilterGroup.Errors]),e},enumerable:!1,configurable:!0}),AbstractFormGroup.prototype.addChildError=function(t,e){for(var r=this.get(t),o=0,a=n.ensureArray(e);o<a.length;o++){var i=a[o];r.addError(i.type,i.message)}},AbstractFormGroup.prototype.addChildrenErrors=function(t){for(var e=0,r=Object.keys(t);e<r.length;e++){var o=r[e];this.addChildError(o,t[o])}},AbstractFormGroup.prototype.clearErrorsDeep=function(t){void 0===t&&(t=!1),p.prototype.clearErrorsDeep.call(this,t),this.forEach((function(e){e.clearErrorsDeep(t)}),this.foreachFilters[l.FilterGroup.Errors])},AbstractFormGroup.prototype.getByPattern=function(t){var e=this,o=new f.FormComponentsCollection,a=n.ensureArray(t).map((function(t){return(t=i.trim(t)).length>0&&"/"!==t[0]&&":"!==t[0]&&(t=e.path+("/"!==e.path?"/":"")+t),t}));return this.forEachDecorated((function(t){var e=t.decorated.matchPattern(a);e.pattern===r.MatchType.Full&&e.tags===r.MatchType.Full&&o.append(t.decorated),e.pattern>=r.MatchType.Partial&&t.decorated.isGroup()&&o.concat(t.decorated.getByPattern(a))})),o},AbstractFormGroup.prototype.getByPath=function(t){if(""===(t=a.ltrim(t,"/")))return this;var e=t.indexOf("/");if(e<0)return this.get(t);var r=t.substring(0,e),o=t.substring(e+1),i=this.get(r);if(i.isGroup())return i.getByPath(o);throw new h.ComponentNotFoundException(t,'No component has been found for path "'.concat(t,'" in "').concat(this.path,'".'))},AbstractFormGroup.prototype.setGroupFilters=function(t,e){this.foreachFilters[t]=e,t===l.FilterGroup.UpdateValue&&this.updateValue()},AbstractFormGroup.prototype.doReset=function(){p.prototype.doReset.call(this),this.forEachDecorated((function(t){t.decorated.reset()}))},AbstractFormGroup.prototype.setValidator=function(t){this.selfValidator=t,this.updateValidator()},AbstractFormGroup.prototype.onControlAdded=function(t,e,r){return void 0===r&&(r=!0),this.subscribe(l.FormEvents.ComponentAdded,t,e,r)},AbstractFormGroup.prototype.onControlRemoved=function(t,e,r){return void 0===r&&(r=!0),this.subscribe(l.FormEvents.ComponentRemoved,t,e,r)},AbstractFormGroup.prototype.validateSelf=function(){this.selfValidator&&this.doValidate(this.selfValidator,!1)},AbstractFormGroup.prototype.validateSelfIfStrategyMatches=function(t){(this.getConcreteValidationStrategy()&t)===t&&this.validateSelf()},AbstractFormGroup.prototype.updateValidator=function(){var t=this,e=0;this.containerValidator=u.Container({}),this.forEachDecorated((function(r,o){null!==r.decorated.validator&&(t.containerValidator.set(String(o),r.decorated.validator),++e)})),e||null!==this.selfValidator?p.prototype.setValidator.call(this,null!==this.selfValidator?c.Compose(this.selfValidator,this.containerValidator):this.containerValidator):p.prototype.setValidator.call(this,null),null!==this.validator&&(this.validator.set=o.noop,this.validator.remove=o.noop,this.validator.has=function(){return!1}),p.prototype.updateValidator.call(this)},AbstractFormGroup.prototype.updateContainerValidator=function(t){t(this.containerValidator),this.containerValidator.length&&!this.validator?this.updateValidator():this.containerValidator.length||!this.validator||this.selfValidator||p.prototype.setValidator.call(this,null)},AbstractFormGroup.prototype.handleValidationResult=function(t,r){var o=this;if(!t.canceled){if(t.waiting)throw new e.UsageException("The ValidationResult is still waiting.");if(r?this.clearErrorsDeep(!0):this.clearErrors(!0),t.valid)this.unmarkBasicState(l.BasicState.Invalid,this.id);else{for(var a=t.getViolationsMap(),i=0,n=Object.keys(a);i<n.length;i++)for(var s=n[i],c=a[s],u=this.getByPath(s),p=0,h=c;p<h.length;p++){var f=h[p];u.addError(f.type,f.message)}this.errors.length?this.markBasicState(l.BasicState.Invalid,this.id):this.unmarkBasicState(l.BasicState.Invalid,this.id)}this.unmarkBasicState(l.BasicState.NotValidated,this.id),this.dispatch(l.FormEvents.ValidationEnd,(function(){return new d.ValidationEndFormEvent(o,t)}))}},AbstractFormGroup.prototype.markAsDisabled=function(){p.prototype.markAsDisabled.call(this),this.forEachDecorated((function(t){t.disable()}))},AbstractFormGroup.prototype.markAsEnabled=function(){p.prototype.markAsEnabled.call(this),this.forEachDecorated((function(t){t.enable()}))},AbstractFormGroup.prototype.getIndexOf=function(t){var e=null;return this.forEachDecorated((function(r,o){if(t.id===r.decorated.id)return e=o,!1})),e},AbstractFormGroup.prototype.removeByRef=function(t){var e=this.getIndexOf(t);null!==e&&this.remove(e)},AbstractFormGroup.prototype.propagateStatesToParent=function(){this.forEachDecorated((function(t){t.propagateStatesToParent()}))},AbstractFormGroup.prototype.removeStatesFromParent=function(){this.forEachDecorated((function(t){t.removeStatesFromParent()}))},AbstractFormGroup.prototype.buildParentComponentDecorator=function(){var t=this,e=this;return Object.assign({get decorated(){return e},get path(){return e.path},get root(){return e.root},get activeControl(){return e.activeControl},set activeControl(t){e.activeControl=t},pushContext:function(e,r){t.pushContext(e),r&&null!==t.parent&&t.parent.pushContext(e,!0)},popContext:function(e){t.popContext(),e&&null!==t.parent&&t.parent.popContext(!0)}},this.buildContextualizedApi({updateValue:this.updateValue,updateValidator:this.updateValidator,getConcreteValidationStrategy:this.getConcreteValidationStrategy,getConcreteValidationGroups:this.getConcreteValidationGroups,markBasicState:this.markBasicState,unmarkBasicState:this.unmarkBasicState,markAsVirtual:this.markAsVirtual,markAsConcrete:this.markAsConcrete,remove:this.removeByRef,dispatch:function(e,r){if(!s.isUndefined(l.EventsInheritanceMap[e]))return t.dispatch(l.EventsInheritanceMap[e],r)}},l.CallContext.Child))},AbstractFormGroup}(p.AbstractFormComponent);exports.AbstractFormGroup=m;
